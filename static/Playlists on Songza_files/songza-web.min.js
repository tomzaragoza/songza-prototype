define("bklyn/songza/site-views",["songza/config","songza/base","songza/hashsignal","songza/utils"],function(f,e,b,a){var c={};c.Default=e.View.extend({el:"#body-delegate",elements:{"#player":"$player",".content-wrapper":"$contentWrapper"},events:{"click  a":"onAnchorClick","submit form":"onFormSubmit"},states:{ads_show:{set:!0,onCss:"show-ads"},ads_top_250:{set:!1,onCss:"ads-top-250"},fullplayer_show:{set:!1,onCss:"show-fullplayer"},miniplayer_show:{set:!1,onCss:"show-miniplayer"},search_results_show:{set:!1,
onCss:"show-search-results"},page_show_nav:{set:!1,onCss:"show-nav"},page_show_subnav:{set:!1,onCss:"show-subnav"},page_keep_subnav_open:{set:!1,onCss:"keep-subnav-open"},page_show_auth:{set:!1,onCss:"show-auth"}},initialize:function(a){c.Default.__super__.initialize.call(this,a);_.bindAll(this,"startSpinner","stopSpinner");this.app=a.app;this.stationNavigationContext=this.errorFrame=this.spinner=this.spinnerTimeout=null;this.app.bind("page-navigate-start",this.startSpinner);this.app.bind("page-navigate",
this.stopSpinner);this.app.bind("page-navigate-failure",this.stopSpinner);var b=this;this.app.bind("environment-change",function(){b.setState("ads_show",b.app.featureEnabled("advertising.display"))});$(this.el).tooltip&&$(this.el).tooltip({selector:".sz-tooltip"});this.sync()},setNextPageStates:function(a){var b=this;_.each(this.states,function(c,h){h.match(/^page_/)&&(a&&a[h]?b.setState(h,a[h]):b.setState(h,b.getDefaultState(h)))})},startSpinner:function(){var a=this;this.stopSpinner();this.spinnerTimeout=
setTimeout(function(){var b=(new Spinner({lines:12,length:7,width:2,radius:3,color:"#888",speed:1,trail:50,shadow:!1})).spin();$(b.el).css("position","fixed");$(b.el).css("bottom","30px");$(b.el).css("right","30px");$("body").append(b.el);a.spinnerTimeout=null;a.spinner=b},f.timeouts.pageNavigateProgress)},stopSpinner:function(){this.spinnerTimeout&&clearTimeout(this.spinnerTimeout);if(this.spinner)this.spinner.stop(),$(this.spinner.el).detach(),this.spinner=null},showErrorDocument:function(a){var b=
$('<iframe src="javascript:0">').addClass("sz-error-page"),a=$($.trim(a));this.errorFrame&&this.errorFrame.detach();b.css("min-height",$(this.el).outerHeight());$(this.el).append(b);b.contents().find("html").empty().append(a);this.errorFrame=b},updateContent:function(a){var c=this;this.errorFrame&&this.errorFrame.detach();var j=!1;if(this._updateContentWrapper_set)j=!0,this._updateContentWrapper_set=!1;b.replaceBlocks(a,j,function(a){_.each(a,function(a){c.app.trigger("dom-node-inserted",{node:a})})});
$(document).scrollTop()>150&&$("html,body").scrollTop(0);this.$el.scrollTop()>150&&this.$el.scrollTop(0)},isWithinContentWrapper:function(a){return this.$contentWrapper().find($(a)).length>0},updateContentWrapper:function(a){if(!this.isWithinContentWrapper(a))this.$contentWrapper().empty().append(a),this._updateContentWrapper_set=!0},setStationNavigationContext:function(a,b){this.stationNavigationContext={stationId:a,contextName:b}},getStationNavigationContext:function(a){if(this.stationNavigationContext&&
this.stationNavigationContext.stationId===a)return this.stationNavigationContext.contextName;return"Unknown"},onAnchorClick:function(b){var c=$(b.currentTarget),j=c.attr("href"),h=null,i=null,h=null;if($(this.el).attr("data-sz-no-route")!==void 0)return!0;if(!j||c.attr("data-sz-no-route")!==void 0)return!0;c.attr("data-sz-station-id")!==void 0&&(i=parseInt(c.attr("data-sz-station-id"),10),h=c.parents(".sz-station-context").attr("data-sz-station-context-name"),this.setStationNavigationContext(i,h||
"Unknown"));if(j.match(/^\s*http[s]?/i))if(h=parseUri(j),h.protocol!=window.location.protocal&&h.host!=window.location.host)return!0;else i=h.path,h.query&&(i+="?"+h.query);else if(j.match(/^\s*javascript:/i))return!0;else if(j.match(/^\s*mailto:/i))return!0;else if(j==="#")return!1;else i=j;b.preventDefault();i[0]==="/"&&(i=i.substring(1));h=c.attr("data-sz-add-next");h!==void 0&&(i+="?"+a.formQuery({next:h?h:"/"+Backbone.history.getFragment()}));Backbone.history.navigate(i,!0);return!1},onFormSubmit:function(a){var a=
$(a.currentTarget),b=(a.attr("method")||"GET").toUpperCase(),c=a.attr("action");if(a.attr("data-sz-no-route")!==void 0)return!0;if(a.attr("enctype")!==void 0)return!0;if(!c||c.match(/^\s*http[s]?/))return!0;c.match(/\//)&&(c=c.substr(1));if(b==="GET")return Backbone.history.navigate(c+"?"+a.serialize(),!1),this.app.router.getAndInjectContent(c+"?"+a.serialize()),!1;else if(b==="POST")return Backbone.history.navigate(c,!1),this.app.router.postAndInjectContent(c,a.serialize()),!1}});return c});define("bklyn/songza/dom-enhancements/playlist-landing-self-hiding",function(){var f,e=function(a){var b=f.getInstance(),d=Backbone.history.getFragment();a.find(".playlist-landing-skip");a.find(".playlist-landing-fulllplayer-open").click(function(){b.trigger("request-player-enter-fullscreen");return!1});var g=_.once(function(){b.unbind("router-navigate-start page-navigate-start",g);clearTimeout(g);Backbone.history.getFragment()==d&&Backbone.history.navigate("",!0)});b.bind("router-navigate-start page-navigate-start",
g);setTimeout(g,0)},b=function(a){a=$(a).find(".playlist-landing-self-hiding");a.length>0&&e(a)};return{register:function(a){f=a;a.addDOMEnhancement(b)}}});define("bklyn/songza/dom-enhancements/favoritable",["bklyn/songza/systems/favorites-manager"],function(f){function e(a,b){var c=$(a).parents(".has-favoritable-status");b?($(a).addClass("is-favorite"),c.length>0&&c.addClass("is-favorite")):($(a).removeClass("is-favorite"),c.length>0&&c.removeClass("is-favorite"))}function b(b,c){var d=$(a.getInstance().view.el).find(".favoritable[data-sz-station-id='"+b+"']");c===void 0&&(c=f.getFavoritesManager().containsStationId(b));d.each(function(){e(this,c)})}
var a,c=function(){$(a.getInstance().view.el).find(".favoritable[data-sz-station-id]").each(function(){var a=$(this).data("sz-station-id");a?e(this,f.getFavoritesManager().containsStationId(a)):console.log("no sz-station-id to favorite")})},d=function(a){$(".favoritable",a).each(function(){var c=$(this),d=c.data("sz-station-id");d?(f.getFavoritesManager().fetchOnce().then(function(){e(c,f.getFavoritesManager().containsStationId(d))}),c.click(function(a){a.stopPropagation();f.getFavoritesManager().containsStationId(d)?
(f.getFavoritesManager().removeStationId(d),b(d,!1)):(f.getFavoritesManager().addStationId(d),b(d,!0))})):console.log("no sz-station-id to favorite "+a)})};return{register:function(b){a=b;c();b.addDOMEnhancement(d)}}});define("bklyn/songza/dom-enhancements/buy-links",["bklyn/songza/systems/itunes-api"],function(f){var e=function(b){$(".buy-link",b).each(function(){var a=$(this),b=null;a.click(function(d){a.data("sz-search-terms")&&(b?window.open(b):f.searchForTrackAndReturnTrackViewUrl(a.data("sz-search-terms"),{success:function(a){b=a;window.open(a)},failure:function(){alert("Sorry! We weren't able to find a purchase link for this track.");a.fadeOut()}}),d.stopPropagation())})})};return{register:function(b){b.addDOMEnhancement(e)}}});define("bklyn/songza/dom-enhancements/sharing",["songza/utils","songza/sharing","songza/systems/facebook","songza/systems/facebook"],function(f,e){var b,a,c={twitter:function(c){var g=["toolbar=no","status=no","scrollbars=yes","resizable=yes","width=850","height=500","left="+(window.screen.width-850)/2,"top="+(window.screen.height-500)/2],d=e.SharePageItem.forElementWithDataAttributes(c.currentTarget)||a,c="https://twitter.com/intent/tweet?",d={via:b.getInstance().getConfig().twitter.handle||"",url:d.get("url"),
text:d.get("share_text")||d.get("title")};c+=f.formQuery(d);window.open(c,"twitter_share",g.join(","))},facebook:function(b){var c=(window.screen.width-850)/2,g=(window.screen.height-500)/2,b=e.SharePageItem.forElementWithDataAttributes(b.currentTarget)||a,b="http://www.facebook.com/sharer.php?"+f.formQuery({u:b.get("url"),t:b.get("title")});window.open(b,"facebook_sharer",["toolbar=no,status=no,scrollbars=yes,resizable=yes,width=850,height=500","left="+c,"top="+g].join(","))}},d=function(){var c,
g=b.getInstance().getPlayer();c=e.SharePageItem.forCurrentPage();a=g&&g.shareItem()||c},g=function(a){$(".share-link",a).each(function(){var a=$(this);c[a.data("sz-share-system")]&&a.click(function(b){b.stopPropagation();c[a.data("sz-share-system")](b)})})};return{register:function(a){b=a;d();b.getInstance().bind("player-song-started",d);a.addDOMEnhancement(g)}}});define("bklyn/songza/dom-enhancements/playable-stations",["songza/models"],function(f){function e(){return $(a.getInstance().view.el).find(".playable[data-sz-station-id]")}function b(b){var c=a.getInstance(),d=c.currentlyPlayingStation(),b=b?$(b):e();b.removeClass("playing").removeClass("paused");d&&(b=b.filter("*[data-sz-station-id='"+d.get("id")+"']"),b.addClass("playing"),c.player.isPaused()&&b.addClass("paused"))}var a,c=function(){a.getInstance().bind("player-station-pause player-station-play",
function(){b()})},d=function(c){var d=a.getInstance(),c=$(c).find(".playable[data-sz-station-id]");b(c);c.click(function(a){var b=$(a.currentTarget).data("sz-station-id"),c=$(a.currentTarget).data("sz-artist-id"),g=d.currentlyPlayingStation();e().filter("*[data-sz-station-id='"+b+"']");if(g&&g.get("id")===b)d.togglePlayingStation();else{var n={showFlashyHighlights:!0};c&&(n.artist=new f.Artist({id:c}));(c=f.StationCache.get(b))?(b=new f.Station(c,{parse:!0}),d.startStation(b,n)):f.Station.get(b,{success:function(a){d.startStation(a,
n)}})}if(!$(a.currentTarget).data("sz-playable-continue-callback"))return!1});c.find("a.playable-sublink").click(function(a){a.stopPropagation();Backbone.history.navigate($(a.currentTarget).attr("href"),!0);return!1})};return{register:function(b){a=b;c();b.addDOMEnhancement(d)}}});define("bklyn/songza/dom-enhancements/back-links",[],function(){var f=function(e){$("a.go-back",e).each(function(){$(this).click(function(){window.history.back();return!1})})};return{register:function(e){e.addDOMEnhancement(f)}}});define("bklyn/songza/sites/songza/ads",["songza/app","songza/config","songza/utils","songza/ads/manager","songza/ads/iframe"],function(f,e,b,a,c){function d(){var a=b.currentPath().split("?")[0],c,g;for(g=0;g<r.length;g++)if(c=a.match(r[g][0]))return r[g][1];return"default"}function g(){var a=b.currentPath().split("?")[0],c,g;for(g=0;g<r.length;g++)if((c=a.match(r[g][0]))&&c.length>1)return c[1];return""}function j(){var a=f.getInstance().view,b="";$(a.el).find(".browse-header .browse-playlist").each(function(a,
c){b=$(c).attr("data-sz-station-id")});return b}function h(){var a=p.getInstance().getEnvironment();return a.session_config&&a.session_config.dfp&&a.session_config.dfp.keywords?a.session_config.dfp.keywords:[]}function i(a,b){var c=_.keys(a.targeting),g,d,i;for(g=0;g<c.length;g++)if(d=c[g],i=a.targeting[d],!(i===""||i===void 0||i===null))if(d=b[d],i!==d)return!1;return!0}function l(){var a=p.getInstance(),b=a.getEnvironment(),c=window.SZ_AD_UTIL.getTargeting(),g={};_.each(c,function(a){g[a.key]=a.value});
b=_.sortBy(b.site_takeovers,function(a){return a.priority});b=_.filter(b,function(a){var b=!1;_.each([],function(a){g.subject===a&&(b=!0)});if(b)return!1;return i(a,g)});if(b.length>0&&a.featureEnabled("advertising.display")){a=(new Date).getTime();o=b[0];o.cache_busted_impression_url=null;if(o.impression_url)o.cache_busted_impression_url=o.impression_url.replace("%%CACHEBUSTER%%",a);o.cache_busted_click_url=o.click_url.replace("%%CACHEBUSTER%%",a);$("body").addClass("sz-takeover");$(".ad-skin").css("background-color",
o.background_color);$(".ad-skin").css("background-image","url('"+o.background_url+"')");o.hide_top_ad?$("body").addClass("sz-hide-top-ad"):$("body").removeClass("sz-hide-top-ad");o.cache_busted_impression_url&&(a=$("<img>").attr("id","site-takeover-tracker").attr("src",o.cache_busted_impression_url).attr("width","1").attr("height","1"),$("#site-takeover-tracker").remove(),$("body").append(a))}else o=null,$("body").removeClass("sz-takeover"),$(".ad-skin").css("background-color",""),$(".ad-skin").css("background-image",
""),$("body").removeClass("sz-hide-top-ad"),$("#site-takeover-tracker").remove()}function k(a){o&&$(a.target).hasClass("content-wrapper")&&window.open(o.cache_busted_click_url)}function n(a){var b=window.SZ_AD_UTIL;b.clearTransientTargeting();b.addTransientTargeting("day",a.context.get("day"));b.addTransientTargeting("period",a.context.get("period"));_.each(a.parentSituations,function(a,c){b.addTransientTargeting("situation"+c,a.get("id"))})}function m(){require(["http://c.amazon-adsystem.com/aax2/amzn_ads.js"],
function(){try{t()}catch(a){}})}if(_.indexOf(e.site_custom_plugins,"bklyn/songza/sites/songza/ads")!==-1){var p,o,q=[],r=[[/^\/$/,"home"],[/^\/concierge.*$/,"home"],[/^\/login\/$/,"login"],[/^\/discover\/$/,"discover"],[/^\/contribute\/.*$/,"contribute"],[/^\/search\/.*$/,"search"],[/^\/user\/[^/]+\/.*$/,"user"],[/^\/listen\/([^/]+)\/.*$/,"station"],[/^\/discover\/[^/]+\/$/,"tag"],[/^\/discover\/[^/]+\/[^/]+\/$/,"gallery"],[/^\/discover\/[^/]+\/[^/]+\/([^/]+)\/$/,"station"]];window.SZ_AD_UTIL={getTargeting:function(){var a=
[],c=b.currentPath().split("?")[0];a.push({key:"path",value:c});a.push({key:"section",value:d()});a.push({key:"subject",value:g()});a.push({key:"station",value:j()});_.each(h(),function(b){a.push(b)});_.each(q,function(b){a.push(b)});return a},setTargeting:function(a){var b=window.SZ_AD_UTIL.getTargeting();_.each(b,function(b){a.setTargeting(b.key,b.value)})},clearTransientTargeting:function(){q=[]},addTransientTargeting:function(a,b){q.push({key:a,value:b})}};var t=_.debounce(function(){if(window.amznads){if(window.amznads.ads)window.amznads.ads=
{};window.amznads.getAdsAsync("3040")}},1500,!0);return{register:function(b){function g(){f.refresh()}function d(){f.refresh({force:!0})}function i(a){var b=0,c=0,g,d;setInterval(function(){if(!(c>0)){var i=$(a),j=i.find("iframe");if(i.length&&j.length){try{var h=j.contents(),n=h.height(),p=h.width()}catch(e){return}g&&d&&g==n&&d==p?b=0:g&&n<g&&b<1500?b+=50:(g=n,d=p,b=0,c=2,h=function(){c-=1},i.animate({height:g,width:d},{complete:h}),j.animate({height:g,width:d},{complete:h}))}}},50)}function j(){h.featureEnabled("advertising.display")?
(f.enable(),$("html").removeClass("sz-no-ads")):(f.disable(),$("html").addClass("sz-no-ads"))}m();var h=b.getInstance(),o=e.adSlotConfig||[["/advertising/top/",728,90,"#ad-top",{resizeAd:!0}],["/advertising/bottom/",728,90,"#ad-bottom"],["/advertising/side/",300,600,"#ad-side"]];p=b;var b=_.map(o,function(b){var g=b[0],d=b[1],j=b[2],n=b[3],p=b[4]||{},e=[];p.resizeAd&&i(n);p.fullplayerStatus!==void 0&&e.push(function(){return h.view.getState("fullplayer_show")===p.fullplayerStatus});p.inCurrentConciergeView&&
e.push(function(){return $(n).parents(".concierge-view:not(.inactive):not(.pushed-to-back)").length>0});b=null;e.length>0&&(b=function(){var a=e.map(function(a){return a()});return _.every(a)});g=new c.Ad({url:g,width:d,height:j});return new a.Slot({default_ad:g,target_selector:n,cb:b})}),f=new a.Manager({slots:b,max_refresh_seconds:3,max_idle_seconds:180,pre_refresh:function(a,b){b?(t(),setTimeout(a,100)):a()}});h.bind("page-navigate",window.SZ_AD_UTIL.clearTransientTargeting);h.bind("page-navigate",
j);h.bind("concierge-situations-shown",n);h.bind("concierge-stations-shown",n);h.bind("page-navigate",l);h.bind("concierge-situations-shown",l);h.bind("concierge-stations-shown",l);h.bind("page-navigate",g);h.bind("player-station-started",d);h.bind("player-song-started",g);h.bind("player-song-play",g);h.bind("player-song-pause",g);h.bind("player-song-vote-up",g);h.bind("player-song-vote-down",g);h.bind("concierge-situations-shown",d);h.bind("concierge-stations-shown",d);h.bind("ad-refresh-requested",
g);j();l();f.refresh();$("body").on("click",k)}}}});define("bklyn/songza/sites/songza/ad-preroll",["songza/app","songza/base","songza/config","songza/ads/vast","songza/ads/vast-station-modal","songza/ads/iframe","songza/templates/ads"],function(f,e,b,a,c,d){function g(){return h.featureEnabled("advertising.display")}function j(a){if(a.origin==="http://"+document.location.hostname&&_.isString(a.data)){var b=k.get_pending();b&&(a.data.indexOf("vast:")===0?(a=a.data.replace("vast:",""),b.setStrategy({strategy:"vast",tag:a})):a.data==="no_preroll"&&b.setStrategy({strategy:"no_preroll",
tag:null}))}}if(_.indexOf(b.site_custom_plugins,"bklyn/songza/sites/songza/ad-preroll")!==-1&&b.features["songza.ad_preroll"]&&!Modernizr.audio_requires_user_interaction){var h,i={preroll_iframe:null,init:function(){this.preroll_iframe=new d.Ad({url:"/advertising/preroll/",width:1,height:1});this.preroll_iframe.render();$("body").append(this.preroll_iframe.el)},refresh:function(){this.preroll_iframe?(this.preroll_iframe.$el.empty(),this.preroll_iframe.render()):i.init()}},l={isLocalStorageEnabled:_.memoize(function(){if(!Modernizr.localstorage)return!1;
try{var a;window.localStorage.setItem("storage-test","test");a=window.localStorage.getItem("storage-test")=="test";window.localStorage.removeItem("storage-test");return a=a&&!window.localStorage.getItem("storage-test")}catch(b){return!1}}),init:function(){this._just_used_up_free_plays=!1;this.isLocalStorageEnabled()&&this.get()===null&&this.set(5)},any_remaining:function(){if(!this.isLocalStorageEnabled())return!1;return this.get()>0},just_used_up_free_plays:function(){return this._just_used_up_free_plays},
get:function(){if(this.isLocalStorageEnabled()){var a=parseInt(window.localStorage.getItem("free-plays-remaining"));return isNaN(a)?null:a}},set:function(a){this.isLocalStorageEnabled()&&window.localStorage.setItem("free-plays-remaining",parseInt(a))},track:function(){this._just_used_up_free_plays=!1;if(this.isLocalStorageEnabled()&&this.any_remaining()&&(this.set(this.get()-1),!this.any_remaining()))this._just_used_up_free_plays=!0}},k=e.Class.extend({initialize:function(a){a=a||{};this.deferred=
$.Deferred();this.has_custom_interstitial_ad=a.has_custom_interstitial_ad;this.unplayed=!0;g()?l.any_remaining()&&!this.has_custom_interstitial_ad?this.deferred.resolve():i.refresh():this.deferred.resolve()},setStrategy:function(a){var b=this;if(b.deferred.state()=="pending")if(a=a||{},this.strategy=a.strategy,this.tag=a.tag,this.play_cb=null,this.strategy=="no_preroll")b.deferred.resolve();else if(this.strategy=="vast"&&FlashDetect.installed){var g=c.renderPreRollVast_bklyn(this.tag,null,null,{autoplay:!1,
upsell_template:sz.tmpl.ads.clubSongzaUpsell({href_url:"/club/"})});g.vastPlayer.bind("ad-ready",function(){b.deferred.resolve()});this.play_cb=function(a,b){b=b||{};g.play(b.station,a)}}},promise:function(){return this.deferred.promise()},cancel:function(){this.deferred.reject()},play:function(a,b){this.play_cb?this.play_cb(a,b):a&&a();this.unplayed=!1}},{get:function(){return k._instance},get_pending:function(){var a=k.get();if(a.deferred.state()=="pending")return a},get_unplayed:function(){var a=
k.get();if(a.unplayed)return a},reset:function(){if(k._instance)k._instance.cancel(),k._instance=null},request:function(a){k.reset();k._instance=new k(a);return k._instance}}),n=e.Class.extend({initialize:function(a){var b=this,a=a||{};this.station=a.station;this.startStationCallback=a.startStationCallback;this.situations=a.situations;this.deferred=$.Deferred();this.playback_started=!1;this.deferred.then(function(){b.startStationCallback&&b.startStationCallback();b.has_custom_interstitial_ad||(l.just_used_up_free_plays()?
k.request():l.any_remaining()||setTimeout(function(){k.get_unplayed()||k.request()},186E4))});g()?(a=[this.station].concat(this.situations||[]),this.has_custom_interstitial_ad=_.some(a,function(a){return a.get("advertising")&&a.get("advertising").get("interstitial_ad")}),l.any_remaining()&&!this.has_custom_interstitial_ad?b.deferred.resolve():(setTimeout(function(){b.playback_started||b.complete()},this.has_custom_interstitial_ad?1E4:2E3),this.has_custom_interstitial_ad&&k.request({has_custom_interstitial_ad:!0}),
this.preroll_configuration_request=k.get_unplayed()||k.request(),this.preroll_configuration_request.promise().then(function(){if(b.deferred.state()=="pending")b.playback_started=!0,b.preroll_configuration_request.play(function(){b.deferred.resolve()},{station:b.station})}))):b.deferred.resolve()},promise:function(){return this.deferred.promise()},complete:function(){this.deferred.resolve()},cancel:function(){this.deferred.reject()}},{get:function(){return n._instance},in_progress:function(){var a=
n.get();return a&&a.deferred.state()!=="resolved"},request:function(a){n._instance&&n._instance.cancel();n._instance=new n(a);return n._instance}}),m={spinner:null,station_page_el:null,setStationEl:function(a){this.station_page_el=a;n.in_progress()&&m.start()},start:function(){if(this.station_page_el)this.spinner=(new Spinner({lines:12,length:20,width:10,radius:30,color:"#888",speed:1,trail:50,shadow:!1})).spin(),$(this.spinner.el).css("position","absolute").css("top","125px").css("left","50%"),$(this.station_page_el).append(this.spinner.el),
$(this.station_page_el).find(".szi-header").animate({opacity:0.25})},stop:function(){if(this.station_page_el)this.spinner.stop(),$(this.spinner.el).detach(),this.spinner=null,$(this.station_page_el).find(".szi-header").animate({opacity:1}),this.station_page_el=null}},p=function(a,b,c){c=_.defaults(c||{},{situations:null});m.start();n.request({station:a,startStationCallback:function(){m.stop();b();l.track()},situations:c.situations})};return{PrerollTransition:m,register:function(a){h=a.getInstance();
g()&&(l.init(),a.setStationPrePlayHook(p),window.addEventListener?window.addEventListener("message",j,!1):window.attachEvent&&window.attachEvent("onmessage",j),k.request())}}}});define("bklyn/songza/routers",["songza/config","songza/utils"],function(f,e){var b={};b.Default=Backbone.Router.extend({loadingPath:null,lastRequest:null,routes:{"":"conciergePath","concierge/:fake_slug/:situation_id/":"conciergePath","concierge/:fake_slug/:parent_situation_id/:situation_id/":"conciergePath","logout/":"logoutPath","*path":"loadContent"},initialize:function(a){this.app=a.app},before:function(a,b){this.loadingPath=null;this.handlePagePreload(a,b);this.handleRouterNavigate_before(a,
b);this.handlePageStates(a,b)},after:function(a,b){this.handleRouterNavigate_after(a,b)},initialPage:function(){var a=this.getRouteAndParamsForCurrentFragment();this.handlePageStates.apply(this,a);var b=this.routes[a[0]];b!="loadContent"&&this[b].apply(this,a)},getRouteAndParamsForCurrentFragment:function(){var a=Backbone.history.getFragment(),b=this;return[_.filter(_.pairs(b.routes),function(d){return b._routeToRegExp(d[0]).test(a)})[0][0],[a]]},requestContent:function(a,b,d,g){this.lastRequest=
$.ajax({type:a,data:d,url:"/"+b,headers:{"X-HASHSIGNAL":1}});$.when(this.lastRequest).then(g.success,g.error)},getContent:function(a,b){this.requestContent("GET",a,"",b)},postContent:function(a,b,d){this.requestContent("POST",a,b,d)},requestAndInjectContent:function(a,b,d){var g=this;g.app.trigger("page-navigate-start",{path:b});this.requestContent(a,b,d,{success:function(d,h,i){var h=i.getResponseHeader("Content-Type"),e=i.getResponseHeader("X-HASHSIGNAL"),i=!1;h==="application/vnd.songza.hashsignal-route+json"?
(d.redirectLocation.match(/^\s*http[s]?/i)?(h=parseUri(d.redirectLocation),e=h.path,h.protocol!=window.location.protocol&&h.host!=window.location.host&&(i=!0)):(i=!1,e=d.redirectLocation),i?window.location=d.redirectLocation:g.navigate(e.substr(1),{trigger:!0,replace:!0})):a==="GET"&&e!==f.hashsignal?g.app.reloadApplication():b===g.loadingPath&&(g.app.view.updateContent(d),g.app.trigger("page-navigate",{path:b}))},error:function(d){var h=d.getResponseHeader("X-HASHSIGNAL");a==="GET"&&h!==f.hashsignal?
g.app.reloadApplication():b===g.loadingPath&&(d.status==404||d.status==403?g.app.view.updateContent(d.responseText):f.debug&&g.app.view.showErrorDocument(d.responseText),g.app.trigger("page-navigate-failure",{path:b}))}});this.loadingPath=b},getAndInjectContent:function(a){this.requestAndInjectContent("GET",a)},postAndInjectContent:function(a,b){this.requestAndInjectContent("POST",a,b)},loadContent:function(a,b){a==="_=_"?Backbone.history.navigate("/",!0):a.match(/^base_domain=/)||(b&&(a+="?"+e.formQuery(b)),
this.getAndInjectContent(a))},handlePageStates:function(a,b){var d={};if(a=="*path"){d.page_show_nav=!0;if(b[0].match(/^discover\/[^\/]+\/[^\/]+\/$/))d.page_show_subnav=!0,d.page_keep_subnav_open=!0;if(b[0].match(/^page/))d.page_show_subnav=!0,d.page_keep_subnav_open=!0;if(b[0].match(/^(login|signup|auth)/))d.page_show_nav=!1,d.page_show_auth=!0}this.app.view.setNextPageStates(d)},handlePagePreload:function(a,b){a=="*path"&&(b[0].match(/^discover/)&&this.app.view.updateContentWrapper(sz.tmpl.placeholders.explore()),
b[0].match(/^user\/playlists/)&&this.app.view.updateContentWrapper(sz.tmpl.placeholders.recents()))},handleRouterNavigate_before:function(a,b){a!="*path"&&this.app.trigger("router-navigate-start",{route:a,params:b})},handleRouterNavigate_after:function(a,b){a!="*path"&&this.app.trigger("router-navigate",{route:a,params:b})},logoutPath:function(){this.app.logoutAndResetVisitor();Backbone.history.navigate("",!0)},conciergePath:function(){var a=Backbone.history.getFragment(),a=a.replace(/\?[^?]+/,"");
this.app.getRenderedSingletonView_promise("concierge",{initial_path:a}).then(function(b,d){(!d||d.newly_created===!1)&&b.handleConciergePath(a)})}});return b});define("bklyn/songza/app-enhancements/key-capture",function(){var f,e={27:"escape",32:"spacebar"},b=function(){$(document).keyup(function(a){var b=!1;if(a.target.tagName=="INPUT"||a.target.tagName=="TEXTAREA")b=!0;e[a.which]&&f.getInstance().trigger("keypress-special",{type:e[a.which],shift:a.shiftKey,ctrl:a.ctrlKey,within_input_field:b})})};return{register:function(a){f=a;b()}}});define("bklyn/songza/app-enhancements/nav-and-subnav",["songza/base","bklyn/songza/views/nav-menu"],function(f,e){var b,a=function(){var a=b.getInstance(),d=a.view.el;a.bind("nav-show-subnav",function(b){e.SubnavView.display($(d).find(".subnav"),b.tag,b.galleries);a.view.setState("page_show_subnav",!0)});a.bind("nav-hide-subnav",function(){a.view.setState("page_show_subnav",!1)});a.bind("nav-keep-open-subnav",function(b){a.trigger("nav-show-subnav",b);a.view.setState("page_keep_subnav_open",!0)});
Backbone.history.getFragment().match(/^page/)&&a.trigger("nav-keep-open-subnav",{tag:"static"});$(d).click(function(b){var d=a.view.getState("page_show_subnav"),h=a.view.getState("page_keep_subnav_open");if(d&&!h&&b.pageX>$(".subnav").outerWidth())return a.trigger("nav-hide-subnav"),!1;return!0})};return{register:function(c){b=c;c=b.getInstance();c.main_nav_menu_view=new e.MainNavView({app:c});c.main_nav_menu_view.render();a()}}});define("bklyn/songza/app-enhancements/debug-console-require",["songza/config"],function(f){function e(a){return _.last(a.split("/")).replace(/(^|-)(.)/g,function(a){return a.substr(-1).toUpperCase()})}var b=function(a){_.isString(a)&&(a=[a]);if(_.isArray(a))var b=_.map(a,function(a){return e(a)}),a=_.object(a,b);_.each(a,function(a,b){require([b],function(c){window[a]&&console.log("window."+a+" being redefined.");window[a]=c;console.log("window."+a+" defined as module "+b)})})};return{register:function(){if(f.debug&&
!window.console_require)window.console_require=b}}});define("bklyn/songza/app-enhancements/init-favorites-manager",["bklyn/songza/systems/favorites-manager"],function(f){return{register:function(e){f.bindToApp(e.getInstance());f.getFavoritesManager().fetch()}}});define("bklyn/songza/app-enhancements/perfect-scrollbar",function(){var f={wheelSpeed:40,suppressScrollX:!0,wheelPropagation:!0};return{register:function(){$(".subnav").perfectScrollbar(f)}}});define("bklyn/songza/app-enhancements/loading-screen-hiding",function(){return{register:function(f){f.postInit(function(){$(".loading-screen").fadeOut("fast")})}}});define("bklyn/songza/app-enhancements/update-browser-title-with-current-song",function(){var f,e=function(){f.getInstance().bind("player-song-started player-song-play",function(b){window.document.title=window.document.title.replace(/(\u266b.*\u266b )|^/,"\u266b "+b.song.attributes.title+" by "+b.song.attributes.artist+" on "+b.station.attributes.name+" \u266b ")});f.getInstance().bind("player-song-pause",function(){window.document.title=window.document.title.replace(/(\u266b.*\u266b )|^/,"")})};return{register:function(b){f=
b;e()}}});define("bklyn/songza/app-enhancements/apply-background-gradient",["bklyn/songza/views/background-gradients"],function(f){var e,b=function(){f.setBackgroundByCurrentPeriod();e.getInstance().bind("concierge-context-changed",function(a){f.setBackgroundByPeriod(a.period)})};return{register:function(a){e=a;b()}}});define("bklyn/songza/app-enhancements/browser-warning",[],function(){return{register:function(){Modernizr.csscalc||($(".browser-warning").show(),$(".browser-warning-close").click(function(){$(".browser-warning").hide()}))}}});define("bklyn/songza/app-enhancements/search-bar",["bklyn/songza/views/search"],function(f){var e,b=function(){var a=e.getInstance();f._search_bar=new f.SearchBar;f.SearchResultsView.getRenderedView().bind("results-shown",function(){a.view.setState("search_results_show",!0)});f.SearchResultsView.getRenderedView().bind("results-hidden",function(){a.view.setState("search_results_show",!1)});a.bind("page-navigate-start router-navigate-start",function(){f.SearchResultsView.reset()});a.bind("keypress-special",
function(a){a.type=="escape"&&(f._search_bar.handleClose(),f._search_bar.forceInputBlur())})};return{register:function(a){e=a;b()}}});define("bklyn/songza/app-enhancements/recent-stations-for-user",["bklyn/songza/views/recent-stations"],function(f){var e,b,a=function(a){b||(b=new f({app:e.getInstance()}));a.isAnonymous()?b.render():a.get("recent").fetch({success:function(){b.render()}})},c=function(){var b=e.getInstance();a(b.visitor);b.bind("visitor-change",function(b){a(b.newVisitor)})};return{register:function(a){e=a;c()}}});define("bklyn/songza/app",["songza/base","songza/config","bklyn/songza/site-views","bklyn/songza/routers","songza/models","songza/utils"],function(f,e,b,a,c,d){var g,j=[],h=[],i={},l=null,k=[],n=!1;if(!window.console)window.console={};if(!window.console.log)window.console.log=function(){};var m=f.Class.extend({initialize:function(c){var g=this;this.router=new a.Default({app:this});this.view=new b.Default({app:this});this.visitor=c.visitor;this.environment=c.environment||{};this.postLoginQueue=[];
this.player=null;this.stationMeta={};this.configHistory();this.router.initialPage();e.debug&&console&&console.log&&this.bind("all",function(a,b){a!="player-song-play-state"&&console.log("songza-app: ["+a+"]",b)});this.bind("dom-node-inserted",function(a){m.enhanceDOM(a.node)});$(window).bind("beforeunload",function(){g.stopStation();g.trigger("app-unload")})},featureEnabled:function(a){return this.getEnvironment().session_features[a]?!0:!1},getConfig:function(){return e},getVisitor:function(){return this.visitor},
setVisitor:function(a){var b=this.visitor;if(a.get("id")!==b.get("id"))this.visitor=a,this.trigger("visitor-change",{oldVisitor:b,newVisitor:a}),b.get("id")===0&&a.get("id")&&_.each(this.postLoginQueue,function(a){a()}),this.postLoginQueue=[];$("html").removeClass("sz-user-anonymous");$("html").removeClass("sz-user-authenticated");$("html").removeClass("sz-user-admin");a.isAnonymous()?$("html").addClass("sz-user-anonymous"):($("html").addClass("sz-user-authenticated"),a.isAdmin(e.site)&&$("html").addClass("sz-user-admin"))},
logout:function(){return c.User.logout()},logoutAndResetVisitor:function(){var a=this.logout();this.setVisitor(new c.User({id:0},{parse:!0}));return a},setEnvironment:function(a){this.current_version&&a.version!=this.current_version&&this.queueReload();this.current_version=a.version;this.environment=a;this.trigger("environment-change",{environment:a})},getEnvironment:function(a){if(a===void 0)return this.environment;return this.environment[a]},getVersion:function(){return this.current_version},queueReload:function(){var a=
this,b=this.getPlayer();b?b.isPlaying()?b.model.get("station").get("type")!=="stream"&&(this.savePlayerState(),b.shutdown(function(){a.reloadApplication()})):this.reloadApplication():this.reloadApplication()},reloadApplication:function(){window.location.reload(!0)},savePlayerState:function(){var a=this.getPlayer();Modernizr.sessionstorage&&a&&(a=a.model.get("station").toJSON(),window.sessionStorage.setItem("player-station",JSON.stringify(a)))},restorePlayerState:function(){var a;if(Modernizr.sessionstorage&&
(a=window.sessionStorage.getItem("player-station"),window.sessionStorage.removeItem("player-station"),a)){try{a=JSON.parse(a)}catch(b){return}this.startStation(new c.Station(a,{parse:!0}))}},refresh:function(){Backbone.history.loadUrl(Backbone.history.getFragment())},configHistory:function(){Backbone.history.start({pushState:this.supportsHistory(),silent:!this.mustFetchInitialPage()})},supportsHistory:function(){return Modernizr.history},mustFetchInitialPage:function(){return window.location.hash},
currentlyPlayingStation:function(){return this.player&&this.player.model.get("station")},startStation:function(a,b){var c=this,b=b||{},g=!1;if(this.player){if(this.player.model.get("station").get("id")===a.get("id")){b.force&&this.player.play();return}g=this.player.getState("full_screen")}this.stopStation();require(["songza/player/view"],function(d){var i=new d.PlayerState({station:a});c.player=new d.PlayerView({model:i,app:c,artist:b.artist,resumeState:b.resumeState,showFlashyHighlights:b.showFlashyHighlights});
c.player.bind("all",function(a,b){(a.indexOf("song-")===0||a==="metadata"||a.indexOf("station-")===0)&&c.trigger("player-"+a,b)});g&&c.player.setState("full_screen",g);c.view.$player().append(c.player.render().el);d=function(){c.player.start();c.trigger("player-station-started",{station:a})};if(!b.situations&&window.__awkward_workaround_situations&&window.__awkward_workaround_situations[a.get("id")])b.situations=window.__awkward_workaround_situations[a.get("id")];l?l(a,d,{situations:b.situations}):
d()})},stopStation:function(){var a=this.getPlayer();if(a)this.trigger("player-station-stopped",{station:a.model.get("station")}),a.destroy(),this.player=null},togglePlayingStation:function(){this.player&&this.player.play_or_pause()},getPlayer:function(){return this.player},addPostLoginAction:function(a){this.postLoginQueue.push(a)},authenticatedAction:function(a){if(this.getVisitor().isAnonymous()){a=_.clone(a);if(!a.next)a.next="/"+Backbone.history.getFragment();a.action&&this.addPostLoginAction(a.action);
d.formQuery({next:a.next});Backbone.history.navigate("login/?next="+encodeURIComponent(a.next),!0)}else a.action&&a.action()},loginUrlPath:function(){return"/login/?"+d.formQuery({next:"/"+Backbone.history.getFragment()})},signupUrlPath:function(){return"/signup/?"+d.formQuery({next:"/"+Backbone.history.getFragment()})},trigger:function(a,b){b=b||{};b.eventTime=new Date;b.eventName=a;Backbone.Events.trigger.call(this,a,b)},enhanceDOM:function(a){m.enhanceDOM(a)},getSharingSystems:function(){return m.getSharingSystems()},
_pruneStationMeta:function(){var a=this.getPlayer(),b,c;if(!(_.values(this.stationMeta).length<4))a&&(b=a.model.get("station").get("id"),c=this.stationMeta[b]),this.stationMeta={},b&&(this.stationMeta[b]=c)},setStationMeta:function(a,b){this._pruneStationMeta();this.stationMeta[a.get("id")]=b;this.trigger("station-meta-changed",{station:a,meta:b})},getStationMeta:function(a){return this.stationMeta[a.get("id")]}},{loadPlugins:function(a){function b(){if(n=_.reduce(_.values(c),function(a,b){return a&&
b}))_.each(k,function(a){a()}),m.getInstance().restorePlayerState()}var c={};_.each(a,function(a){c[a]=!1});_.each(a,function(a){require([a],function(g){c[a]=!0;try{g.register(m)}catch(d){console.log("Failed to load plugin: "+a,g,d)}b()})})},addDOMEnhancement:function(a){j.push(a);a($(g.view.el))},enhanceDOM:function(a){_.each(j,function(b){try{b(a)}catch(c){console.log("Failed to apply enhancement",c)}})},setStationPrePlayHook:function(a){l=a},addCommentProvider:function(a,b){i[a]=b},getCommentProvider:function(a){return i[a]},
addSharingSystem:function(a){h.push(a)},getSharingSystems:function(){return h},init:function(a,b,c){m.initInstance(a,b);m.loadPlugins(c)},initInstance:function(a,b){g=new m({visitor:a,environment:b})},getInstance:function(){if(!g)throw Error("Application instance has not been created. Perhaps you forgot to call App.init first?");return g},postInit:function(a){n?a():k.push(a)}});typeof Cocktail!=="undefined"&&Cocktail.mixin(m,{_singleton_views:{},getRenderedSingletonView_promise:function(a,b){var c,
g=this,d=$.Deferred();if(this._singleton_views[a])if(this.view.isWithinContentWrapper(this._singleton_views[a].el))return c=this._singleton_views[a],d.resolve(c,{newly_created:!1}),d;else this._singleton_views[a]=null;a=="concierge"?require(["bklyn/songza/views/concierge"],function(i){c=new i.Top(b);g.view.updateContentWrapper(c.render().el);c.show&&c.show();g._singleton_views[a]=c;d.resolve(c,{newly_created:!0})}):d.reject();return d}});return m});define("bklyn/songza/systems/favorites-manager",["songza/base","songza/models"],function(f,e){var b=f.Class.extend({initialize:function(a){b.__super__.initialize.call(this,a);a=a||{};this.user=a.user;this.station_ids=[];this.favorites_collection=null},fetchOnce:function(){return this.fetch_promise?this.fetch_promise:this.fetch()},fetch:function(){var a=this;this.fetch_promise&&this.fetch_promise.reject();this.fetch_promise=$.Deferred();this.user&&!this.user.isAnonymous()?a.user.get("collections").fetch().promise().then(function(){if(a.fetch_promise.state()==
"pending"){var b=a.user.get("collections").filter(function(a){return a.get("title")=="Favorites"})[0],b=b||a.user.get("collections").at(0);a.favorites_collection=b;a.station_ids=_.union.apply(this,a.user.get("collections").map(function(a){return a.get("station_ids")}));a.trigger("change");a.fetch_promise.resolve()}}):this.fetch_promise.reject();return this.fetch_promise},ensureFavoritesCollection:function(){var a=this,b=$.Deferred();this.fetch().then(function(){a.favorites_collection?b.resolve():
a._create_favorites_collection().then(function(){a.favorites_collection?b.resolve():b.reject()})});return b},_create_favorites_collection:function(){var a=this,b=$.Deferred();if(a.favorites_collection)b.resolve();else{var d=new e.UserCollection({title:"Favorites",user_id:a.user.get("id")});d.save({},{success:function(){a.favorites_collection=d;b.resolve()}})}return b},containsStationId:function(a){return _.indexOf(this.station_ids,a)>=0},containsStation:function(a){return this.containsStationId(a.get("id"))},
addStationId:function(a){var b=this,d=$.Deferred();this.ensureFavoritesCollection().then(function(){b.favorites_collection.addStation(a).then(function(){a in b.station_ids||b.station_ids.push(a);b.trigger("change");d.resolve()})});return d},removeStationId:function(a){var b=this,d=$.Deferred();this.fetch().then(function(){b.user.get("collections").forEach(function(b){b.containsStation(a)&&b.removeStation(a)});b.station_ids=_.without(b.station_ids,a);b.trigger("change");d.resolve()});return d}},{_favorites_manager:null,
bindToApp:function(a){this._favorites_manager=new b({user:a.visitor});a.bind("visitor-change",function(a){this._favorites_manager=new b({user:a.newVisitor})});return this._favorites_manager},getFavoritesManager:function(){return this._favorites_manager}});return b});define("bklyn/songza/systems/itunes-api",["songza/utils"],function(){return{makeSearchUrl:function(f){_.isArray(f)&&(f=f.join(" "));var e="https://itunes.apple.com/search?term=";e+=encodeURIComponent(f);e+="&media=music&limit=1";return e},searchForTrack:function(f,e){e=e||{};$.ajax({url:this.makeSearchUrl(f),dataType:"jsonp",jsonp:"callback",success:e.success,failure:e.error})},searchForTrackAndReturnTrackViewUrl:function(f,e){e=e||{};this.searchForTrack(f,{success:function(b){(b=b&&b.results&&b.results[0]&&
b.results[0]&&b.results[0].trackViewUrl)?(b+="&at=1l3vbgV",e.success&&e.success(b)):e.error&&e.error()},failure:e.error})}}});define("bklyn/songza/views/search",["songza/app","songza/base","songza/models","bklyn/songza/views/view-stack","bklyn/songza/views/view-collection-mixin"],function(f,e,b){var a={};a.SearchBar=e.View.extend({el:".searchbox",events:{"keypress input":"handleKeypress","focus input":"handleInputFocus","blur input":"handleInputBlur","click .search-close":"handleClose"},initialize:function(){a.SearchResultsView.getRenderedView().bind("clickoutside-results",function(){a._search_bar.handleClose()})},handleKeypress:function(a){if(a.which==
13)return this.doSearch($(a.target).val()),!1},handleInputFocus:function(){$(this.el).addClass("active")},forceInputBlur:function(){$(this.el).find("input").blur()},handleInputBlur:function(){$(this.el).removeClass("active")},doSearch:_.debounce(function(c){function g(b){d[b]=!0;_.every(d)&&a.SearchResultsView.getRenderedView().setState("in_progress",!1)}if(c){a.SearchResultsView.showEmpty();a.SearchResultsView.getRenderedView().setState("in_progress",!0);f.getInstance().view.$el.scrollTop(0);var d=
{situations:!1,artists:!1,stations:!1};b.Situation.search({query:c,style:"flat-220"},{success:function(b){a.SearchResultsView.updateResults("situations",b.models);g("situations",b.models.length>0)}});b.Artist.search(c,{success:function(b){a.SearchResultsView.updateResults("artists",b.models);g("artists",b.models.length>0)}});b.Station.search(c,{success:function(b){a.SearchResultsView.updateResults("stations",b.models);g("stations",b.models.length>0)}})}else a.SearchResultsView.reset()},250,!0),handleClose:function(){$(this.el).find("input").val("");
a.SearchResultsView.reset()},render:function(){}});var c=a.SearchResultsView=e.View.extend({el:".search-wrapper",states:{in_progress:{set:!1,onCss:"search-in-progress"},results_found:{set:!1,onCss:"search-results-found"}},situation_search_results_subview:null,artist_search_results_subview:null,station_search_results_subview:null,situation_search_results_collection:null,artist_search_results_collection:null,station_search_results_collection:null,initialize:function(a){var b=this;c.__super__.initialize.call(this,
a);this.in_progress=!1;this.situation_search_results_collection=new Backbone.Collection([]);this.artist_search_results_collection=new Backbone.Collection([]);this.station_search_results_collection=new Backbone.Collection([]);this.situation_search_results_subview=new g({parent_view:this,collection:this.situation_search_results_collection});this.artist_search_results_subview=new j({parent_view:this,collection:this.artist_search_results_collection});this.station_search_results_subview=new h({parent_view:this,
collection:this.station_search_results_collection});_.each(this.subcollections(),function(a){a.bind("reset",b.updateState_resultsFound,b);a.bind("add",b.updateState_resultsFound,b);a.bind("remove",b.updateState_resultsFound,b);a.bind("change",b.updateState_resultsFound,b)})},updateState_resultsFound:function(){this.setState("results_found",this.situation_search_results_collection.length+this.artist_search_results_collection.length+this.station_search_results_collection.length>0)},resetResults:function(){this.situation_search_results_collection.reset([]);
this.artist_search_results_collection.reset([]);this.station_search_results_collection.reset([])},subviews:function(){return[this.situation_search_results_subview,this.artist_search_results_subview,this.station_search_results_subview]},subcollections:function(){return[this.situation_search_results_collection,this.artist_search_results_collection,this.station_search_results_collection]},render:function(){var a={};_.each(this.subviews(),function(b){b.render(a)});return this},show:function(){$(this.el).show();
this.trigger("results-shown");return this},hide:function(){$(this.el).hide();this.trigger("results-hidden");return this}},{_view:null,getRenderedView:function(){if(!this._view)this._view=new c,this._view.render();return this._view},updateResults:function(a,b){var c=this.getRenderedView();a=="situations"?c.situation_search_results_collection.reset(b):a=="artists"?c.artist_search_results_collection.reset(b):a=="stations"&&c.station_search_results_collection.reset(b);c.show()},showEmpty:function(){var a=
this.getRenderedView();a.resetResults();a.show()},reset:function(){var a=this.getRenderedView();a.hide();a.resetResults()}}),d=e.View.extend({initialize:function(a){d.__super__.initialize.call(this,a);a=a||{};this.collection=a.collection?a.collection:new Backbone.Collection([]);this.parent_view=a.parent_view;this.collection.bind("reset",this.render,this);this.collection.bind("add",this.render,this);this.collection.bind("remove",this.render,this);this.collection.bind("change",this.render,this);var b=
this;$(this.el).bind("clickoutside",function(){b.parent_view.trigger("clickoutside-results")})},context:function(){return{results:this.collection.toJSON()}},render:function(){d.__super__.render.call(this);f.getInstance().enhanceDOM(this.el)}}),g=d.extend({el:".search-situations",template:sz.tmpl.search.situation_search_results,context:function(){return{results:this.collection.map(function(a){var b=a.toJSON();b.concierge_url=a.toPath();return b})}}}),j=d.extend({el:".search-artists",template:sz.tmpl.search.artist_search_results}),
h=d.extend({el:".search-playlists",template:sz.tmpl.search.station_search_results,context:function(){return{results:this.collection.map(function(a){var b=a.toJSON();b.cover_url=a.getCoverUrl({size:300,style:"three-by-two-flush"});return b})}}});return a});define("bklyn/songza/views/nav-menu",["songza/app","songza/base","songza/models","bklyn/songza/views/view-collection-mixin"],function(f,e,b,a){var f={},c=f.MainNavView=e.View.extend({el:".nav",elements:{".nav-item":"$navItems",".nav-item.selected":"$selectedNavItems"},events:{"click .nav-item a":"onMenuClick"},initialize:function(a){var b=this;c.__super__.initialize.call(this,a);this.app=a.app;this.app.bind("page-navigate router-navigate nav-hide-subnav",function(){b.updateSelection()});this.updateSelection()},
onMenuClick:function(a){var a=$(a.target).parent(),b=a.data("nav-id");this.updateSelection(b);a.hasClass("nav-item-explore")||this.app.view.getState("page_keep_subnav_open")||this.app.trigger("nav-hide-subnav");if(a.hasClass("nav-item-explore"))return this.app.trigger("nav-show-subnav",{tag:b}),!1},updateSelection:function(a){this.$selectedNavItems();this.$selectedNavItems().removeClass("selected");a?this.$navItems().filter(function(){return $(this).data("nav-id")==a}).addClass("selected"):this.$navItems().filter(function(){if($(this).find("a").attr("href")==
window.location.pathname)return!0;if($(this).data("select-if-href-root")!==void 0&&window.location.pathname.indexOf($(this).find("a").attr("href"))===0)return!0;if($(this).data("select-if-match")!==void 0&&window.location.pathname.indexOf($(this).data("select-if-match"))===0)return!0}).addClass("selected")},hide:function(){this.$el.removeClass("show")},show:function(){this.$el.addClass("show")},render:function(){}}),d=f.SubnavView=a.extendViewClass(e.View.extend({})).extend({template:sz.tmpl.nav.subnav,
modelTemplate:sz.tmpl.nav.subnav_item,css:"subnav-content",collectionContainerEl:function(){return this.$el.find(".subnav-items")},elements:{".subnav-item":"$items"},events:{"click .subnav-item a":"onClick"},initialize:function(a){this.tag_slug=a.tag;this.tag=new b.Tag({id:this.tag_slug});a.galleries?this.tag.galleries.reset(this.tag.galleries.parse(a.galleries)):this.tag.galleries.fetch({reset:!0});d.__super__.initialize.call(this,_.extend(a,{collection:this.tag.galleries}))},selectItem:function(a){this.$items().removeClass("selected");
this.$el.find(".subnav-item a[href='"+a+"']").parent(".subnav-item").addClass("selected")},onClick:function(a){this.selectItem($(a.target).attr("href"));return!0},context:function(){return{tag:{slug:this.tag_slug,name:this.tag_slug.charAt(0).toUpperCase()+this.tag_slug.slice(1)}}},render:function(){var a=d.__super__.render.call(this);this.show();return a},show:function(){this.selectItem(location.pathname);this.$el.show()},hide:function(){this.selectItem(null);this.$el.hide()}},{cache:{},getStaticView:function(a){return $(a).find(".subnav-content-static")},
display:function(a,b,c){_.each(this.cache,function(a){a.tag_slug==b?a.show():a.hide()});if(!this.cache[b])b=="static"?(c=this.getStaticView(a),this.cache[b]=c,c.tag_slug=b,c.show()):(c=new d({tag:b,galleries:c}),this.cache[b]=c,a.append(c.render().el));return this.cache[b]}});return f});define("bklyn/songza/views/player",["songza/base","songza/config","songza/sharing","songza/player/manager/basic","songza/player/manager/chrome-cast-controlling-sender","songza/player/manager/stream","songza/player/chrome-cast"],function(f,e,b,a,c,d,g){var j={skip_limit:"You've hit your skip limit!"},h={skip_limit:15E3},i={};i.PlayerState=Backbone.Model.extend({defaults:{station:null,similar_stations:null,current:null,state:"station",playState:"pause"},initialize:function(a){var b=this;this.history=
new Backbone.Collection([]);a.station&&a.station.getSimilarStations({success:function(a){b.set("similar_stations",a)}})}});var l=i.PlayerView=f.View.extend({template_miniplayer:sz.tmpl.player.miniplayer,template_fullplayer:sz.tmpl.player.fullplayer,events:{"click .miniplayer-control-play-pause":"play_or_pause","click .miniplayer-control-skip":"skip","click .miniplayer-track-action.thumb-up":"voteUp","click .miniplayer-track-action.thumb-down":"voteDown","click .miniplayer-album-art":"toggleFullscreen",
"click .miniplayer-expand":"toggleFullscreen","click .miniplayer-link-toggles-fullscreen":"toggleFullscreen","click .miniplayer-volume-icon":"toggleMute","click .track-history-toggle":"toggleTrackHistory","click .track-history-thumb-up":"voteUp","click .track-history-thumb-down":"voteDown","click .fullplayer-control-track-prev":"trackHistoryPrev","click .fullplayer-control-track-next":"trackHistoryNext","click .fullplayer-control-play-pause":"play_or_pause","click .fullplayer-control-skip":"skip",
"click .fullplayer-control-thumb-up":"voteUp","click .fullplayer-control-thumb-down":"voteDown","click .fullplayer-collapse":"toggleFullscreen"},elements:{".miniplayer-info-error-message":"$errorMessage",".miniplayer-timeline-current-time, .fullplayer-timeline-current-time":"$currentTime",".fullplayer-song-wrapper":"$songWrappers",".miniplayer-volume":"$volumeControl",".miniplayer-volume-slider-track":"$volumeControlSliderTrack"},css:"player-wrapper",states:{state_station:{set:!0,onCss:"player-state-station"},
state_song:{set:!1,onCss:"player-state-song"},state_error:{set:!1,onCss:"player-error"},state_fetch_next:{set:!1,onCss:"player-fetching-next"},play_state_play:{set:!1,onCss:"player-state-play"},play_state_pause:{set:!0,onCss:"player-state-pause"},buffering:{set:!1,onCss:"player-buffering"},no_skip:{set:!1,onCss:"player-no-skip"},skip_disabled:{set:!1,onCss:"player-skip-disabled"},full_screen:{set:!1,onCss:"player-full-screen"},show_track_history:{set:!1,onCss:"player-show-track-history"},flashy_highlights:{set:!1,
onCss:"player-flash-highlights",timeout:2E3}},initialize:function(b){var h=this;l.__super__.initialize.call(this,b);_.bindAll(this,"render");$(this.el).bind("clickoutside",function(){h.leaveTrackHistory()});this.app=b.app;this.volumeCookieName="JS_PLAYER_VOLUME";this.errorMessage="";this.app.bind("visitor-change",this.render);this.model.history.bind("change",this.render);this.model.history.bind("add",this.render);this.model.history.bind("remove",this.render);this.model.history.bind("reset",this.render);
this.model.bind("change:current",this.render);this.model.bind("change:state",function(){_.each(["station","song","error","fetch_next"],function(a){h.setState("state_"+a,!1)});h.setState("state_"+h.model.get("state"),!0)});this.model.bind("change:playState",function(){_.each(["play","pause"],function(a){h.setState("play_state_"+a,a==h.model.get("playState"))});h.songTrigger(h.model.get("playState"));h.stationTrigger(h.model.get("playState"))});if(this.model.get("station").get("stream"))this.manager=
new d.Manager({station:this.model.get("station"),volume:this.getSavedVolume()});else if(g.isCasting())this.manager=new c.Manager({station:this.model.get("station"),artist:b.artist,volume:this.getSavedVolume(),session:g.getSession(),resumeState:b.resumeState});else{var i={station:this.model.get("station"),artist:b.artist,volume:this.getSavedVolume(),resumeState:b.resumeState};if(Modernizr.is_safari)document.createElement("audio"),i.audioElement=document.createElement("audio"),i.html5=!0;this.manager=
new a.Manager(i)}this.manager.supportsNext()||this.setState("no_skip",!0);this.manager.bind("metadata",function(a){h.trigger("metadata",a)});this.manager.bind("fetching-next",function(){h.updateErrorMessage(!1);h.model.set({state:"fetch_next"})});this.manager.bind("skip-state-changed",function(a){a?h.setState("skip_disabled",!1):h.setState("skip_disabled",!0)});this.manager.bind("error",function(a){h.updateErrorMessage(a.message);h.model.set({state:"error"});h.trigger("error",a)});this.manager.bind("song-started",
function(a){h.updateErrorMessage(!1);h._songStarted(a.song)});this.manager.bind("started",function(){h.model.set({playState:"play"})});this.manager.bind("song-skipped",function(a){h.songTrigger("skipped");h._songEnded(a.song)});this.manager.bind("song-completed",function(a){h.songTrigger("completed");h._songEnded(a.song)});this.manager.bind("song-state",function(a){if(a=a.songState)a.buffering?h._startSpinner():h._stopSpinner(),h.setState("buffering",a.buffering),a.duration>0&&h.setProgress(a.position/
a.duration*100)});this.manager.bind("song-play",function(){h.model.set({playState:"play"})});this.manager.bind("song-pause",function(){h.model.set({playState:"pause"})});this.manager.bind("stream-play",function(){h.model.set({playState:"play"})});this.manager.bind("stream-pause",function(){h.model.set({playState:"pause"})});this.app.view.setState("miniplayer_show",!0);this.bind("stateChange",function(a,b){a=="full_screen"&&h.app.view.getState("fullplayer_show")!=b&&h.app.view.setState("fullplayer_show",
b)});this.app.bind("page-navigate-start router-navigate-start",function(){h.leaveFullscreen()});this.app.bind("keypress-special",function(a){a.within_input_field||a.type=="spacebar"&&h.play_or_pause()});this.app.bind("request-player-enter-fullscreen",function(){h.enterFullscreen()});b.showFlashyHighlights&&this.showFlashyHighlights()},setProgress:_.throttle(function(a){this.$currentTime().css("width",a+"%")},500),destroy:function(){l.__super__.destroy.call(this);this.manager.destroy()},updateProgress:function(){this.manager.songState()},
updateErrorMessage:function(a,b){b=b||{};this.$errorMessage().empty();if(a)this.errorMessage=a,this.$errorMessage().text(a);if(this.__updateErrorMessage_expire_promise)this.__updateErrorMessage_expire_promise.reject(),this.__updateErrorMessage_expire_promise=null;if(b.expire){var c=this,g=this.__updateErrorMessage_expire_promise=$.Deferred();g.then(function(){c.$errorMessage().empty();c.updateErrorMessage(!1)});setTimeout(function(){g.resolve()},b.expire)}},stationTrigger:function(a){this.trigger("station-"+
a,{station:this.model.get("station")})},songTrigger:function(a){this.model.get("current")&&this.trigger("song-"+a,{station:this.model.get("station"),song:this.model.get("current"),songState:this.manager.songState()})},songState:function(){return this.manager.songState()},getListenTime:function(){return this.manager.getListenTime()},start:function(){this.manager.start()},play_or_pause:function(){this.isPlaying()?this.pause():this.play();return!1},play:function(){this.manager.play();return!1},pause:function(){this.manager.pause();
return!1},shutdown:function(a,b){var c=this;this.manager.shutdown(a,function(){c.model.set({state:"shutdown"});b&&b()})},isPlaying:function(){return this.model.get("playState")==="play"},isPaused:function(){return this.model.get("playState")==="pause"},skip:function(){this.manager.canSkip()?this.manager.next():this.updateErrorMessage(j.skip_limit,{expire:h.skip_limit})},_songStarted:function(a){a.bind("change",this.render);this.model.set({playState:"play",current:a,state:"song"});this.songTrigger("started")},
_songEnded:function(){var a=this.model.get("current");a&&(a.unbind("all"),this.model.history.add(a,{at:0}),this.model.set({current:null,state:"station"}));this.model.history.models.length>10&&this.model.history.remove(this.model.history.last())},allSongs:function(){var a=this.model.history.models,b=this.model.get("current");return _.union(a,b?[b]:[])},songContext:function(a){var b={song:a.toJSON(),song_id:a.cid,album:a.get("streamSong").get("song").get("album"),vote:a.get("vote"),station:this.model.get("station").toJSON(),
visitor:this.app.getVisitor().toJSON()};b.song.alt_image_urls=a.altImageUrls();return b},render:function(){var a=this,b=this.model.get("station"),c=this.model.get("similar_stations"),g=this.model.get("current");this.app.getVisitor();var d={station:b.toJSON(),station_url:b.pageUrlPath(),song:null,history:[]};d.station.cover_url=b.getCoverUrl({size:400,style:"three-by-two-flush"});d.station.featured_artists_label=b.featured_artists_label();c&&(d.similar_stations=c.models.map(function(a){var b=a.toJSON();
b.cover_url=a.getCoverUrl({size:400,style:"three-by-two-flush"});b.featured_artists_label=a.featured_artists_label();return b}));this.prerender&&_.each(this.prerender,function(b){_.isFunction(b)&&(b=b.call(a))&&(d=_.extend(d,b))});if(g)b=this.songContext(g),d.song=b.song,d.album=b.album,d.vote=b.vote;this.model.history.each(function(b){d.history.push(a.songContext(b))});$(this.el).html(this.template_miniplayer(d)+this.template_fullplayer(d));this.sync();this.updateErrorMessage(!1);this.getState("buffering")&&
this._startSpinner();this.app.enhanceDOM(this.el);this.updateVolumeMutedState();this.activateVolumeSlider();return this},_startSpinner:function(){},_stopSpinner:function(){},findSongOrCurrent:function(a){return a?this.findSong(a):this.model.get("current")},findSong:function(a){var b,c=this.allSongs();for(b=0;b<c.length;b++)if(c[b].cid==a)return c[b];throw Error("Unable to locate song with id["+a+"] in player"+a);},voteUp:function(a){var a=this.findSongOrCurrent($(a.target).attr("data-sz-song-id")),
b=a.get("streamSong");b&&(a.set({vote:"up"}),b.voteUp(),this.songTrigger("vote-up"));return!1},voteDown:function(a){var a=this.findSongOrCurrent($(a.target).attr("data-sz-song-id")),b=a.get("streamSong");b&&(a.set({vote:"down"}),b.voteDown(),this.songTrigger("vote-down"));a.cid===this.model.get("current").cid&&this.manager.next();return!1},trackHistoryPrev:function(){var a=this.$songWrappers().filter(".active"),b=a.prev();b.length&&(a.removeClass("active").addClass("pushed-right"),b.addClass("active"))},
trackHistoryNext:function(){var a=this.$songWrappers().filter(".active"),b=a.next();b.length&&(a.removeClass("active"),b.addClass("active").removeClass("pushed-right"))},enterFullscreen:function(){this.getState("full_screen")||this.setState("full_screen",!0);this.$el.find(".fullplayer-info").addClass("fullplayer-info-show-preview");this.app.trigger("ad-refresh-requested")},leaveFullscreen:function(){this.$el.find(".fullplayer-info").removeClass("fullplayer-info-show-preview");this.getState("full_screen")&&
this.setState("full_screen",!1);this.app.trigger("ad-refresh-requested")},toggleFullscreen:function(){this.getState("full_screen")?this.leaveFullscreen():this.enterFullscreen()},toggleTrackHistory:function(){this.setState("show_track_history",!this.getState("show_track_history"))},leaveTrackHistory:function(){this.getState("show_track_history")&&this.setState("show_track_history",!1)},showFlashyHighlights:function(){var a=this;this.setState("flashy_highlights",!0);setInterval(function(){a.setState("flashy_highlights",
!1)},this.states.flashy_highlights.timeout)},activateVolumeSlider:function(){var a=this;this.$volumeControlSliderTrack().noUiSlider({range:[0,100],start:this.getVolume(),step:1,handles:1,direction:"rtl",orientation:"vertical",slide:function(){a.setVolume(this.val(),!0)}})},updateVolumeMutedState:function(){this.getVolume()==0?this.$volumeControl().addClass("muted"):this.$volumeControl().removeClass("muted")},toggleMute:function(){this.getVolume()==0?this.setVolume(this.getSavedVolume()):this.setVolume(0)},
startLockedMute:function(){this.setVolume(0);this.$volumeControlSliderTrack().attr("disabled","disabled")},stopLockedMute:function(){this.setVolume(this.getSavedVolume());this.$volumeControlSliderTrack().removeAttr("disabled")},setVolume:function(a,b){a=parseInt(a);this.manager&&this.manager.setVolume(a);this.updateVolumeMutedState();this.$volumeControlSliderTrack().val()!=a&&this.$volumeControlSliderTrack().val(a);b&&$.cookie(this.volumeCookieName,a,{expires:365,path:"/"})},getSavedVolume:function(){var a=
$.cookie(this.volumeCookieName);return a!==null&&a!==void 0?parseInt(a,10):100},getVolume:function(){return this.manager.getVolume()},getManager:function(){return this.manager}});Cocktail.mixin(l,{shareItem:function(){var a,c=this.model.get("station");a=this.model.get("current");a=a==null?"#NowPlaying "+c.get("name")+" Playlist":'#NowPlaying "'+a.get("title")+'" by '+a.get("artist")+" (on "+c.get("name")+")";return new b.SharePageItem({title:c.get("name"),description:c.get("description"),url:e.makeAbsolute(c.pageUrlPath()),
image_url:c.get("cover_url"),share_text:a})}},{events:{"click .miniplayer-chromecast-connect":"connectChromeCast","click .miniplayer-chromecast-disconnect":"disconnectChromeCast"},states:{chrome_cast_receiver_found:{set:!1,onCss:"player-chrome-cast-receiver-found"},chrome_cast_session_active:{set:!1,onCss:"player-chrome-cast-session-active"}},initialize:function(){_.bindAll(this,"_syncChromeCastState");g.bind("receiver-list-change",this._syncChromeCastState);g.bind("cast-start",this._syncChromeCastState);
g.bind("cast-stop",this._syncChromeCastState);this._syncChromeCastState()},_syncChromeCastState:function(){this.setState("chrome_cast_session_active",g.isCasting());this.setState("chrome_cast_receiver_found",g.haveReceivers())},connectChromeCast:function(){g.startCast()},disconnectChromeCast:function(){g.stopCast()}});return i});define("bklyn/songza/views/concierge",["songza/app","songza/config","songza/base","songza/models","songza/situation-tracker","bklyn/songza/views/view-stack","bklyn/songza/views/view-collection-mixin"],function(f,e,b,a,c,d,g){var b={},j=b.Top=d.Base.extend({template:sz.tmpl.concierge.top,elements:{".concierge-views":"viewsEl"},events:{"click .concierge-back":"handleBack"},states:{has_history:{set:!1,onCss:"concierge-has-history"}},inactive_view_css:"inactive",css:"concierge",initialize:function(a){j.__super__.initialize.call(this,
a);this.bindToApp(f.getInstance());this.bind("situation-clicked",this.handleSituationClick,this);this.bind("station-clicked",this.handleStationClick,this);this.initializeTracker(f.getInstance());this.initializeSituationContext();a&&a.initial_path?this.handleConciergePath(a.initial_path):this.handleConciergePath()},syncHistory:function(){this.activeView()&&this.activeView().ignore_history?this.setState("has_history",!1):j.__super__.syncHistory.call(this)},addViewAndBind:function(a,b){var c=this,b=
b||{};_.each(j.BROADCAST_EVENTS,function(b){a.bind(b,function(a){c.trigger(b,a)})});b.leave_history_alone||Backbone.history.navigate(a.getPath(),{replace:b.change_in_place});var d=this.addView(a);d.then(function(){f.getInstance().enhanceDOM(c.activeView().el)});return d},bindToHelpfulDebugging:function(){var a=this;f.getInstance().bind("player-song-started",function(a){console.log("\u266b "+(a.song.attributes.title+" by "+a.song.attributes.artist+" on "+a.station.attributes.name)+" \u266b")});_.each(j.BROADCAST_EVENTS,
function(b){a.bind(b,function(a){console.log([b,a.station&&a.station.get("name")||a.situation&&a.situation.get("title")||a.stations&&a.stations.map(function(a){return a.get("name")}).join(",")||a.situations&&a.situations.map(function(a){return a.get("title")}).join(",")||null,a.parentSituations&&a.parentSituations.map(function(a){return a.get("title")}).join(",")])})})},bindToApp:function(a){var b=this;_.each(j.BROADCAST_EVENTS,function(c){b.bind(c,function(d){d.context=d.context||b.situationContext;
a.trigger("concierge-"+c,d)})})},initializeTracker:function(a){var b=this,d=new c({app:a});this.tracker=d;this.bind("situations-shown",function(a){d.logSituationEvent("impression",b.situationContext,a.situations,a.parentSituations)});this.bind("situation-clicked",function(a){d.logSituationEvent("click",b.situationContext,[a.situation],a.parentSituations)});this.bind("stations-shown",function(a){d.logStationEvent("impression",b.situationContext,a.stations,a.parentSituations)});this.bind("station-clicked",
function(a){d.logStationEvent("click",b.situationContext,[a.station],a.parentSituations)});this.bind("station-auto-start",function(a){d.logStationEvent("station-auto-start",b.situationContext,[a.station],a.parentSituations)});a.bind("app-unload",function(){d.sendEvents()})},initializeSituationContext:function(){var b=this;this.situationContext=new a.SituationContext({device:"web",site:e.site});f.getInstance().getVisitor().get("is_admin")&&this.situationContext.set({optimizer:"user"});this.situationContext.bind("change",
function(){b.trigger("context-changed",{day:b.situationContext.get("day"),period:b.situationContext.get("period")})});this.trigger("context-changed",{day:this.situationContext.get("day"),period:this.situationContext.get("period")})},targetOptions:function(a){var a=a||{},b={current_date:this.situationContext.get("current_date"),site:this.situationContext.get("site"),device:this.situationContext.get("device"),day:this.situationContext.get("day"),period:this.situationContext.get("period"),optimizer:this.situationContext.get("optimizer"),
style:"flat-220",max_situations:5,max_stations:3};if(a.situation_id)b.situation_id=a.situation_id;return b},handleConciergePath:function(b){b=b||"";this.activeView()&&this.activeView().getPath()===b||(this.previousView()&&this.previousView().getPath()===b?this.popView_safe():this.rootView()&&this.rootView().getPath()===b?this.popView_backToRoot():b===""?this.addViewAndBind(new i({top:this,situationContext:this.situationContext}),{leave_history_alone:!0}):(b=a.Situation.parsePath(b))&&this.renderSituationId(b.situation_oid,
b.parent_situation_oid))},renderSituationId:function(b,c){var d=this,g,h,i;if(this.activeView()&&this.activeView().collection&&(g=this.activeView().collection.get(b),c&&this.activeView().situation&&this.activeView().situation.get("id")==c))h=this.activeView().situation;i=function(a,b){a&&(b?d.renderSituation(a,[b]):d.renderSituation(a))};g?i(g,h):c?a.Situation.getTargeted(this.targetOptions({situation_id:c}),{success:function(a){i(a.get("situations").get(b),a)}}):a.Situation.getTargeted(this.targetOptions({situation_id:b}),
{success:i})},renderSituation:function(a,b){this.addViewAndBind(a.get("station_ids").length>0?new k({top:this,situation:a,parentSituations:b}):new l({top:this,situation:a,parentSituations:b}))},handleSituationClick:function(a){this.renderSituation(a.situation,a.parentSituations)},handleStationClick:function(){},handleBack:function(){this.previousView()&&window.history.back()}},{BROADCAST_EVENTS:["situations-shown","situation-clicked","stations-shown","station-clicked","station-auto-start","context-changed"]}),
h=g.extendViewClass(d.Subview).extend({css:"concierge-view",initialize:function(a){h.__super__.initialize.call(this,a);a=a||{};this.top=a.top},render:function(){return h.__super__.render.call(this)},situationChain:function(){return[]},pop:function(){var a=$.Deferred();this.$el.bind("transitionend",function(){a.resolve()});this.$el.removeClass("rendered");return a},hide:function(){var a=$.Deferred();this.$el.bind("transitionend",function(){a.resolve()});this.$el.addClass("pushed-to-back");return a},
show:function(){var a=this,b=$.Deferred();this.$el.bind("transitionend",function(){b.resolve()});setTimeout(function(){a.$el.hasClass("rendered pushed-to-back")?a.$el.removeClass("pushed-to-back"):a.$el.addClass("rendered")},0);return b}}),i=h.extend({template:sz.tmpl.concierge.situations,modelTemplate:sz.tmpl.concierge.situation,ignore_history:!0,elements:{".concierge-situations":"collectionContainerEl"},events:{"dblclick .concierge-situation-directive":"handleDirectiveClick","click .concierge-situation":"handleClick"},
handleDirectiveClick:function(){this.situationContext.set("period",(this.situationContext.get("period")+1)%6)},initialize:function(a){i.__super__.initialize.call(this,a);this.situationContext=a.situationContext;this.fetchSituations();this.bindToSituationContextChange()},bindToSituationContextChange:function(){var a=this;this.situationContext.bind("change",function(){a.hide();a.fetchSituations();a.fetch_promise.then(function(){a.render();a.show()})})},fetchSituations:function(){var b=this;this.fetch_promise=
a.Situation.getTargeted(this.top.targetOptions(),{success:function(a){b.collection.reset(a.models)}}).promise()},context:function(){var a=i.__super__.context.call(this);return a=_.extend(a,{context_label:this.situationContext.title()})},hide:function(){return i.__super__.hide.call(this)},show:function(){i.__super__.show.call(this);var a=this;return this.fetch_promise.then(function(){a.trigger("situations-shown",{situations:a.modelList(),parentSituations:a.situationChain()})})},getPath:function(){return""},
handleClick:function(a){this.trigger("situation-clicked",{situation:this.collection.get($(a.currentTarget).attr("data-sz-model-id")),parentSituations:this.situationChain()})}}),l=h.extend({template:sz.tmpl.concierge.filters,modelTemplate:sz.tmpl.concierge.filter,elements:{".concierge-filters":"collectionContainerEl"},events:{"click .concierge-filter":"handleClick"},initialize:function(a){l.__super__.initialize.call(this,a);a=a||{};this.situation=a.situation;this.parentSituations=a.parentSituations||
[];this.collection.reset(this.situation.get("situations").models)},situationChain:function(){var a=this.parentSituations.slice();a.push(this.situation);return a},context:function(){var a=i.__super__.context.call(this);return a=_.extend(a,{selected_message:this.situation.get("selected_message")})},hide:function(){return l.__super__.hide.call(this)},show:function(){var a=l.__super__.show.call(this);this.trigger("situations-shown",{situations:this.modelList(),parentSituations:this.situationChain()});
return a},getPath:function(){if(this.situation){var a=this.parentSituations?this.parentSituations[this.parentSituations.length-1]:null;return this.situation.toPath({situationContext:this.top.situationContext,parentSituationId:a&&a.get("id")})}return""},handleClick:function(a){this.trigger("situation-clicked",{situation:this.collection.get($(a.currentTarget).attr("data-sz-model-id")),parentSituations:this.situationChain()})}}),k=h.extend({template:sz.tmpl.concierge.playlists,modelTemplate:sz.tmpl.concierge.playlist,
events:{"click .concierge-playlist":"handleClick"},elements:{".concierge-playlist":"playlistEls"},initialize:function(a){var b=this;k.__super__.initialize.call(this,a);a=a||{};this.situation=a.situation;this.parentSituations=a.parentSituations||[];this.bind("station-clicked",function(a){b.updatePlayingState(a.station.cid)});this.fetchStations()},fetchStations:function(){var b=this;this.fetch_promise=a.Station.getBatch(this.situation.get("station_ids"),{success:function(a){b.collection.reset(a.models)}}).promise()},
situationChain:function(){var a=this.parentSituations.slice();a.push(this.situation);return a},stationIsPlaying:function(a){var b=f.getInstance().getPlayer(),b=b&&b.model&&b.model.get("station");if(!b)return!1;return a.get("id")==b.get("id")},contextForModel:function(a){var b=k.__super__.contextForModel.call(this,a);b.cover_url=a.getCoverUrl({size:400,style:"three-by-two-flush"});b.featured_artists_label=a.featured_artists_label();b.is_playing=this.stationIsPlaying(a);window.__awkward_workaround_situations=
window.__awkward_workaround_situations||{};window.__awkward_workaround_situations[a.get("id")]=this.situationChain();return b},context:function(){var a=i.__super__.context.call(this);return a=_.extend(a,{selected_message:this.situation.get("selected_message")})},renderCollection:function(){if(this.collection.length!=0){var a=this;_.each([{css:".concierge-playlists-now-playing",models:[this.collection.models[0]]},{css:".concierge-playlists-also-try",models:this.collection.models.slice(1)}],function(b){var c=
a.$el.find(b.css);_.each(b.models,function(b){var d=a.idForModel(b),b=$(a.modelTemplate({model:a.contextForModel(b)}));d&&b.attr("data-sz-model-id",d);c.append(b)})})}},hide:function(){return k.__super__.hide.call(this)},show:function(){k.__super__.show.call(this);var b=this;return this.fetch_promise.then(function(){a.StationCache.set(b.collection.models.map(function(a){return a.toJSON()}));b.trigger("stations-shown",{stations:b.modelList(),parentSituations:b.situationChain()});if(!Modernizr.audio_requires_user_interaction){var c=
f.getInstance();if(!c.player||!c.player.isPlaying())b.trigger("station-auto-start",{station:b.collection.at(0),parentSituations:b.situationChain()}),c.startStation(b.collection.at(0),{situations:b.situationChain()})}})},getPath:function(){if(this.situation){var a=this.parentSituations?this.parentSituations[this.parentSituations.length-1]:null;return this.situation.toPath({situationContext:this.top.situationContext,parentSituationId:a&&a.get("id")})}return""},playlistElForCid:function(a){return $(".concierge-playlist[data-sz-model-id="+
a+"]")},updatePlayingState:function(a){this.playlistEls().removeClass("playing");this.playlistElForCid(a).addClass("playing")},handleClick:function(a){this.trigger("station-clicked",{station:this.collection.get($(a.currentTarget).attr("data-sz-model-id")),parentSituations:this.situationChain()})}});return b});define("bklyn/songza/views/background-gradients",["songza/base","songza/models"],function(f,e){return{wrapperElCss:"#body-backgrounds",gradients:["morning","late-morning","afternoon","evening","night","late-night"],setBackgroundByPeriod:function(b){this.setBackground(this.gradients[b])},setBackgroundByCurrentPeriod:function(){this.setBackgroundByPeriod((new e.SituationContext).get("period"))},setBackground:function(b){$(this.wrapperElCss).find(".body-background.rendered.out").detach();var a=$(this.wrapperElCss).find(".body-background"),
c=$("<div class='body-background "+b+"'></div>");$(this.wrapperElCss).append(c);setTimeout(function(){c.addClass("rendered");a.addClass("out")},0)},_shuffled_bg:Math.floor(6*Math.random()),shuffleBackground:function(){this._shuffled_bg=(this._shuffled_bg+1)%this.gradients.length;this.setBackgroundByPeriod(this._shuffled_bg)}}});define("bklyn/songza/views/recent-stations",["songza/app","songza/base"],function(f,e){var b=e.View.extend({el:"#recent-playlists-wrapper",template:sz.tmpl.recent.recent_stations,initialize:function(a){b.__super__.initialize.call(this,a);this.app=a.app},context:function(){var a={recent_stations:[]};this.app&&!this.app.visitor.isAnonymous()&&(a.recent_stations=this.app.visitor.get("recent").toJSON().slice(0,5));return a},render:function(){b.__super__.render.call(this);f.getInstance().enhanceDOM(this.el)}});
return b});define("bklyn/songza/views/view-stack",["songza/base"],function(f){var e={};e.Base=f.View.extend({initialize:function(b){e.Base.__super__.initialize.call(this,b);this.views=[]},addView:function(b){var a=this,c=$.Deferred();if(this.activeView()){var d=this.activeView();d.hide().then(function(){d.$el.addClass(a.inactive_view_css)})}this.views.push(b);this.syncHistory();this.viewsEl().append(b.render().el);b.show().then(function(){c.resolve()});return c},popView_backToRoot:function(){for(;this.views.length>
1;)this.popView()},popView_safe:function(){return this.views.length>1?this.popView():!1},popView:function(){var b=$.Deferred();if(!this.activeView())return _.delay(function(){b.resolve()},1),b;var a=this.activeView();this.views.pop();var c=this.activeView();this.syncHistory();a.pop().then(function(){a.destroy()});c?(c.$el.removeClass(this.inactive_view_css),c.show().then(function(){b.resolve()})):b.resolve();return b},activeView:function(){if(this.views.length==0)return null;return this.views[this.views.length-
1]},previousView:function(){if(this.views.length<2)return null;return this.views[this.views.length-2]},rootView:function(){if(this.views.length==0)return null;return this.views[0]},syncHistory:function(){this.setState("has_history",this.views.length>1)},render:function(){e.Base.__super__.render.call(this);this.activeView()&&this.viewsEl().append(this.activeView().render().el);return this},pop:function(){return this.hide()},hide:function(){return $.Deferred().resolve()},show:function(){return $.Deferred().resolve()}});
e.Subview=f.View.extend({getPath:function(){return""},hide:function(){return $.Deferred().resolve()},show:function(){return $.Deferred().resolve()}});return e});define("bklyn/songza/views/view-collection-mixin",["songza/base"],function(){return{extendViewClass:function(f){return f.extend({collection:null,initialize:function(e){f.__super__.initialize.call(this,e);e=e||{};this.collection=e.collection?e.collection:new Backbone.Collection([]);this.collection.bind("reset",this.renderCollection,this);this.collection.bind("add",this.renderCollection,this);this.collection.bind("remove",this.renderCollection,this);this.collection.bind("change",this.renderCollection,
this)},modelList:function(){return this.collection.models},contextForModel:function(e){return e.toJSON?e.toJSON():e},idForModel:function(e){return e.cid||e.id},renderCollection:function(){var e=this,b=this.collectionContainerEl(),a=this.modelList();b.empty();_.each(a,function(a){var d,g;d={model:e.contextForModel(a)};g=e.idForModel(a);d=$(e.modelTemplate(d));g&&d.attr("data-sz-model-id",e.idForModel(a));b.append(d)})},render:function(){f.__super__.render.call(this);this.renderCollection();return this}})}}});define("songza/app",["bklyn/songza/app"],function(f){return f});define("songza/player/view",["bklyn/songza/views/player"],function(f){return f});define("songza/app/basic",["songza/base"],function(f){var e,b=[],a=[],c=!1;if(!window.console)window.console={};if(!window.console.log)window.console.log=function(){};var d=f.Class.extend({initialize:function(a){var b=this;this.visitor=a.visitor;this.config=a.config||{};this.plugins=a.plugins||[];this.config.debug&&console&&console.log&&this.bind("all",function(a,b){console.log("songza-app: ["+a+"]",b)});$(window).bind("beforeunload",function(){b.trigger("app-unload")})},start:function(){this.loadPlugins()},
getConfig:function(){return this.config},getVisitor:function(){return this.visitor},setVisitor:function(a){var b=this.visitor;if(a.get("id")!==b.get("id"))this.visitor=a,this.trigger("visitor-change",{oldVisitor:b,newVisitor:a})},reloadApplication:function(){window.location.reload(!0)},refresh:function(){Backbone.History&&Backbone.History.started?Backbone.history.loadUrl(Backbone.history.getFragment()):window.location.reload()},bind:Backbone.Events.bind,unbind:Backbone.Events.unbind,trigger:function(a,
b){b=b||{};b.eventTime=new Date;b.eventName=a;Backbone.Events.trigger.call(this,a,b)},loadPlugins:function(){function b(){(c=_.reduce(_.values(h),function(a,b){return a&&b}))&&_.each(a,function(a){a()})}var e=this,h={};_.each(this.plugins,function(a){h[a]=!1});_.each(this.plugins,function(a){require([a],function(c){h[a]=!0;try{e.getConfig().debug&&console.log("Loading plugin",a,c),c.register(d)}catch(f){console.log("Failed to load plugin: "+a,c,f)}b()})})}},{addDOMEnhancement:function(a){b.push(a);
a($("body"))},enhanceDOM:function(a){_.each(b,function(b){try{b(a)}catch(c){console.log("Failed to apply enhancement",c)}})},initialize:function(a,b,c){e=new d({visitor:a,config:b,plugins:c});e.start()},getInstance:function(){if(!e)throw Error("Application instance has not been created. Perhaps you forgot to call App.init first?");return e},postInit:function(b){c?b():a.push(b)}});return d});define("songza/song-sample",["songza/base","songza/player/cores/sm"],function(f,e){var b={},a=b.SongSampleView=f.View.extend({template:_.template('<div class="szi-toggle">Toggle</div>'),css:"sz-song-sample",elements:{".szi-toggle":"toggleEl"},events:{"click .szi-toggle":"toggle"},states:{playing:{set:!1,onCss:"sz-song-sample-playing"},paused:{set:!0,onCss:"sz-song-sample-paused"}},initialize:function(b){a.__super__.initialize.call(this,b);this.song=b.song;this.fetching=!1;this.core=null},start:function(){if(!this.core&&
!this.fetching)this.fetching=!0,this.song.getSampleUrl({success:function(a){self.fetching=!1;self.core=new e.SMPlayerCore({});self.core.playSong(a.sample_url,"aac")},error:function(){self.fetching=!1}})},toggle:function(){this.core?(this.core.isPlaying(),this.core.pause()):this.start()}});return b});define("songza/base",function(){var f={};f.Class=Toolbox.Base.extend({constructor:function(b){this.initialize(b)},initialize:function(b){this._plugins=b.plugins||[];this._initPlugins()},_getPlugins:function(){return this._plugins.splice()},_initPlugins:function(){var b=this;_.each(this._getPlugins(),function(a){a=new a({host:b});b[a.namespace]=a})},plug:function(b){this._plugins.push(b)},bind:Backbone.Events.bind,on:Backbone.Events.on,unbind:Backbone.Events.unbind,off:Backbone.Events.off,trigger:Backbone.Events.trigger});
f.Class.extend=function(b,a){var c=Toolbox.Base.extend.call(this,b,a);_.extend(c,{_plugins:[],plug:function(a){c._plugins.push(a)},getPlugins:function(){for(var a=[];c;){a=a.concat(c._plugins);break}return a}});return c};var e={create:"POST",update:"POST","delete":"DELETE",read:"GET"};f.Model=Backbone.Model.extend({sync:function(b,a,c){c=_.extend({type:e[b],dataType:"json",processData:!0},c);if(!c.url){var d;d=!a||!a.url?null:_.isFunction(a.url)?a.url():a.url;c.url=d||urlError()}if(!c.data&&a&&(b==
"create"||b=="update")){c.contentType="application/x-www-form-urlencoded";var g,b=a.toJSON(),j=[];for(g in b){a=_.isArray(b[g])?b[g]:[b[g]];for(d=0;d<a.length;d++)j.push(encodeURIComponent(g)+"="+encodeURIComponent(a[d]))}g=j.join("&");c.data=g}return $.ajax(c)}});f.Plugin=Toolbox.Base.extend({namespace:"plugin",constructor:function(b){this.initialize(b)},initialize:function(b){this.host=b.host}});f.View=Backbone.View.extend({initialize:function(b){_.bindAll(this,"sync","render");this._state={};this.bind("stateChange",
this.sync);this._bindElements();this.options=this.options||b||{}},_bindElements:function(){var b=this,a;if(this.elements)for(a in this.elements)this[this.elements[a]]=function(a){return function(){return b.$(a)}}(a)},$:function(b){return $(b,this.el)},getDefaultState:function(b){var a=this.states;if(a&&a.hasOwnProperty(b))return a[b].set;throw Error("Unrecognized state: "+b);},getState:function(b){if(this._state.hasOwnProperty(b))return this._state[b];return this.getDefaultState(b)},setState:function(b,
a){this._state[b]=a;this.trigger("stateChange",b,a)},sync:function(){var b,a,c,d=$(this.el),g=this.states;this.css&&(d.hasClass(this.css)||d.addClass(this.css));for(b in g)a=this.getState(b),c=g[b],c.onCss&&d.removeClass(c.onCss),c.offCss&&d.removeClass(c.offCss),d.addClass(a?c.onCss:c.offCss)},context:function(){return{}},render:function(){$(this.el).html(this.template(this.context()));this.sync();return this},destroy:function(){$(this.el).detach()}});return f});define("songza/site-views",["songza/config","songza/base","songza/hashsignal","songza/utils"],function(f,e,b,a){var c={};c.Default=e.View.extend({el:"#body-delegate",elements:{"#player":"$player"},events:{"click  a":"onAnchorClick","submit form":"onFormSubmit"},initialize:function(a){c.Default.__super__.initialize.call(this,a);_.bindAll(this,"startSpinner","stopSpinner");this.app=a.app;this.stationNavigationContext=this.errorFrame=this.spinner=this.spinnerTimeout=null;this.app.bind("page-navigate-start",
this.startSpinner);this.app.bind("page-navigate",this.stopSpinner);this.app.bind("page-navigate-failure",this.stopSpinner);$(this.el).tooltip({selector:".sz-tooltip"})},startSpinner:function(){var a=this;this.stopSpinner();this.spinnerTimeout=setTimeout(function(){var b=(new Spinner({lines:12,length:7,width:2,radius:3,color:"#888",speed:1,trail:50,shadow:!1})).spin();$(b.el).css("position","fixed");$(b.el).css("bottom","30px");$(b.el).css("right","30px");$("body").append(b.el);a.spinnerTimeout=null;
a.spinner=b},f.timeouts.pageNavigateProgress)},stopSpinner:function(){this.spinnerTimeout&&clearTimeout(this.spinnerTimeout);if(this.spinner)this.spinner.stop(),$(this.spinner.el).detach(),this.spinner=null},showErrorDocument:function(a){var b=$('<iframe src="javascript:0">').addClass("sz-error-page"),a=$($.trim(a));this.errorFrame&&this.errorFrame.detach();b.css("min-height",$(this.el).outerHeight());$(this.el).append(b);b.contents().find("html").empty().append(a);this.errorFrame=b},updateContent:function(a){var c=
this;this.errorFrame&&this.errorFrame.detach();b.replaceBlocks(a,!1,function(a){_.each(a,function(a){c.app.trigger("dom-node-inserted",{node:a})})});$(document).scrollTop()>150&&$("html,body").animate({scrollTop:0})},setStationNavigationContext:function(a,b){this.stationNavigationContext={stationId:a,contextName:b}},getStationNavigationContext:function(a){if(this.stationNavigationContext&&this.stationNavigationContext.stationId===a)return this.stationNavigationContext.contextName;return"Unknown"},
onAnchorClick:function(b){var c=$(b.currentTarget),e=c.attr("href"),h=null,i=null,h=null;if($(this.el).attr("data-sz-no-route")!==void 0)return!0;if(!e||c.attr("data-sz-no-route")!==void 0)return!0;if(c.attr("target")!==void 0)return!0;c.attr("data-sz-station-id")!==void 0&&(i=parseInt(c.attr("data-sz-station-id"),10),h=c.parents(".sz-station-context").attr("data-sz-station-context-name"),this.setStationNavigationContext(i,h||"Unknown"));if(e.match(/^\s*http[s]?/i))if(h=parseUri(e),h.protocol!=window.location.protocal&&
h.host!=window.location.host)return!0;else i=h.path,h.query&&(i+="?"+h.query);else if(e.match(/^\s*javascript:/i))return!0;else if(e.match(/^\s*mailto:/i))return!0;else if(e==="#")return!1;else i=e;b.preventDefault();i[0]==="/"&&(i=i.substring(1));h=c.attr("data-sz-add-next");h!==void 0&&(i+="?"+a.formQuery({next:h?h:"/"+Backbone.history.getFragment()}));Backbone.history.navigate(i,!0);return!1},onFormSubmit:function(a){var a=$(a.currentTarget),b=(a.attr("method")||"GET").toUpperCase(),c=a.attr("action");
if(a.attr("data-sz-no-route")!==void 0)return!0;if(a.attr("enctype")!==void 0)return!0;if(!c||c.match(/^\s*http[s]?/))return!0;c.match(/\//)&&(c=c.substr(1));if(b==="GET")return Backbone.history.navigate(c+"?"+a.serialize(),!1),this.app.router.getAndInjectContent(c+"?"+a.serialize()),!1;else if(b==="POST")return Backbone.history.navigate(c,!1),this.app.router.postAndInjectContent(c,a.serialize()),!1}});return c});define("songza/situation-viewer",["songza/base","songza/models","songza/utils","songza/config","songza/model-config","songza/app","songza/situation-tracker"],function(f,e,b,a,c,d,g){function j(a,b){var c;$(b).find(a).each(function(){var a;a:{a=$(this);a.wrapInner("<div/>");for(var b=a.find("div")[0],d=a.height(),g=a.width(),h=b.scrollHeight,e=b.scrollWidth,i=parseInt(a.css("font-size"),10),j=0;h>d||e>g;){j+=1;if(j>50){a=14;break a}i=parseInt(a.css("font-size"),10)-2;a.css("font-size",i);h=b.scrollHeight;
e=b.scrollWidth}a=i}if(!c||a<c)c=a});$(b).find(a+" div").each(function(){$(this).css("font-size",c)})}var h={},i=[{url:a.static_url+"images/sites/"+a.site+"/dayparts/morning.png",periods:[0]},{url:a.static_url+"images/sites/"+a.site+"/dayparts/late-morning.png",periods:[1]},{url:a.static_url+"images/sites/"+a.site+"/dayparts/afternoon.png",periods:[2]},{url:a.static_url+"images/sites/"+a.site+"/dayparts/evening.png",periods:[3]},{url:a.static_url+"images/sites/"+a.site+"/dayparts/night.png",periods:[4]},
{url:a.static_url+"images/sites/"+a.site+"/dayparts/late-night.png",periods:[5]}],l=h.Wizard=f.View.extend({template:sz.tmpl.situation.wizard,css:"sz-situation-wizard",elements:{".szi-background":"backgroundEl",".szi-views":"viewsEl"},events:{"click .szi-back":"handleBack"},states:{collapsed:{set:!1,onCss:"sz-situation-wizard-collapsed"},has_history:{set:!1,onCss:"sz-situation-wizard-has-history"}},initialize:function(b){l.__super__.initialize.call(this,b);_.bindAll(this,"handleSituationsShown","handleSituationClick",
"handleStationsShown","handleStationClick","handlePeriodChange");this.situationContext=new e.SituationContext({device:"web",site:a.site});this.situationContext.bind("change:period",this.handlePeriodChange);this.background=this.backgroundForContext();this.views=[];this.user=d.getInstance().getVisitor();this.user.get("is_admin")&&this.situationContext.set({optimizer:"user"});if(b.collapsed){if(this.setState("collapsed",!0),this.views.push(this.collapsedContextView()),b&&b.collapsed_message)this.collapsedContextView().options.collapsed_message=
b.collapsed_message}else this.views.push(this.fullContextView());this.bindToApp(d.getInstance());this.initializeTracker(d.getInstance())},bindToApp:function(a){var b=this;_.each(["situations-shown","situation-clicked","stations-shown","station-clicked"],function(c){b.bind(c,function(b){a.trigger("concierge-"+c,b)})});this.bind("station-clicked",function(b){a.startStation(b.station,{situations:b.parentSituations});Backbone.history.navigate(b.station.pageUrlPath(),!0)})},initializeTracker:function(a){var b=
new g({app:a});this.tracker=b;this.bind("situations-shown",function(a){b.logSituationEvent("impression",a.context,a.situations,a.parentSituations)});this.bind("situation-clicked",function(a){b.logSituationEvent("click",a.context,[a.situation],a.parentSituations)});this.bind("stations-shown",function(a){b.logStationEvent("impression",a.context,a.stations,a.parentSituations)});this.bind("station-clicked",function(a){b.logStationEvent("click",a.context,[a.station],a.parentSituations)})},collapsedContextView:function(){var a=
this;if(!this._collapsedContextView)this._collapsedContextView=new o({context:this.situationContext,user:this.user}),this._collapsedContextView.bind("go",function(){a.handleGo()});return this._collapsedContextView},fullContextView:function(){if(!this._fullContextView)this._fullContextView=new q({situationContext:this.situationContext,user:this.user}),this._fullContextView.bind("situation-clicked",this.handleSituationClick),this._fullContextView.bind("situations-shown",this.handleSituationsShown);
return this._fullContextView},handleSituationsShown:function(a,b){this.trigger("situations-shown",{context:this.situationContext,situations:a,parentSituations:b})},handleSituationClick:function(a,b){var c;a.get("station_ids").length>0?(c=new t({situation:a,parentSituations:b}),c.bind("station-clicked",this.handleStationClick),c.bind("stations-shown",this.handleStationsShown)):(c=new r({situation:a,parentSituations:b}),c.bind("situation-clicked",this.handleSituationClick),c.bind("situations-shown",
this.handleSituationsShown));this.trigger("situation-clicked",{context:this.situationContext,situation:a,parentSituations:b});this.addView(c)},handleStationsShown:function(a,b){this.trigger("stations-shown",{context:this.situationContext,stations:a,parentSituations:b})},handleStationClick:function(a,b){this.trigger("station-clicked",{context:this.situationContext,station:a,parentSituations:b})},addView:function(a){var b=this,c=$.Deferred(),d=function(){b.viewsEl().children().addClass("szi-view-inactive");
b.views.push(a);b.syncHistory();b.viewsEl().append(a.render().el);a.show().then(function(){c.resolve()})};this.activeView()?this.activeView().hide().then(d):d();return c},popView:function(){var a=this,b=$.Deferred();if(!this.activeView())return _.delay(function(){b.resolve()},1),b;this.activeView().hide().then(function(){a.views.pop().destroy();a.viewsEl().children().last().removeClass("szi-view-inactive");a.syncHistory();a.activeView()?a.activeView().show().then(function(){b.resolve()}):b.resolve()});
return b},activeView:function(){if(this.views.lenght==0)return null;return this.views[this.views.length-1]},syncHistory:function(){this.setState("has_history",this.views.length>1)},handleGo:function(){var a=this;$(this.el).animate({height:"410px"},"fast",function(){a.setState("collapsed",!1);a.popView().then(function(){a.addView(a.fullContextView())})})},handleBack:function(){this.views.length>1&&this.popView()},backgroundForContext:function(){var a=this.situationContext.get("period");return _.find(i,
function(b){return _.contains(b.periods,a)})},handlePeriodChange:function(){this.backgroundForContext()!==this.background&&this.updateBackground()},updateBackground:function(){var a=this,b=this.backgroundForContext(),c=new Image;c.onload=function(){a.background=b;a.doUpdateBackground()};c.src=b.url},doUpdateBackground:function(){var a=this.backgroundEl(),b=$("<div>"),c=a.children().first();a.append(b);c.addClass("szi-previous").removeClass("szi-current");b.addClass("szi-current").css("opacity",0).css("background-image",
"url("+this.background.url+")");c.animate({opacity:0},"slow",function(){c.detach()});b.animate({opacity:1},"slow")},render:function(){l.__super__.render.call(this);this.activeView()&&this.viewsEl().append(this.activeView().render().el);return this},show:function(){var a=this;this.updateBackground();this.activeView()&&_.delay(function(){a.activeView().show()},400)}}),k=function(){var a=$.Deferred();$(this.el).animate({opacity:0},"fast",function(){a.resolve()});return a},n=function(){var a=$.Deferred();
$(this.el).animate({opacity:1},"fast",function(){a.resolve()});return a},m=function(){var a=$.Deferred(),b=this.collectionContainerEl().find("li");b.css("opacity",0);b.each(function(a,b){$(b).delay(300*a).animate({opacity:1},"slow","swing")});_.delay(function(){a.resolve()},b.length*300);return a},p=h.ContextEditor=f.View.extend({template:sz.tmpl.situation.contextEditor,elements:{".szi-day select":"dayFilter",".szi-time-period select":"timeFilter",".szi-optimizer select":"optimizerFilter",".szi-device select":"deviceFilter"},
events:{"click .szi-go":"handleGo"},handleGo:function(){var a;if(this.timeFilter().length&&this.dayFilter().length){a={day:parseInt(this.dayFilter().val(),10),period:parseInt(this.timeFilter().val(),10)};if(this.options.user.get("is_admin"))a.optimizer=this.optimizerFilter().val(),a.device=this.deviceFilter().val();this.options.context.set(a)}this.trigger("go")},context:function(){var a=p.__super__.context.call(this);return a=_.extend(a,{device_options:c.situation.devices,device_choice:this.options.context.get("device"),
dow_options:c.situation.dow,dow_choice:this.options.context.get("day"),time_options:c.situation.time_periods,time_choice:this.options.context.get("period"),optimizer_options:[{value:"editor",label:"Will of the Editors"},{value:"anonymous",label:"Will of the People"},{value:"user",label:"Thy Own Destiny"}],optimizer_choice:this.options.context.get("optimizer"),is_admin:this.options.user.get("is_admin")})}}),o=h.CollapsedContextView=f.View.extend({css:"sz-situation-collapsed-context",template:sz.tmpl.situation.collapsedContext,
elements:{".sz-context-editor-toggle":"$contextEditorToggle",".sz-context-editor":"$contextEditor"},events:{"click .sz-context-editor-toggle":"toggleEditor","click .szi-go":"handleGo"},initialize:function(a){var b=this;o.__super__.initialize.call(this,a);this.contextEditor=new p({context:this.options.context,user:this.options.user});this.contextEditor.bind("go",function(){b.handleGo()});$("body").click(function(a){var c=b.$contextEditorToggle().get(0);a.target==c||$.contains(c,a.target)||$.contains(b.$contextEditor().get(0),
a.target)||b.hideEditor()})},toggleEditor:function(){this.$contextEditor().hasClass("sz-context-editor-shown")?this.$contextEditor().removeClass("sz-context-editor-shown"):(this.$contextEditor().addClass("sz-context-editor-shown"),this.$contextEditor().position({my:"right top",at:"right bottom",of:this.$contextEditorToggle(),collision:"none"}))},hideEditor:function(){this.$contextEditor().removeClass("sz-context-editor-shown")},handleGo:function(){this.hideEditor();this.trigger("go")},context:function(){var a=
{context_label:this.options.context.title()};if(this.options.collapsed_message)a.collapsed_message=this.options.collapsed_message;return a},render:function(){o.__super__.render.call(this);this.$contextEditor().append(this.contextEditor.render().el);return this},hide:k,show:n}),q=h.FullContextView=b.SimpleCollectionView.extend({template:sz.tmpl.situation.startingContext,modelTemplate:sz.tmpl.situation.situationItem,css:"sz-situation-starting-context",elements:{".szi-list":"collectionContainerEl",".sz-context-editor-toggle":"$contextEditorToggle",
".sz-context-editor":"$contextEditor"},events:{"click .sz-context-editor-toggle":"toggleEditor","click  .szi-list ul > li":"handleClick"},states:{loading:{set:!0,onCss:"sz-situation-starting-context-loading"}},initialize:function(a){var b=this;a.collection=new Backbone.Collection;a.modelContextName="situation";a.mustFetch=!1;a.useCid=!0;q.__super__.initialize.call(this,a);this.situationContext=a.situationContext;this._shown=!1;this.fetchSituations();$("body").click(function(a){var c=b.$contextEditorToggle().get(0);
a.target==c||$.contains(c,a.target)||$.contains(b.$contextEditor().get(0),a.target)||b.hideEditor()})},toggleEditor:function(){this.$contextEditor().hasClass("sz-context-editor-shown")?this.$contextEditor().removeClass("sz-context-editor-shown"):(this.$contextEditor().addClass("sz-context-editor-shown"),this.$contextEditor().position({my:"right top",at:"right bottom",of:this.$contextEditorToggle(),collision:"none"}))},hideEditor:function(){this.$contextEditor().removeClass("sz-context-editor-shown")},
fetchSituations:function(){var a=this,b;this.setState("loading",!0);b={current_date:this.situationContext.get("current_date"),site:this.situationContext.get("site"),device:this.situationContext.get("device"),day:this.situationContext.get("day"),period:this.situationContext.get("period"),optimizer:this.situationContext.get("optimizer"),max_situations:5,max_stations:3};e.Situation.getTargeted(b,{success:function(b){a.collection.reset(b.models);a.setState("loading",!1);a.showItems()}})},handleClick:function(a){this.trigger("situation-clicked",
this.collection.getByCid($(a.currentTarget).attr("data-sz-model-id")),[])},context:function(){var a=q.__super__.context.call(this);return a=_.extend(a,{view_id:this.cid,context_label:this.situationContext.title()})},render:function(){var a=this;q.__super__.render.call(this);this.contextEditor=new p({context:this.options.situationContext,user:this.options.user});this.contextEditor.bind("go",function(){a.$contextEditorToggle().text(a.situationContext.title());a.$contextEditor().removeClass("sz-context-editor-shown");
a.fetchSituations()});this.$contextEditor().empty().append(this.contextEditor.render().el);return this},syncCollectionContainerEl:function(){var a=this;q.__super__.syncCollectionContainerEl.call(this);_.delay(function(){j(".sz-situation-item-noicon .szi-title",a.el)});return this},hide:function(){this._shown=!1;return k.call(this)},show:function(){this._shown=!0;this.showItems();return n.call(this)},showItems:function(){m.call(this);this.collection.models.length>0&&this._shown&&this.trigger("situations-shown",
this.collection.models,[])}}),r=h.SituationView=b.SimpleCollectionView.extend({template:sz.tmpl.situation.situation,modelTemplate:sz.tmpl.situation.situationItem,css:"sz-situation-viewer-context",elements:{".szi-list":"collectionContainerEl"},events:{"click .szi-list ul > li":"handleClick"},initialize:function(a){a.collection=a.situation.get("situations");a.modelContextName="situation";a.mustFetch=!1;a.useCid=!0;r.__super__.initialize.call(this,a);this.parentSituations=a.parentSituations||[];this._triggeredShown=
!1},situationChain:function(){var a=this.parentSituations.slice();a.push(this.options.situation);return a},handleClick:function(a){this.trigger("situation-clicked",this.collection.getByCid($(a.currentTarget).attr("data-sz-model-id")),this.situationChain())},context:function(){var a=r.__super__.context.call(this);return a=_.extend(a,{view_id:this.cid,situation:this.options.situation.toJSON(),situation_chain:_.map(this.situationChain(),function(a){return a.toJSON()})})},syncCollectionContainerEl:function(){var a=
this;r.__super__.syncCollectionContainerEl.call(this);_.defer(function(){j(".sz-situation-item-noicon .szi-title",a.el)});return this},hide:k,show:function(){this.showItems();return n.call(this)},showItems:function(){m.call(this);this.collection.models.length&&this.trigger("situations-shown",this.collection.models,this.situationChain())}}),t=h.SituationStationView=b.SimpleCollectionView.extend({template:sz.tmpl.situation.situation,modelTemplate:sz.tmpl.situation.stationItem,css:"sz-situation-station",
elements:{".szi-list":"collectionContainerEl"},events:{"click .szi-list ul > li":"handleClick"},states:{loading:{set:!0,onCss:"sz-situation-station-loading"}},initialize:function(a){a.collection=new Backbone.Collection;a.modelContextName="station";a.mustFetch=!1;a.useCid=!0;t.__super__.initialize.call(this,a);this.parentSituations=a.parentSituations||[];this._shown=!1;this.fetchStations()},situationChain:function(){var a=this.parentSituations.slice();a.push(this.options.situation);return a},fetchStations:function(){var a=
this;this.setState("loading",!0);e.Station.getBatch(this.options.situation.get("station_ids"),{success:function(b){a.collection.reset(b.models);a.setState("loading",!1);a.showItems()}})},handleClick:function(a){this.trigger("station-clicked",this.collection.getByCid($(a.currentTarget).attr("data-sz-model-id")),this.situationChain())},context:function(){var a=t.__super__.context.call(this);return a=_.extend(a,{view_id:this.cid,situation:this.options.situation.toJSON(),situation_chain:_.map(this.situationChain(),
function(a){return a.toJSON()})})},hide:function(){this._shown=!1;return k.call(this)},show:function(){this._shown=!0;this.showItems();return n.call(this)},showItems:function(){m.call(this);this.collection.models.length>0&&this._shown&&this.trigger("stations-shown",this.collection.models,this.situationChain())}});return h});define("songza/dom-enhancements/active-module",["songza/config","songza/utils"],function(f,e){function b(){var a=e.currentPath(),b="";a.indexOf("/popular/")===0?b="charts":a.indexOf("/discover/")===0?b="discover":a==="/"&&(b="concierge");$("body").attr("data-sz-module",b)}return{register:function(a){a.getInstance().bind("page-navigate",b);b()}}});define("songza/dom-enhancements/flash-warning",[],function(){function f(){if(!FlashDetect.installed&&!Modernizr.ios){var e=$(".flash-uninstalled-warning");e.length>0&&e.show()}}return{register:function(e){typeof FlashDetect=="undefined"||typeof Modernizr=="undefined"||(e.getInstance().bind("page-navigate",f),f())}}});define("songza/dom-enhancements/input-placeholder",function(){var f=function(e){$("input",e).each(function(){$(this).placeholder()})};return{register:function(e){e.addDOMEnhancement(f)}}});define("songza/dom-enhancements/station-details-on-hover",["songza/models","songza/utils"],function(){function f(){h&&(h.detach(),g=h=null)}function e(){k=setTimeout(function(){f();k=null},i)}function b(){k&&(clearTimeout(k),k=null)}function a(){l&&(clearTimeout(l),l=null);j=null}function c(a,c){g===a?b():j!==a&&(j=a,l=setTimeout(function(){$.get("/station/"+a+"/details/",function(i){a===j&&(j=null,g=a,h&&f(),h=$("<div>").addClass("sz-station-detail-overlay").append(i),d.enhanceDOM(h),h.css("visibility",
"hidden"),$(d.getInstance().view.el).append(h),i=h,$("body").scrollTop()>c.offset().top-i.height()?i.position({my:"center top",at:"center bottom",of:c,collision:"none"}).addClass("sz-station-details-overlay-bottom"):i.position({my:"center bottom",at:"center top",of:c,collision:"fit"}).addClass("sz-station-details-overlay-top"),h.css("visibility","visible"),h.mouseenter(b),h.mouseleave(e))})},i))}var d,g,j,h,i=200,l,k;return{register:function(b){var g=b.getInstance();d=b;_.each([".sz-station-quilt",
".sz-grid-item"],function(b){$(g.view.el).delegate(b,"mouseenter",function(){var a=$(this),b=parseInt(a.attr("data-sz-station-id"),10);$(this).attr("data-sz-no-hover")!="1"&&c(b,a)});$(g.view.el).delegate(b,"mouseleave",a);$(g.view.el).delegate(b,"mouseleave",e)});g.bind("page-navigate-start",a);g.bind("page-navigate-start",f)}}});define("songza/dom-enhancements/station-pile",function(){function f(a,b){var c,d,g=[],b=b===void 0?5:b;if(!i.hasOwnProperty(a))return[];d=i[a].actors;for(c=0;c<b&&c<d.length;c++)g.push(d[c]);return g}function e(){var e=parseInt((new Date).getTime()/1E3-4*h);a.isAnonymous()?c=j:c!==g&&c===d&&(c=g,e=a.feed({global:0,since:e,limit:100,sort:"time"}),$.when(e).then(function(a){a.items.each(function(a){_.each(a.get("actors"),function(b){var c=a.get("station");i.hasOwnProperty(c.get("id"))||(i[c.get("id")]=
{station:c,actors:[],actor_map:{}});c=i[c.get("id")];c.actor_map.hasOwnProperty(b.get("id"))||(c.actor_map[b.get("id")]=!0,c.actors.push(b))})});l(b.getInstance().view.el)}))}var b,a,c,d=0,g=1,j=2,h=86400,i={},l=function(a){$(".sz-station-pile-placeholder",a).each(function(){var a=$(this),b=parseInt(a.attr("data-sz-station-id"),10),b=f(b);a.empty();e();_.each(b,function(b){var c=$("<img>").attr("src",b.get("images").square),b=$("<a>").attr("title",b.get("display_name")).attr("href","/user/"+b.get("id"));
a.append(b.append(c))})})};return{register:function(g){b=g;a=g.getInstance().getVisitor();c=d;g.getInstance().bind("visitor-change",function(b){a=b.newVisitor;c=d;i={};l(g.getInstance().view.el)});g.addDOMEnhancement(l)}}});define("songza/dom-enhancements/sharing",["songza/sharing"],function(f){var e,b=function(a){$(".sz-share-placeholder",a).each(function(){function a(){var c,j,h;j=e.getInstance().getPlayer();h=e.getSharingSystems();c=f.SharePageItem.forCurrentPage();c=(j=j&&j.shareItem())&&c.get("url")==j.get("url")?j:c;h=new f.Button({shareItem:c,shareSystems:h,app:e.getInstance()});$(b).empty().append(h.render().el)}var b=this;a();e.getInstance().bind("player-song-started",a)})};return{register:function(a){e=a;a.addDOMEnhancement(b)}}});define("songza/dom-enhancements/station-ad-preroll-display",["songza/sites/songza/ad-preroll"],function(f){var e=function(b){$(".sz-station-page",b).each(function(){f.PrerollTransition.setStationEl(this)})};return{register:function(b){b.getInstance();b.addDOMEnhancement(e)}}});define("songza/dom-enhancements/visitor-button",["songza/base","songza/feeds","songza/utils","songza/config"],function(f,e,b){var a,c,d,g,j=f.View.extend({template:sz.tmpl.visitorButton.button,menuTemplate:sz.tmpl.visitorButton.menu,elements:{".szi-unread-count":"unreadCountEl"},events:{"click a":"onButtonClick"},states:{menuShown:{set:!1,onCss:"sz-visitor-button-menu-shown"},unread:{set:!1,onCss:"sz-visitor-button-unread"}},css:"sz-visitor-button",initialize:function(b){var c=this;j.__super__.initialize.call(this,
b);_.bindAll(this,"getFeed","syncUnread","handleBodyClick");this.user=b.user;this.following=b.following;this.followers=b.followers;this.menu=void 0;this.feed=new e.Viewer({itemFetcher:this.getFeed});this.feed.maybeFetch();this.feed.items.bind("reset",this.syncUnread);this.feed.items.bind("add",this.syncUnread);this.feed.items.bind("remove",this.syncUnread);this.feed.bind("marked-all-read",this.syncUnread);this.user.bind("change",this.render);this.following.collection.bind("add",this.render);this.following.collection.bind("remove",
this.render);this.following.collection.bind("reset",this.render);this.following.collection.bind("fetch",this.render);this.followers.collection.bind("add",this.render);this.followers.collection.bind("remove",this.render);this.followers.collection.bind("reset",this.render);this.followers.collection.bind("fetch",this.render);$("body").bind("click",this.handleBodyClick);a.bind("page-navigate",function(){c.toggleMenu(!1)})},handleBodyClick:function(a){this.menu&&this.getState("menuShown")&&!$.contains(this.menu.get(0),
a.target)&&(this.feed.markAllRead(),this.toggleMenu(!1))},getFeed:function(a){var b={global:0,limit:20,sort:"time"};b.since=a?parseInt(a.getTime()/1E3):parseInt((new Date).getTime()/1E3-172800);return this.user.feed(b)},syncUnread:function(){var a=this.feed.unreadCount();this.setState("unread",a>0);this.unreadCountEl().text(a>50?"50+":a)},onButtonClick:function(a){a.preventDefault();a.stopPropagation();this.toggleMenu()},toggleMenu:function(b){var c;if(!this.menu)this.menu=c=$(this.menuTemplate(this.context())),
c.find(".szi-feed").append(this.feed.el),$(a.view.el).append(c);b===void 0&&(b=!this.getState("menuShown"));b?this.menu.show().position({my:"right top",at:"right bottom",of:this.el,collision:"none",offset:"22px 20px"}):this.menu.hide();this.setState("menuShown",b)},context:function(){var a={user:this.user.toJSON(),following_count:this.following.collection.length,follower_count:this.followers.collection.length};this.following.ensureFreshness();this.followers.ensureFreshness();return a}}),h=function(a){$(".sz-visitor-button-placeholder",
a).each(function(){var a=$(this);$("<span>").addClass("szi-unread").text("0");a.empty();if(!c.isAnonymous()){var b=new j({user:c,following:d,followers:g});a.append(b.render().el)}})},i=function(a,h){c=a;d=new b.FreshnessGuarantee({collection:a.get("following"),fetchInterval:h.dataFreshness.following});g=new b.FreshnessGuarantee({collection:a.get("followers"),fetchInterval:h.dataFreshness.followers})};return{register:function(b){a=b.getInstance();i(a.getVisitor(),a.getConfig());b.addDOMEnhancement(h);
a.bind("visitor-change",function(){i(a.getVisitor(),a.getConfig());h(a.view.el)})}}});define("songza/dom-enhancements/station-save",["songza/station-save"],function(f){var e,b=function(a){var b=e.getInstance().getVisitor();$(".sz-station-save-button-placeholder",a).each(function(){var a=$(this),g=a.parents(),e=a.attr("data-sz-station-type"),h=parseInt(a.attr("data-sz-station-id"),10),g=$(a.attr("data-sz-station-save-menu-container"),g[g.length-1]),e=new f.StationSaveButton({user:b,stationId:h,stationType:e,menuContainer:g.get(0)});a.empty().append(e.render().el)})};return{register:function(a){e=
a;a.addDOMEnhancement(b)}}});define("songza/dom-enhancements/comments",function(){var f,e=function(b){var a=f.getInstance().getConfig(),c=f.getCommentProvider(a.comment_provider);$(".sz-comments-placeholder",b).each(function(){var a=$(this);a.empty();c&&c(a)})};return{register:function(b){f=b;b.addDOMEnhancement(e)}}});define("songza/dom-enhancements/station-playing-state",function(){var f,e=function(a){var b=f.getPlayer(),d,g,e;b&&(d=b.model.get("station"),g=b.model.get("current"),e=b.model.get("station").get("id"));$(".sz-station-page",a).each(function(){var a=$(this),i=parseInt(a.attr("data-sz-station-id"),10);a.removeClass("szi-player-state-play");a.removeClass("szi-player-state-pause");a.removeClass("szi-player-state-starting");if(i===e&&(a.addClass("szi-player-state-"+b.model.get("playState")),a.hasClass("sz-station-page")))if(i=
g&&g.get("image_url")?g.get("image_url"):d.get("cover_url"),a.find(".szi-station-quilt-image img").attr("src",i),g){i=$("<span>");i.append($("<span>").addClass("szi-song").text(g.get("title")));if(g.get("artist"))if(i.append($("<span>").addClass("szi-artist").text(" by ")),g.get("artist_id")){var f=$("<a>").attr("href","/artist/"+g.get("artist_id")+"/").text(g.get("artist"));i.append($("<span>").addClass("szi-artist").append(f))}else i.append($("<span>").addClass("szi-artist").text(g.get("artist")));
a.addClass("sz-station-song-displayed");a.find(".szi-current-song").html(i)}else a.removeClass("sz-station-song-displayed")})},b=function(){e(f.view.el)};return{register:function(a){f=a.getInstance();a.addDOMEnhancement(e);f.bind("player-station-started",b);f.bind("player-station-play",b);f.bind("player-station-pause",b);f.bind("player-song-started",b);f.bind("player-song-completed",b);f.bind("player-song-play",b);f.bind("player-song-pause",b);b()}}});define("songza/dom-enhancements/fixed-header",function(){function f(){_.defer(function(){b=$(".sz-nav-main").offset().top;$("#main-div").offset();$("#main-div").innerHeight();e()})}function e(){var a=$(window).scrollTop(),c=$("body");a>b?c.addClass("sz-header-fixed"):c.removeClass("sz-header-fixed")}var b;return{register:function(a){!$("html").hasClass("ie6")&&!$("html").hasClass("ie7")&&!Modernizr.touch&&(a.getInstance().bind("page-navigate",f),f(),$(window).scroll(e),$(window).resize(e))}}});define("songza/dom-enhancements/feeds",["songza/feeds"],function(f){function e(a,b){var g={limit:20};a?(g.sort="time",g.since=parseInt(a.getTime()/1E3)):(g.sort="time",g.since=parseInt((new Date).getTime()/1E3-2*d));b=_.defaults(_.clone(b),g);return c.feed(b)}function b(a){return e(a,{global:0})}function a(a){return e(a,{global:1})}var c,d=86400,g={user:function(){return b},global:function(){return a},station:function(a){var b=parseInt(a.attr("data-sz-station-id"),10);return function(a){return e(a,
{global:1,station:b})}}},j=function(a){$(".sz-feed-placeholder",a).each(function(){var a=$(this),b=a.attr("data-sz-feed-type");if(b=g[b])b=new f.Viewer({itemFetcher:b(a)}),a.empty(),a.append(b.render().el)})};return{register:function(a){var b=a.getInstance();c=b.getVisitor();a.addDOMEnhancement(j);b.bind("visitor-change",function(){c=b.getVisitor();j(b.view.el)})}}});define("songza/dom-enhancements/following",["songza/models"],function(f){function e(a){c=a;d=j;c.get("following").bind("add",n);c.get("following").bind("remove",n);c.get("following").bind("fetch",n);c.get("following").bind("reset",n)}function b(){if(c.isAnonymous())d=i;else if(d!==h&&(d===j||g.getTime()+l<(new Date).getTime()))d=h,c.get("following").fetch({success:function(){g=new Date;d=i;c.get("following").trigger("fetch")},error:function(){d=j}})}var a,c,d,g,j=0,h=1,i=3,l=14400;d=j;var k=function(g){$(".sz-follow-placeholder",
g).each(function(){var g=$(this),h=parseInt(g.attr("data-sz-user-id"),10),e=g.attr("data-sz-user-display-name");if(h!==c.get("id")&&(g.empty(),b(),d===i)){var j=c.get("following").find(function(a){return a.get("id")===h}),e={anonymous:c.isAnonymous(),display_name:e,following:j,login_url:a.loginUrlPath(),signup_url:a.signupUrlPath()},l=$(sz.tmpl.follow.followButton(e)),k=function(){f.User.get(h,{success:function(b){a.getVisitor().follow(b)}})},m=function(){f.User.get(h,{success:function(b){a.getVisitor().unfollow(b)}})};
g.append(l);c.isAnonymous()?(l.delegate(".szi-follow","click",function(a){a.preventDefault();l.addClass("sz-follow-anonymous-intent")}),l.delegate("a","click",function(){a.addPostLoginAction(k)})):(l.delegate(".szi-follow","click",function(a){a.preventDefault();k()}),l.delegate(".szi-unfollow","click",function(a){a.preventDefault();m()}))}})},n=function(){k($(a.view.el))};return{register:function(b){a=b.getInstance();e(a.getVisitor());b.addDOMEnhancement(k);a.bind("visitor-change",function(){e(a.getVisitor());
n(a.view.el)})}}});define("songza/dom-enhancements/situation-context",["songza/models"],function(f){function e(){var b=new f.SituationContext({});$("body").attr("data-sz-context-period",b.get("period"))}return{register:function(b){b.getInstance().bind("page-navigate",e);e()}}});define("songza/player/manager/base",["songza/base"],function(f){var e={};e.Manager=f.Class.extend({initialize:function(b){e.Manager.__super__.initialize.call(this,b);this._station=b.station;this._song=null;this._volume=b.volume;this._audio=null},start:function(){},play:function(){this._audio&&this._audio.play()},pause:function(){this._audio&&this._audio.pause()},stop:function(){this._audio&&this._audio.stop()},getSongState:function(){if(this._audio)return this._audio.getState();return null},_songTrigger:function(b){var a=
{station:this._station,song:this._song,songState:this.getSongState()};this.trigger("song-"+b,a)},_bindToAudio:function(b){var a=this;if(this._audio)this._audio=null;b.bind("start",function(){a._songTrigger("started")});b.bind("play",function(){a._songTrigger("play")});b.bind("pause",function(){a._songTrigger("pause")});b.bind("state",function(){a._songTrigger("state")});b.bind("stop",function(){a._songTrigger("completed")});b.bind("error",function(b){a.trigger("error",b)});this._audio=b},setVolume:function(b){this._volume=
b;this._audio&&this._audio.setVolume(b)},getVolume:function(){return this._volume},next:function(){},shutdown:function(){},supportsNext:function(){return!0},canSkip:function(){return!1},destroy:function(){this.stop()},songState:function(){return this.getSongState()},getResumeState:function(){return null}});return e});define("songza/player/manager/chrome-cast-receiver",["songza/player/manager/basic","songza/player/audio/html5"],function(f,e){var b={};b.Manager=f.Manager.extend({initialize:function(a){var c=this;b.Manager.__super__.initialize.call(this,a);this._audioElement=a.audioElement;this._mediaManager=a.mediaManager;this._castReceiverManager=a.castReceiverManager;this._mediaManager.customizedStatusCallback=function(a){if(!a.customData)a.customData=c._customData();return a};this.bind("song-started",function(){var a=
c._song.get("streamSong"),b=a.get("song"),e=new cast.receiver.media.MediaInformation;e.contentId=a.get("listen_url");e.contentType=a.get("version")==="aac"?"audio/mp4":"audio/mp3";e.duration=b.get("duration");e.streamType=cast.receiver.media.StreamType.BUFFERED;e.customData=c._customData();c._mediaManager.setMediaInformation(e,!0,c._customData())})},_customData:function(){return{station:this._station.toJSON(),"station-next-song":this._song.get("streamSong").toJSON()}},_handleNextSong:function(a){var b=
this._makeSong(a);this._audio&&this._audio.stop();this._setSkipState(a.get("skippable"));this._song=b;a=this._makeAudioItem(a);this._bindToAudio(a);a.start()},_audioItemOptions:function(a){a=b.Manager.__super__._audioItemOptions.call(this,a);a.audioElement=this._audioElement;return a},_audioItemType:function(){return e.AudioItem}});return b});define("songza/player/manager/basic",["songza/player/models","songza/player/manager/base","songza/player/audio/sound-manager","songza/player/audio/html5","songza/player/manager/model"],function(f,e,b,a,c){var d={};d.Manager=e.Manager.extend({initialize:function(a){d.Manager.__super__.initialize.call(this,a);_.bindAll(this,"_handleNextSong","_handleNextSongError");this._artist=a.artist;this._resumeState=a.resumeState;this._canSkip=!0;this._songCount=0;this._html5=a.html5;this._audioElement=a.audioElement;
this._shutdown=!1;this._shutdownCb=null},_makeAudioItem:function(a){a=this._audioItemOptions(a);return new (this._audioItemType())(a)},_bindToAudio:function(a){var b=this;d.Manager.__super__._bindToAudio.call(this,a);a.bind("stop",function(c){b._shutdown?b._shutdownCb&&b._shutdownCb():c.cause===a.STOP_CAUSE_COMPLETED&&b.next()})},_audioType:function(){return Modernizr.ios?"mp3":"aac"},_audioItemOptions:function(a){var b=a.get("listen_url"),a=a.get("version"),b={url:b,type:a,volume:this._volume};if(this._html5)b.audioElement=
this._audioElement;return b},_audioItemType:function(){if(this._html5)return a.AudioItem;return b.AudioItem},start:function(){var a=this;if(this.started)throw Error("Manager has already been started");this._audioItemType().initialize({success:function(){a.started=!0;a.trigger("started");a._resumeState?a._resume():a.next()},error:function(){}})},next:function(){var a=this.getSongState(),a=a&&(a.position+2E4<a.duration||a.duration==0),b={params:{cover_size:"g",format:this._audioType()},success:this._handleNextSong,
error:this._handleNextSongError};a&&this._song&&(this._station.notifySkip(this._song,{}),this._songTrigger("skipped"));this._songCount==0&&this._artist&&(b.params.request_artist=this._artist.get("id"));this._songCount++;this._song=null;this.trigger("fetching-next");this._station.nextSong(b)},shutdown:function(a){this._song?(this._shutdown=!0,this._shutdownCb=a):a&&a()},canSkip:function(){return this._canSkip},_resume:function(){var a;this._setSkipState(this._resumeState.get("can_skip"));this._stationNextSong=
this._resumeState.get("station_next_song");this._song=this._makeSong(this._stationNextSong);a=this._audioItemOptions(this._stationNextSong);a.position=this._resumeState.get("position");a=new (this._audioItemType())(a);this._bindToAudio(a);a.start()},_makeSong:function(a){var b=a.get("song"),a={id:b.get("id"),title:b.get("title"),artist_id:b.get("artist").get("id"),artist:b.get("artist").get("name"),image_url:b.get("cover_url"),banned:a.get("status")==="BAN",vote:a.get("vote"),streamSong:a};return new f.Song(a)},
_setSkipState:function(a){if(a!=this._canSkip)this._canSkip=a,this.trigger("skip-state-changed",a)},_handleNotify:function(a){this._setSkipState(a.skippable)},_handleNextSong:function(a){var b=this._makeSong(a);this._audio&&this._audio.stop();this._setSkipState(a.get("skippable"));this._stationNextSong=a;this._song=b;a=this._makeAudioItem(a);this._bindToAudio(a);a.start()},_handleNextSongError:function(a){var b="Whoops! We had a little trouble getting your next song.",c;if(a.status===403)try{(c=$.parseJSON(a.responseText))&&
(c.code==="skip"?b="Sorry, but can't quite let ya skip anymore.":c.code==="end"&&(b="End of Playlist Reached"))}catch(d){}this.trigger("error",{station:this._station,message:b})},getResumeState:function(){if(!this._stationNextSong||!this._audio)return null;var a={station_next_song:this._stationNextSong,position:this.songState()?this.songState().position:0,is_playing:this._audio.isPlaying(),can_skip:this.canSkip()};return new c.ResumeState(a)}});return d});define("songza/player/manager/chrome-cast-sender",["songza/models","songza/player/models","songza/player/chrome-cast","songza/player/audio/chrome-cast","songza/player/manager/base"],function(f,e,b,a,c){var d={};d.Manager=c.Manager.extend({NAMESPACE:"urn:x-cast:com.songza.cast",initialize:function(a){d.Manager.__super__.initialize.call(this,a);_.bindAll(this,"_handleNewMedia");this.session=a.session;this.session.addMediaListener(this._handleNewMedia);this.media=null},start:function(){var a=this,b=
a._messageStartStation(this._station);this.session.sendMessage(a.NAMESPACE,b,function(){a.trigger("started")},function(){console.log("Unable to send start message",arguments)})},_messageStartStation:function(){var a={type:"station-start",station:this._station.toJSON()};return JSON.stringify(a)},_messageNextSong:function(){var a={type:"station-next",station:this._station.toJSON()};return JSON.stringify(a)},_handleNewMedia:function(b){if(b.media){this._media=b;var c=new a.AudioItem({media:b,volume:this._volume});
this._bindToAudio(c);this._song=this._makeSong(b);c.start()}},stop:function(){this.session.removeMediaListener(this._handleNewMedia)},_makeSong:function(a){a=new f.Song(a.media.customData.song,{parse:!0});a={id:a.get("id"),title:a.get("title"),artist_id:a.get("artist").get("id"),artist:a.get("artist").get("name"),image_url:a.get("cover_url")};return new e.Song(a)},next:function(){var a=this._messageNextSong();this._songTrigger("skipped");this.session.sendMessage(this.NAMESPACE,a,function(){},function(){})},
canSkip:function(){return!0}});return d});define("songza/player/manager/chrome-cast-controlling-sender",["songza/player/manager/basic","songza/player/audio/chrome-cast"],function(f,e){var b={};b.Manager=f.Manager.extend({NAMESPACE:"urn:x-cast:com.songza.cast",initialize:function(a){b.Manager.__super__.initialize.call(this,a);this._session=a.session},start:function(){var a=this;if(this.started)throw Error("Manager has already been started");this._audioItemType().initialize({success:function(){a._startStation()},error:function(){}})},_startStation:function(){var a=
this,b=a._messageStartStation(this._station);this._session.sendMessage(a.NAMESPACE,b,function(){a.started=!0;a.trigger("started");a._resumeState?a._resume():a.next()},function(){console.log("Unable to send start message",arguments)})},_messageStartStation:function(){var a={type:"station-start",station:this._station.toJSON(),controlled:!0};return JSON.stringify(a)},_audioItemOptions:function(a){return{url:a.get("listen_url"),type:a.get("type"),session:this._session,volume:this.getVolume(),customData:{station:this._station.toJSON(),
"station-next-song":a.toJSON()}}},_audioItemType:function(){return e.AudioItem}});return b});define("songza/player/manager/model",function(){var f={};f.ResumeState=Backbone.Model.extend({defaults:{station_next_song:null,position:null,is_playing:null,can_skip:null}});return f});define("songza/player/manager/stream",["songza/player/manager/base","songza/player/audio/jwplayer","songza/player/models"],function(f,e,b){var a={};a.Manager=f.Manager.extend({initialize:function(b){a.Manager.__super__.initialize.call(this,b);_.bindAll(this,"_handleMeta");this._started=!1;this._meta={}},_getSecId:function(a){var a=parseUri(a).query||"",b=null;_.each(a.split("&"),function(a){var c=a.split("=")[0],a=a.split("=")[1];c==="sec"&&(b=decodeURIComponent(a))});return b},_mergeMetadata:function(a){var b=
a.get("_secId"),e={};if(this._meta.hasOwnProperty(b)){b=this._meta[b];if(b.artist)e.artist=b.artist;if(b.title)e.title=b.title;if(b.image.medium)e.image_url=b.image.medium;a.set(e)}},_extractSong:function(a){var d={};if(a.artist==="BREAK"||a.artist==="EVENT TIMEOUT"||a.artist==="TARGETSPOT"||a.artist==="ENDBREAK"||a.artist===void 0)return null;d.artist=a.artist;d.title=a.title;d.image_url=this._station.get("cover_url");d._secId=this._getSecId(a.url);a=new b.Song(d);this._mergeMetadata(a);return a},
_endSong:function(){if(this._song)this._songTrigger("completed"),this._song=null},_handleMeta:function(a){console.log("new metadata",a);var b=this._extractSong(a);this.trigger("metadata",a);if(b){if(this._song&&b&&this._song.get("_secId")!==b.get("_secId")&&this._endSong(),b)this._song=b,this._songTrigger("started")}else this._endSong()},start:function(){var a=this;if(this._started)throw Error("Manager has already been started");e.AudioItem.initialize({success:function(){a._doStart()},error:function(){}})},
_doStart:function(){var a=this,b=this._station.get("stream").formats.rtmp;this._audio=new e.AudioItem({volume:this.volume,streamUrl:b});this._audio.bind("meta",this._handleMeta);this._audio.bind("state",function(){a._songTrigger("state")});this._audio.bind("play",function(){a.trigger("stream-play")});this._audio.bind("pause",function(){a.trigger("stream-pause")});this.trigger("started");this._audio.start();this._started=!0;this._station.listen()},next:function(){throw Error("Next is not supported");
},shutdown:function(a){this.pause();a&&a()},supportsNext:function(){return!1}});return a});define("songza/player/manager/chrome-cast-controlled-receiver",["songza/models","songza/player/models","songza/player/manager/base","songza/player/audio/html5"],function(f,e,b,a){var c={};c.Manager=b.Manager.extend({initialize:function(a){c.Manager.__super__.initialize.call(this,a);_.bindAll(this,"_handleNewTrack");this._audio=null;this._mediaManager=a.mediaManager;this._audioElement=a.audioElement;this._audioElement.addEventListener("loadedmetadata",this._handleNewTrack)},_deepClone:function(a){return JSON.parse(JSON.stringify(a))},
_handleNewTrack:function(){var b=this._deepClone(this._mediaManager.getMediaInformation().customData["station-next-song"]),b=new f.StationStreamSong(b,{parse:!0});this._audio&&this._audio.stop();this._song=this._makeSong(b);this._audio=new a.AudioItem({audioElement:this._audioElement});this._bindToAudio(this._audio);this._audio.start()},_makeSong:function(a){var b=a.get("song"),a={id:b.get("id"),title:b.get("title"),artist_id:b.get("artist").get("id"),artist:b.get("artist").get("name"),image_url:b.get("cover_url"),
banned:a.get("status")==="BAN",vote:a.get("vote"),streamSong:a};return new e.Song(a)},_audioItemOptions:function(a){a=c.Manager.__super__._audioItemOptions.call(this,a);a.session=this._session;return a},_audioItemType:function(){return ChromeCastAudio.AudioItem}});return c});define("songza/player/audio/base",["songza/base"],function(f){var e={};e.AudioItem=f.Class.extend({STOP_CAUSE_COMPLETED:"completed",STOP_CAUSE_STOPPED:"stopped",STOP_CAUSE_ERROR:"error",initialize:function(b){this._volume=b.volume||100},start:function(){},play:function(){},pause:function(){},stop:function(){},getState:function(){return{position:0,duration:0,buffering:!1}},getVolume:function(){return this._volume},setVolume:function(b){this._volume=b},isPlaying:function(){return!1},isPaused:function(){return!this.isPlaying()}},
{initialize:function(b){b=b||{};b.success&&b.success()}});return e});define("songza/player/audio/jwplayer",["songza/player/audio/base","songza/config"],function(f,e){var b={};b.AudioItem=f.AudioItem.extend({initialize:function(a){b.AudioItem.__super__.initialize.call(this,a);this._streamUrl=a.streamUrl;this._buffering=!1;this._player=null},start:function(){var a=this,b=this._streamUrl.split("/"),d=_.last(b),b=_.initial(b).join("/");this._player=jwplayer("jwplayer").setup({flashplayer:e.static_url+"swf/jwplayer/player.swf",file:d,type:"rtmp",streamer:b,autostart:!0,
bufferlength:5,width:1,height:1,volume:this.getVolume(),events:{onMeta:function(b){"type"in b.metadata&&b.metadata.type==="metadata"&&a.trigger("meta",b.metadata)},onPlay:function(){a._buffering=!1;a.trigger("state",a.getState());a.trigger("play")},onBuffer:function(){a._buffering=!0;a.trigger("state",a.getState())},onPause:function(){a._buffering=!1;a.trigger("state",a.getState());a.trigger("pause")},onComplete:function(){a._buffering=!1;a.trigger("state",a.getState());a.trigger("stop",{cause:a.STOP_CAUSE_COMPLETED})}}});
this._player.play(!0)},play:function(){this._player.play()},pause:function(){this._player.pause()},stop:function(){this._player.stop()},getState:function(){return{buffering:this._buffering}},setVolume:function(a){b.AudioItem.__super__.setVolume.call(this,a);this._player.setVolume(a)},isPlaying:function(){return!1},isPaused:function(){return!1}},{initialize:function(a){var b=$("<div id='jwplayer_root'>"),d=$("<div id='jwplayer'>");b.css({position:"absolute",top:"0",opacity:"0"});$("#jwplayer").remove();
b.append(d);$("body").append(b);a=a||{};a.success&&a.success()}});return b});define("songza/player/audio/html5",["songza/player/audio/base"],function(f){var e={};e.AudioItem=f.AudioItem.extend({initialize:function(b){e.AudioItem.__super__.initialize.call(this,b);this._url=b.url;this._type=b.type;this._audioElement=b.audioElement||null;this._stopped=!1;_.bindAll(this,"_onPlay","_onPause","_onEnd","_onState")},start:function(){var b=this._audioElement!==null;if(!b)this._audioElement=document.createElement("audio");if(this._url)this._audioElement.src=this._url;this._audioElement.addEventListener("play",
this._onPlay);this._audioElement.addEventListener("pause",this._onPause);this._audioElement.addEventListener("ended",this._onEnd);this._audioElement.addEventListener("canplay",this._onState);this._audioElement.addEventListener("waiting",this._onState);this._audioElement.addEventListener("timeupdate",this._onState);b&&this._url&&this._audioElement.load();this.trigger("start");b&&this._audioElement.play()},play:function(){this._audioElement.play()},pause:function(){this._audioElement.pause()},stop:function(){this._audioElement&&
this._audioElement.pause();this._doStop(this.STOP_CAUSE_STOPPED)},_onPlay:function(){this.trigger("play")},_onPause:function(){this.trigger("pause")},_onState:function(){this.trigger("state",this.getState())},_onEnd:function(){this._doStop(this.STOP_CAUSE_COMPLETED)},_doStop:function(b){if(!this._stopped)this.trigger("stop",{cause:b}),this._audioElement.removeEventListener("play",this._onPlay),this._audioElement.removeEventListener("pause",this._onPause),this._audioElement.removeEventListener("ended",
this._onEnd),this._audioElement.removeEventListener("canplay",this._onState),this._audioElement.removeEventListener("waiting",this._onState),this._audioElement.removeEventListener("timeupdate",this._onState),this._audioElement=null,this._stopped=!0},_adjustVolume:function(b){return b/100},setVolume:function(b){e.AudioItem.__super__.setVolume(b);this._audioElement.volume=this._adjustVolume(b)},getState:function(){return{position:this._audioElement.currentTime*1E3,duration:this._audioElement.duration*
1E3,buffering:this.isBuffering()}},getAudioElement:function(){return this._audioElement},isBuffering:function(){return this._audioElement.buffered&&this._audioElement.buffered.length==0},isPlaying:function(){return this._audioElement!=null&&!this._audioElement.paused}},{initialize:function(b){b=b||{};b.success&&b.success()}});return e});define("songza/player/audio/sound-manager",["songza/player/audio/base","songza/config"],function(f,e){var b={},a=Modernizr.ios;b.AudioItem=f.AudioItem.extend({initialize:function(a){b.AudioItem.__super__.initialize.call(this,a);this._url=a.url;this._type=a.type;this._position=a.position;this._stopped=!1},start:function(){var a=this;this.sound=soundManager.createSound({url:this._url,volume:this._adjustVolume(this.getVolume()),onplay:function(){a.trigger("play")},onpause:function(){a.trigger("pause")},
onresume:function(){a.trigger("play")},onbufferchange:function(){a.trigger("state",a.getState())},whileplaying:function(){a.trigger("state",a.getState())},onfinish:function(){a._doStop(a.STOP_CAUSE_COMPLETED)},isMovieStar:this._type==="aac",autoPlay:!1});this.trigger("start");this.sound.play({position:this._position})},play:function(){this.sound.resume()},pause:function(){this.sound.pause()},stop:function(){this.sound.stop();this._doStop(this.STOP_CAUSE_STOPPED)},_doStop:function(a){if(!this._stopped)this.trigger("stop",
{cause:a}),this._stopped=!0},getState:function(){return{position:this.sound.position,duration:this.sound.duration,buffering:this.sound.isBuffering}},setVolume:function(a){b.AudioItem.__super__.setVolume(a);this.sound.setVolume(this._adjustVolume(a))},_adjustVolume:function(a){return Math.pow(a,2)/100},isPlaying:function(){return this.sound.playState},isPaused:function(){return!this.isPlaying()}},{initialize:function(b){b=b||{};b.success=b.success||function(){};b.error=b.error||function(){};window.soundManager?
b.success():(window.soundManager=new SoundManager,a?(soundManager.audioFormats.mp3.required=!0,soundManager.audioFormats.mp4.required=!1):(soundManager.audioFormats.mp4.required=!0,soundManager.audioFormats.mp3.required=!1),soundManager.setup({url:e.static_url+"swf/soundmanager/",debugMode:!1,debugFlash:!1,consoleOnly:!1,onready:function(){b.success()},ontimeout:function(){b.error()},preferFlash:Modernizr.audio_prefers_flash,flashLoadTimeout:0,flashVersion:9}),soundManager.beginDelayedInit())}});
return b});define("songza/player/audio/chrome-cast",["songza/player/audio/base"],function(f){var e={};e.AudioItem=f.AudioItem.extend({initialize:function(b){e.AudioItem.__super__.initialize.call(this,b);this._volume=b.volume||100;this._lastPlayerState=null;this._session=b.session;b.media?this._media=b.media:(this._url=b.url,this._type=b.type,this._position=b.position||0,this._customData=b.customData);_.bindAll(this,["_syncMediaStatus"])},start:function(){this._media?this._startMedia():this._loadAndStart()},
_startMedia:function(){this._media.addUpdateListener(this._syncMediaStatus);this._syncMediaStatus();this.trigger("start")},_loadAndStart:function(){var b=this,a=new chrome.cast.media.MediaInfo(this._url,this._type=="aac"?"audio/mp4":"audio/mp3");a.customData=this._customData;a=new chrome.cast.media.LoadRequest(a);a.currentTime=this._position/1E3;var c=this._volume;Math.round(this._session.receiver.volume.level*100)!=c&&this._session.setReceiverVolumeLevel(c/100,function(){},function(){});this._session.loadMedia(a,
function(a){b._media=a;b._startMedia()},function(a){a.code=="session_error"&&a.description=="LOAD_CANCELLED"||b.trigger("error",{message:"Unable to start playback"})})},play:function(){var b=this;this._media&&(this.isPlaying()||this._media.play(null,function(){b.trigger("play")},function(){}))},pause:function(){var b=this;this._media&&(this.isPaused()||this._media.pause(null,function(){b.trigger("pause")},function(){}))},setVolume:function(b){this._media&&(this._session.setReceiverVolumeLevel(b/100,
function(){},function(){}),e.AudioItem.__super__.setVolume.call(this,b))},getState:function(){var b={position:0,duration:0,buffering:!1};this._media&&(b={position:this._media.currentTime*1E3,duration:this._media.media.duration*1E3,buffering:!1});return b},_isPlayingOrBuffering:function(b){return b===chrome.cast.media.PlayerState.PLAYING||b===chrome.cast.media.PlayerState.BUFFERING},_syncMediaStatus:function(){var b=this._media.playerState;b!==this._lastPlayerState&&(this._isPlayingOrBuffering(b)&&
!this._isPlayingOrBuffering(this._lastPlayerState)?this.trigger("play"):b===chrome.cast.media.PlayerState.IDLE?this.trigger("stop",{cause:this.STOP_CAUSE_COMPLETED}):b===chrome.cast.media.PlayerState.PAUSED&&this.trigger("pause"));this._lastPlayerState=b;this.trigger("state",this.getState())},stop:function(){var b=this,a=new chrome.cast.media.StopRequest,c=function(){b.trigger("stop",{cause:b.STOP_CAUSE_STOPPED})},d=function(){console.log("Unable to stop audio")};this._media&&(this._media.removeUpdateListener(this._syncMediaStatus),
this._media.stop(a,c,d))},isPlaying:function(){if(!this._media)return!1;if(this._media.playerState===chrome.cast.media.PlayerState.PLAYING)return!0;if(this._media.playerState===chrome.cast.media.PlayerState.BUFFERING)return!0;return!1}},{initialize:function(b){b=b||{};b.success&&b.success()}});return e});define("songza/player/models",["songza/models"],function(f){var e={},b=e.Song=Backbone.Model.extend({defaults:{title:null,artist:null,image_url:null,streamSong:null,vote:null},altImageUrls:function(){return{s:this.get("image_url").replace(/..jpeg/,"s.jpeg"),m:this.get("image_url").replace(/..jpeg/,"m.jpeg"),g:this.get("image_url").replace(/..jpeg/,"g.jpeg")}},parse:function(a){if(a.streamSong)a.streamSong=e.Utils.parseIntoModels(f.StationStreamSong,a.stationStreamSong);return a},toJSON:function(){var a=
b.__super__.toJSON.call(this);if(this.get("streamSong"))a.streamSong=this.get("streamSong").toJSON();return a}});return e});define("songza/player/managers",["songza/base","songza/config","songza/models","songza/player/models","songza/player/core"],function(f,e,b,a,c){var d={};d.Base=f.Class.extend({initialize:function(a){d.Base.__super__.initialize.call(this,a);this.station=a.station;this.volume=a.volume;this.started=!1;this.song=null;this.listenTime=0;this.listenChunkStartTime=null},getListenTime:function(){if(!this.listenChunkStartTime)return this.listenTime;return this.listenTime+((new Date).getTime()-this.listenChunkStartTime.getTime())},
startListen:function(){if(!this.listenChunkStartTime)this.listenChunkStartTime=new Date},stopListen:function(){var a=new Date;if(this.listenChunkStartTime)this.listenTime+=a.getTime()-this.listenChunkStartTime.getTime(),this.listenChunkStartTime=null},play:function(){this.core.play()},pause:function(){this.core.pause()},songState:function(){return this.core.songState()},destroy:function(){this.core.unbind();this.core.destroy()},setVolume:function(a){this.volume=a;this.core.setVolume(a)},getVolume:function(){return this.volume},
_songTrigger:function(a){var b={station:this.station,song:this.song,songState:this.songState()};this.trigger("song-"+a,b)},start:function(){},next:function(){},shutdown:function(){},supportsNext:function(){return!0},canSkip:function(){return!1}});var g=d.Basic=d.Base.extend({initialize:function(a){g.__super__.initialize.call(this,a);_.bindAll(this,"_handleNextSong","_handleNextSongError");this.nextSong=null;this.artist=a.artist;this.can_skip=!0;this.song_count=0;this.bindToCore(c.makeCore(this.station,
this.volume));this._shutdown=!1;this._shutdown_cb=null},bindToCore:function(a){var b=this;this.core&&this.core.unbind();this.core=a;this.core.bind("song-resume",function(){b.startListen()});this.core.bind("song-pause",function(){b.stopListen()});this.core.bind("song-play-state",function(a){a.buffering?b.stopListen():b.startListen();b._songTrigger("state")});this.core.bind("song-complete",function(){b.stopListen();b._songTrigger("completed");b._shutdown?b._shutdown_cb&&b._shutdown_cb():b.next()});
this.core.bind("song-error",function(a){b.trigger("error",a)})},start:function(){var a=this;if(this.started)throw Error("Manager has already been started");this.core.prep(function(){a.started=!0;a.trigger("started");a.next()})},next:function(){var a=this.songState(),a=a&&(a.position+2E4<a.duration||a.duration==0),b={params:{cover_size:"g",format:this.core.requestedFormat()},success:this._handleNextSong,error:this._handleNextSongError};a&&this.song&&(this.station.notifySkip(this.song,{}),this._songTrigger("skipped"));
this.song_count==0&&this.artist&&(b.params.request_artist=this.artist.get("id"));this.song_count++;this.song=null;this.trigger("fetching-next");this.station.nextSong(b)},shutdown:function(a){this.song?(this._shutdown=!0,this._shutdown_cb=a):a&&a()},canSkip:function(){return this.can_skip},_makeSong:function(b){var c=b.get("song"),b={id:c.get("id"),title:c.get("title"),artist_id:c.get("artist").get("id"),artist:c.get("artist").get("name"),image_url:c.get("cover_url"),banned:b.get("status")==="BAN",
vote:b.get("vote"),streamSong:b};return new a.Song(b)},_setSkipState:function(a){if(a!=this.can_skip)this.can_skip=a,this.trigger("skip-state-changed",a)},_handleNotify:function(a){this._setSkipState(a.skippable)},_handleNextSong:function(a){var b=this._makeSong(a);this._setSkipState(a.get("skippable"));this.nextSong=a;this.song=b;this.core.playSong(this.station,a.get("song"),a.get("listen_url"),a.get("version"));this._songTrigger("started")},_handleNextSongError:function(a){var b="Whoops! We had a little trouble getting your next song.",
c;if(a.status===403)try{(c=$.parseJSON(a.responseText))&&(c.code==="skip"?b="Sorry, but can't quite let ya skip anymore.":c.code==="end"&&(b="End of Playlist Reached"))}catch(d){}this.trigger("error",{station:this.station,message:b})}}),j=d.Stream=d.Base.extend({initialize:function(a){var b=this;j.__super__.initialize.call(this,a);_.bindAll(this,"_handleMeta");this.core=c.makeCore(this.station,this.volume,null);this.started=!1;this.song=null;this.meta={};this.metaFetching=!1;this.metaTimer=null;this.core.bind("meta",
this._handleMeta);this.core.bind("song-play",function(){b.startListen()});this.core.bind("song-pause",function(){b.stopListen()});this.core.bind("song-idle",function(){b.stopListen()});this.core.bind("song-complete",function(){b.stopListen()});this.core.bind("song-play-state",function(a){a.buffering?b.stopListen():b.startListen();b._songTrigger("state")})},_getSecId:function(a){var a=parseUri(a).query||"",b=null;_.each(a.split("&"),function(a){var c=a.split("=")[0],a=a.split("=")[1];c==="sec"&&(b=
decodeURIComponent(a))});return b},_mergeMetadata:function(a){var b=a.get("_secId"),c={};if(this.meta.hasOwnProperty(b)){b=this.meta[b];if(b.artist)c.artist=b.artist;if(b.title)c.title=b.title;if(b.image.medium)c.image_url=b.image.medium;a.set(c)}},_extractSong:function(b){var c={};if(b.artist==="BREAK"||b.artist==="EVENT TIMEOUT"||b.artist==="TARGETSPOT"||b.artist==="ENDBREAK"||b.artist===void 0)return null;c.artist=b.artist;c.title=b.title;c.image_url=this.station.get("cover_url");c._secId=this._getSecId(b.url);
b=new a.Song(c);this._mergeMetadata(b);return b},_endSong:function(){if(this.song)this._songTrigger("completed"),this.song=null},_handleMeta:function(a){console.log("new metadata",a);var b=this._extractSong(a);this.trigger("metadata",a);if(b){if(this.song&&b&&this.song.get("_secId")!==b.get("_secId")&&this._endSong(),b)this.song=b,this._songTrigger("started")}else this._endSong()},start:function(){var a=this,b=this.station.get("stream").formats.rtmp;if(this.started)throw Error("Manager has already been started");
this.station.listen();this.core.prep(function(){a.started=!0;a.core.playStream(b);a.trigger("started")})},next:function(){throw Error("Next is not supported");},shutdown:function(a){this.pause();a&&a()},supportsNext:function(){return!1}});return d});define("songza/player/cores/jw",["songza/base","songza/config"],function(f,e){return f.Class.extend({initialize:function(b){this.volume=b.volume!==void 0?b.volume:50;this.buffering=!1;$("#jwplayer").remove();var b=$("<div id='jwplayer_root'>"),a=$("<div id='jwplayer'>");b.css({position:"absolute",top:"0",opacity:"0"});b.append(a);$("body").append(b)},requestedFormat:function(){return"rtmp"},play:function(){if(!this.isValid())return!1;this.__jwp.play();return!0},setVolume:function(b){this.volume=b;
if(!this.isValid())return!1;this.__jwp.setVolume(b);return!0},pause:function(){if(!this.isValid())return!1;this.__jwp.pause();return!0},songState:function(){return{buffering:this.buffering}},playStream:function(b){var a=b.split("/"),b=_.last(a),a=_.initial(a).join("/"),c=this;this.__jwp=jwplayer("jwplayer").setup({flashplayer:e.static_url+"swf/jwplayer/player.swf",file:b,type:"rtmp",streamer:a,autostart:!0,bufferlength:5,width:1,height:1,volume:this.volume,events:{onMeta:function(a){"type"in a.metadata&&
a.metadata.type==="metadata"&&c.trigger("meta",a.metadata)},onPlay:function(){c.buffering=!1;c.trigger("song-play-state",{buffering:!1});c.trigger("song-play")},onBuffer:function(){c.buffering=!0;c.trigger("song-play-state",{buffering:!0})},onIdle:function(){c.trigger("song-idle")},onPause:function(){c.buffering=!1;c.trigger("song-play-state",{buffering:!1});c.trigger("song-pause")},onComplete:function(){c.buffering=!1;c.trigger("song-state",{buffering:!1});c.trigger("song-complete")}}});this.__jwp.play(!0)},
prep:function(b){b()},destroy:function(){this.__jwp.stop();this.__jwp=null;return!0},isPlaying:function(){return!1},isPaused:function(){return!1},isValid:function(){return this.__jwp}})});define("songza/player/cores/sm",["songza/base","songza/config"],function(f,e){function b(){if(!soundManager)window.soundManager=new SoundManager,d?(soundManager.audioFormats.mp3.required=!0,soundManager.audioFormats.mp4.required=!1):(soundManager.audioFormats.mp4.required=!0,soundManager.audioFormats.mp3.required=!1),soundManager.setup({url:e.static_url+"swf/soundmanager/",debugMode:!1,debugFlash:!1,consoleOnly:!1,onready:function(){c=!0},ontimeout:function(){},preferFlash:Modernizr.audio_prefers_flash,
flashLoadTimeout:0,flashVersion:9}),soundManager.beginDelayedInit()}function a(a,b){function c(){a.volume>5?(a.setVolume(a.volume/2),setTimeout(c,50)):b?a.stop():a.pause()}setTimeout(c,50)}var c=!1,d=Modernizr.ios;return f.Class.extend({initialize:function(a){b();this.__previousSmSound=this.__currentSmSound=null;this.volume=a.volume!==void 0?a.volume:50},requestedFormat:function(){return d?"mp3":"aac"},play:function(){if(!this.isValid())return!1;this.isPaused()?this.__currentSmSound.resume():this.isPlaying()||
this.__currentSmSound.play();return!0},_adjustVolume:function(a){return Math.pow(a,2)/100},setVolume:function(a){this.volume=a;this.__currentSmSound&&this.__currentSmSound.setVolume(this._adjustVolume(a));return!0},pause:function(){if(!this.isValid())return!1;this.isPaused()||this.__currentSmSound.pause();return!0},songState:function(){if(this.__currentSmSound){var a=this.__currentSmSound;return{position:a.position,duration:a.duration,buffering:a.isBuffering}}return null},playSong:function(b,d,e,
f,l){var k=this;if(c){var n=f=="aac";if(this.__currentSmSound)a(this.__currentSmSound,!0),this.__previousSmSound=this.__currentSmSound;this.__currentSmSound=soundManager.createSound({url:e,volume:k._adjustVolume(k.volume),onplay:function(){k.trigger("song-play")},onpause:function(){k.trigger("song-pause")},onresume:function(){k.trigger("song-resume")},onbufferchange:function(){k.trigger("song-play-state",k.songState())},whileplaying:function(){k.trigger("song-play-state",k.songState())},onfinish:function(){k.trigger("song-complete")},
isMovieStar:n,autoPlay:!1});this.trigger("new-song");this.__currentSmSound.play({position:l})}else setTimeout(function(){k.playSong(b,d,e,f,l)},250)},prep:function(a){Modernizr.audio_requires_user_interaction?soundManager.createSound({id:"sm-prep",url:e.static_url+"1sec.mp3",onplay:a,autoPlay:!0}):a()},destroy:function(){if(this.__currentSmSound)a(this.__currentSmSound),this.__currentSmSound=null},isPlaying:function(){return this.__currentSmSound!=null&&this.__currentSmSound.playState},isPaused:function(){return this.__currentSmSound!=
null&&this.__currentSmSound.paused},isValid:function(){return this.__currentSmSound!=null}})});define("songza/player/cores/html5-audio",["songza/base"],function(f){function e(a){function c(){a.__fading_out=!0;a.volume>b.cutoff?(a.volume*=b.multiplier,setTimeout(c,b.timeout)):a.pause()}setTimeout(c,50)}var b={cutoff:0.05,multiplier:0.5,timeout:50};return f.Class.extend({initialize:function(a){this.__previousSound=this.__currentSound=null;this.volume=a.volume!==void 0?a.volume:100},requestedFormat:function(){return"aac"},play:function(){if(!this.isValid())return!1;this.__currentSound.play();
return!0},_adjustVolume:function(a){return a/100},setVolume:function(a){this.volume=a;if(this.__currentSound)this.__currentSound.volume=this._adjustVolume(a);return!0},pause:function(){if(!this.isValid())return!1;this.__currentSound.pause();return!0},songState:function(){if(this.__currentSound){var a=this.__currentSound;return{position:a.currentTime*1E3,duration:a.duration*1E3,buffering:this.isBuffering()}}return null},playSong:function(a,b,d){if(this.__currentSound)e(this.__currentSound),this.__previousSound=
this.__currentSound;this.__currentSound=this.createSound(d);this.__currentSound.play();this.trigger("new-song")},createSound:function(a){var b=this,d=document.createElement("audio");d.setAttribute("src",a);this.setVolume(this.volume);d.addEventListener("play",function(){this.__was_paused?(this.__was_paused=null,b.trigger("song-resume")):b.trigger("song-play")});d.addEventListener("pause",function(){if(!this.__fading_out)this.__was_paused=!0,b.trigger("song-pause")});d.addEventListener("ended",function(){b.trigger("song-complete")});
d.addEventListener("canplay",function(){b.trigger("song-play-state",b.songState())});d.addEventListener("waiting",function(){b.trigger("song-play-state",b.songState())});d.addEventListener("timeupdate",function(){b.trigger("song-play-state",b.songState())});return d},prep:function(a){a()},destroy:function(){if(this.__currentSound)e(this.__currentSound),this.__currentSound=null},fadeOutCurrentSong:function(){if(this.__currentSound)e(this.__currentSound),this.__previousSound=this.__currentSound,this.__currentSound=
null},getAudioElement:function(){return this.__currentSound},isBuffering:function(){return this.__currentSound&&this.__currentSound.buffered&&this.__currentSound.buffered.length==0?!0:!1},isPlaying:function(){return this.__currentSound!=null&&!this.__currentSound.paused},isPaused:function(){return this.__currentSound!=null&&this.__currentSound.paused},isValid:function(){return this.__currentSound!=null}})});define("songza/player/cores/chrome-cast",["songza/base","songza/config","songza/player/chrome-cast"],function(f,e,b){return f.Class.extend({initialize:function(a){this.chromeCast=b;this.media_status=this.activity=null;this.receiver=a.receiver;this.volume=a.volume!==void 0?a.volume:50;_.bindAll(this,["syncMediaStatus"])},requestedFormat:function(){return"aac"},prep:function(a){var b=this,d=new window.cast.LaunchRequest(e.chrome_cast.v1_app_id,this.receiver),g=this.chromeCast.api;g.launch(d,function(e){console.log("Chrome Cast Launch",
arguments);e.status!="running"?b.trigger("song-error",{message:"Unable to start activity on Chrome Cast"}):(g.getMediaStatus(e.activityId,function(e){console.log("Chrome Cast volume is currently ",e.value," should be",b.volume);e.volume!=b.volume?g.setMediaVolume(b.activity.activityId,d,function(){a()}):a()}),b.activity=e,g.addMediaStatusListener(e.activityId,b.syncMediaStatus))})},play:function(){var a,b=this;if(!this.isValid())return!1;this.isPaused()&&(a=new window.cast.MediaPlayRequest,this.chromeCast.api.playMedia(this.activity.activityId,
a,function(){console.log("Chrome Cast Play",arguments);b.startProgress()}));return!0},setVolume:function(a){this.volume=a;var b=new window.cast.MediaVolumeRequest;b.muted=!1;b.volume=a/100;this.chromeCast.api.setMediaVolume(this.activity.activityId,b,function(){console.log("Chrome Cast Set Volume",arguments)});return!0},pause:function(){var a=this;if(!this.isValid())return!1;this.isPaused()||this.chromeCast.api.pauseMedia(this.activity.activityId,function(){console.log("Chrome Cast Pause",arguments);
a.stopProgress()});return!0},songState:function(){if(this.media_status){var a=this.media_status;return{position:a.position*1E3,duration:a.duration*1E3,buffering:a.timeProgress===!1&&a.state===2}}return null},playSong:function(a,b,d,e,f){var h=this;this.media_status=null;d=new window.cast.MediaLoadRequest(d);d.contentInfo={station:a.toJSON(),song:b.toJSON()};this.chromeCast.api.loadMedia(this.activity.activityId,d,function(a){var b;console.log("Chrome Cast Load Media",arguments);a.success?(b=new window.cast.MediaPlayRequest,
b.position=f/1E3,h.chromeCast.api.playMedia(h.activity.activityId,b,function(a){console.log("Chrome Cast Post Load Play",arguments);a.success?h.syncMediaStatus(a.status):h.trigger("song-error",{message:"Unable to play song: "+a.errorString})}),h.syncMediaStatus(a.status),h.startProgress()):h.trigger("song-error",{message:"Unable to load song: "+a.errorString})});this.trigger("new-song")},syncMediaStatus:function(a){console.log("Chrome Cast Sync Media Status",a);if(this.media_status==null){if(a.state===
2)this.trigger("song-play"),this.media_status=a}else a.state!==this.media_status.state&&(a.state===2?this.trigger("song-resume"):a.state===0?this.trigger("song-complete"):a.state===1&&this.trigger("song-pause")),this.media_status=a,this.trigger("song-play-state",this.songState())},startProgress:function(){if(!this.progressTimer)this.progressTimer=setInterval(function(a){a.chromeCast.api.getMediaStatus(a.activity.activityId,function(b){a.syncMediaStatus(b)})},1E3,this)},stopProgress:function(){if(this.progressTimer)clearInterval(this.progressTimer),
this.progressTimer=null},destroy:function(){this.stopProgress();this.activity&&this.chromeCast.api.stopActivity(this.activity.activityId,function(){console.log("Chrome Cast Stop",arguments)})},isPlaying:function(){return this.media_status!=null&&this.media_status.state===2},isPaused:function(){return this.media_status!=null&&this.media_status.state!==2},isValid:function(){return this.media_status!=null}})});define("songza/player/chrome-cast",["songza/config","songza/base","songza/app"],function(f,e,b){e=new (e.Class.extend({initialize:function(){this._haveReceiver=this._started=!1;this.session=null;_.bindAll(this,"_sessionListener","_receiverListener");_.bindAll(this,"_onRequestSessionSuccess","_onLaunchError");_.bindAll(this,"_onCastStart","_onCastStop");this.bind("cast-start",this._onCastStart);this.bind("cast-stop",this._onCastStop)},start:function(){var a=this;this._started||require(["https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"],
function(){a._waitForAvailability()})},_waitForAvailability:function(){var a=this;this.isAvailable()?this._onAvailable():setTimeout(function(){a._waitForAvailability()},1E3)},_onAvailable:function(){var a=new window.chrome.cast.SessionRequest(f.chrome_cast.v2_app_id),a=new window.chrome.cast.ApiConfig(a,this._sessionListener,this._receiverListener);window.chrome.cast.initialize(a,function(){},function(){})},isAvailable:function(){return window.chrome&&window.chrome.cast&&window.chrome.cast.isAvailable?
!0:!1},_sessionListener:function(a){this._setSession(a)},_setSession:function(a){var b=this;this.session=a;this.trigger("cast-start");a.addUpdateListener(function(a){if(!a)b.session=null,b.trigger("cast-stop")})},_receiverListener:function(a){this._haveReceivers=a==="available"?!0:!1;this.trigger("receiver-list-change")},haveReceivers:function(){return this._haveReceivers},isCasting:function(){return this.session!=null},canCast:function(a){return!a.get("stream")},getSession:function(){return this.session},
startCast:function(){window.chrome.cast.requestSession(this._onRequestSessionSuccess,this._onLaunchError)},stopCast:function(){var a=this;this.session.stop(function(){a.session=null;a.trigger("cast-stop")},function(){})},_onRequestSessionSuccess:function(a){this._setSession(a)},_onLaunchError:function(){console.log("launch error",arguments)},_onCastStart:function(){this._restartPlayback()},_onCastStop:function(){this._restartPlayback()},_restartPlayback:function(){var a=b.getInstance(),c=a.getPlayer(),
d=c?c.model.get("station"):null;d&&((c=c.getManager().getResumeState())&&c.set({is_playing:!0}),a.stopStation(),a.startStation(d,{resumeState:c}))}}));Modernizr.is_chrome&&e.start();return e});define("songza/player/core",["songza/player/cores/sm","songza/player/cores/jw","songza/player/cores/chrome-cast"],function(f,e,b){return{makeCore:function(a,c,d){if(a.get("stream")&&a.get("stream").formats&&a.get("stream").formats.rtmp)return new e({volume:c});if(d)return new b({volume:c,receiver:d});return new f({volume:c})}}});define("songza/player/view",["songza/base","songza/config","songza/sharing","songza/player/manager/basic","songza/player/manager/chrome-cast-controlling-sender","songza/player/manager/chrome-cast-sender","songza/player/manager/stream","songza/player/chrome-cast"],function(f,e,b,a,c,d,g,j){d={};d.PlayerState=Backbone.Model.extend({defaults:{station:null,current:null,state:"station",playState:"pause"},initialize:function(){this.history=new Backbone.Collection([])}});var h=d.PlayerView=f.View.extend({template:sz.tmpl.player.player,
events:{"click      .player-control-button.player-play":"play","click      .player-control-button.player-pause":"pause","click      .player-control-button.player-skip":"skip","click      .player-control-button.player-vote-up":"voteUp","click      .player-control-button.player-vote-down":"voteDown","click      .player-song-history-controls .player-vote-up":"voteUp","click      .player-song-history-controls .player-vote-down":"voteDown","mouseenter .szi-song-display":"showStationInfo","mouseleave .szi-song-display":"hideStationInfo",
"mouseenter .szi-toggle-volume":"showVolumeControl","mouseleave .szi-toggle-volume":"hideVolumeControl","mouseenter .szi-toggle-chrome-cast":"showChromeCastControl","mouseleave .szi-toggle-chrome-cast":"hideChromeCastControl","click      .player-control-button.player-share":"showShare","click      .player-chrome-cast-receiver":"sendToChromeCast","click      .player-chrome-cast-disconnect":"disconnectChromeCast"},elements:{".player-volume-control":"$volumeControl",".player-state-display-error .player-state-display-info":"$errorMessage",
".szi-buffering":"$buffering"},css:"sz-player",states:{fixed:{set:!1,onCss:"sz-player-fixed"},state_station:{set:!0,onCss:"sz-player-state-station"},state_song:{set:!1,onCss:"sz-player-state-song"},state_error:{set:!1,onCss:"sz-player-state-error"},state_fetch_next:{set:!1,onCss:"sz-player-state-fetch-next"},play_state_play:{set:!1,onCss:"sz-player-play-state-play"},play_state_pause:{set:!0,onCss:"sz-player-play-state-pause"},buffering:{set:!1,onCss:"sz-player-buffering"},no_skip:{set:!1,onCss:"sz-player-no-skip"},
skip_disabled:{set:!1,onCss:"sz-player-skip-disabled"},info_shown:{set:!1,onCss:"sz-player-station-info-shown"},volume_shown:{set:!1,onCss:"sz-player-volume-shown"},chrome_cast_shown:{set:!1,onCss:"sz-player-chrome-cast-shown"},chrome_cast_active:{set:!1,onCss:"sz-player-chrome-cast-active"},supports_chrome_cast:{set:!1,onCss:"sz-player-supports-chrome-cast"}},initialize:function(b){var d=this;h.__super__.initialize.call(this,b);_.bindAll(this,"render");this.app=b.app;this.volumeCookieName="JS_PLAYER_VOLUME";
this.errorMessage="";this.songPlayEmitted=!1;this.app.bind("visitor-change",this.render);this.model.history.bind("change",this.render);this.model.history.bind("add",this.render);this.model.history.bind("remove",this.render);this.model.history.bind("reset",this.render);this.model.bind("change",this.render);this.model.bind("change:state",function(){_.each(["station","song","error","fetch_next"],function(a){d.setState("state_"+a,!1)});d.setState("state_"+d.model.get("state"),!0)});this.model.bind("change:playState",
function(){_.each(["play","pause"],function(a){d.setState("play_state_"+a,!1)});d.setState("play_state_"+d.model.get("playState"),!0);d.songTrigger(d.model.get("playState"));d.stationTrigger(d.model.get("playState"))});if(this.model.get("station").get("stream"))this.manager=new g.Manager({station:this.model.get("station"),volume:this.getSavedVolume()});else if(j.isCasting())this.manager=new c.Manager({station:this.model.get("station"),artist:b.artist,volume:this.getSavedVolume(),session:j.getSession(),
resumeState:b.resumeState});else{b={station:this.model.get("station"),artist:b.artist,volume:this.getSavedVolume(),resumeState:b.resumeState};if(Modernizr.is_safari)document.createElement("audio"),b.audioElement=document.createElement("audio"),b.html5=!0;this.manager=new a.Manager(b)}this.manager.supportsNext()||this.setState("no_skip",!0);j.bind("receiver-list-change",this.render);j.bind("cast-start",this.render);j.bind("cast-stop",this.render);this.manager.bind("metadata",function(a){d.trigger("metadata",
a)});this.manager.bind("fetching-next",function(){d.$errorMessage().empty();d.model.set({state:"fetch_next"})});this.manager.bind("skip-state-changed",function(a){a?(d.setState("skip_disabled",!1),d.$errorMessage().empty()):d.setState("skip_disabled",!0)});this.manager.bind("error",function(a){d.errorMessage=a.message;d.$errorMessage().empty().text(a.message);d.model.set({state:"error"});d.trigger("error",a)});this.manager.bind("song-started",function(a){d._songStarted(a.song)});this.manager.bind("started",
function(){d.model.set({playState:"play"})});this.manager.bind("song-skipped",function(a){d.songPlayEmitted=!1;d.songTrigger("skipped");d._songEnded(a.song)});this.manager.bind("song-completed",function(a){d.songPlayEmitted=!1;d.songTrigger("completed");d._songEnded(a.song)});this.manager.bind("song-state",function(a){if(a=a.songState)a.buffering?d._startSpinner():d._stopSpinner(),d.setState("buffering",a.buffering),a.duration>0&&d.setProgress(a.position/a.duration*100)});this.manager.bind("song-play",
function(){d.model.set({playState:"play"})});this.manager.bind("song-pause",function(){d.model.set({playState:"pause"})});this.manager.bind("stream-play",function(){d.model.set({playState:"play"})});this.manager.bind("stream-pause",function(){d.model.set({playState:"pause"})})},setProgress:_.throttle(function(a){this.$(".szi-progress .szi-bar").css("width",a+"%")},500),destroy:function(){h.__super__.destroy.call(this);this.manager.destroy()},updateProgress:function(){this.manager.songState()},stationTrigger:function(a){this.trigger("station-"+
a,{station:this.model.get("station")})},songTrigger:function(a){this.model.get("current")&&this.trigger("song-"+a,{station:this.model.get("station"),song:this.model.get("current"),songState:this.manager.songState()})},songState:function(){return this.manager.songState()},start:function(){this.manager.start()},play:function(){this.manager.play();return!1},pause:function(){this.manager.pause();return!1},shutdown:function(a,b){var c=this;this.manager.shutdown(a,function(){c.model.set({state:"shutdown"});
b&&b()})},isPlaying:function(){return this.model.get("playState")==="play"},isPaused:function(){return this.model.get("playState")==="pause"},skip:function(){this.manager.canSkip()&&this.manager.next()},_songStarted:function(a){a.bind("change",this.render);this.model.set({playState:"play",current:a,state:"song"});this.songTrigger("started")},_songEnded:function(){var a=this.model.get("current");a&&(a.unbind("all"),this.model.history.add(a,{at:0}),this.model.set({current:null,state:"station"}));this.model.history.models.length>
3&&this.model.history.remove(this.model.history.last())},allSongs:function(){var a=this.model.history.models,b=this.model.get("current");return _.union(a,b?[b]:[])},shareItem:function(){var a,c=this.model.get("station");a=this.model.get("current");a=a==null?"#NowPlaying "+c.get("name")+" Playlist":'#NowPlaying "'+a.get("title")+'" by '+a.get("artist")+" (on "+c.get("name")+")";return new b.SharePageItem({title:c.get("name"),description:c.get("description"),url:e.makeAbsolute(c.pageUrlPath()),image_url:c.get("cover_url"),
share_text:a})},songContext:function(a){return{song:a.toJSON(),song_id:a.cid,station:this.model.get("station").toJSON(),visitor:this.app.getVisitor().toJSON()}},render:function(){var a=this,c=this.model.get("station"),d=this.model.get("current");this.app.getVisitor();var e={station:c.toJSON(),station_url:c.pageUrlPath(),song:null,history:[],chrome_cast:{active:j.isCasting()}};a.setState("supports_chrome_cast",j.haveReceivers()&&j.canCast(c));a.setState("chrome_cast_active",j.isCasting());d&&(e.song=
this.songContext(d));this.model.history.each(function(b){e.history.push(a.songContext(b))});$(this.el).html(this.template(e));c=$(".szi-share-buttons",this.el);d=this.app.getSharingSystems();d=new b.Button({shareItem:this.shareItem(),shareSystems:d,app:this.app});c.empty().append(d.render().el);a.$volumeControl().slider({range:"min",min:1,max:100,value:this.getVolume(),orientation:"vertical"});a.$volumeControl().bind("slide",_.bind(function(a,b){this.setVolume(b.value,!0)},this));this.sync();this.$errorMessage().empty().text(this.errorMessage);
this.getState("buffering")&&this._startSpinner();return this},_startSpinner:function(){this.spinner=new Spinner({lines:12,length:7,width:2,radius:3,color:"#fff",speed:1,trail:50,shadow:!0});this.$buffering().empty().append(this.spinner.el);this.spinner.spin()},_stopSpinner:function(){this.spinner&&(this.spinner.stop(),delete this.spinner)},findSong:function(a){var b,c=this.allSongs();for(b=0;b<c.length;b++)if(c[b].cid==a)return c[b];throw Error("Unable to locate song with id["+a+"] in player"+a);
},voteUp:function(a){var a=this.findSong($(a.target).attr("data-sz-song-id")),b=a.get("streamSong");b&&(a.set({vote:"up"}),b.voteUp(),this.songTrigger("vote-up"));return!1},voteDown:function(a){var a=this.findSong($(a.target).attr("data-sz-song-id")),b=a.get("streamSong");b&&(a.set({vote:"down"}),b.voteDown(),this.songTrigger("vote-down"));a.cid===this.model.get("current").cid&&this.manager.next();return!1},startLockedMute:function(){this.setVolume(0);this.$volumeControl().slider("disable")},stopLockedMute:function(){this.setVolume(this.getSavedVolume());
this.$volumeControl().slider("enable")},setVolume:function(a,b){a=parseInt(a);this.manager&&this.manager.setVolume(a);b&&$.cookie(this.volumeCookieName,a,{expires:365,path:"/"})},getSavedVolume:function(){var a=$.cookie(this.volumeCookieName);return a!==null?parseInt(a,10):(a=parseInt((new Date-new Date("March 17, 2013"))/864E5),a>=10?100:50+5*a)},getVolume:function(){return this.manager.getVolume()},showStationInfo:function(){this.setState("info_shown",!0)},hideStationInfo:function(){this.setState("info_shown",
!1)},showVolumeControl:function(){this.setState("volume_shown",!0)},hideVolumeControl:function(){this.setState("volume_shown",!1)},showChromeCastControl:function(){this.setState("chrome_cast_shown",!0)},hideChromeCastControl:function(){this.setState("chrome_cast_shown",!1)},showShare:function(a){var c,d=this.shareItem();a.stopPropagation();a=(new b.Menu({shareItem:d,shareSystems:this.app.getSharingSystems()})).render();a.bind("share-completed",function(){c.modal("hide")});c=$(sz.tmpl.sharing.modal({item:d.toJSON()}));
$(this.app.view.el).append(c);c.find(".modal-body .szi-info").append(a.el);c.modal();c.on("hidden",function(){c.detach()});this.app.bind("page-navigate",function(){c.modal("hide")})},sendToChromeCast:function(){j.startCast()},disconnectChromeCast:function(){j.stopCast()},getManager:function(){return this.manager}});return d});define("songza/sharing",["songza/base"],function(f){function e(){var a,b,d=["property","name"];for(a=0;a<arguments.length;a++)for(b=0;b<d.length;b++){var e=$("meta["+d[b]+"='"+arguments[a]+"']").attr("content");if(e=(e||"").replace(/^\s*([\S]*)\s*$/,"$1"))return e}return null}var b={};b.SharePageItem=f.Model.extend({defaults:{title:null,description:null,url:null,image_url:null,share_text:null}},{forCurrentPage:function(){var a={title:e("og:title")||$("title").text(),url:e("share_url","og:url")||window.location.href,
description:e("og:description","description"),image_url:e("og:image"),share_text:e("share_text","og:title")||$("title").text()};return new b.SharePageItem(a)},forElementWithDataAttributes:function(a){if(!$(a).data("share-title"))return!1;a={title:$(a).data("share-title")||e("og:title")||$("title").text(),url:$(a).data("share-url")||e("share_url","og:url")||window.location.href,description:$(a).data("share-title")||e("og:description","description"),image_url:$(a).data("share-image-url")||e("og:image"),
share_text:$(a).data("share-title")||e("share_text","og:title")||$("title").text()};return new b.SharePageItem(a)}});b.Button=f.View.extend({css:"sz-share-button btn",initialize:function(a){var c=this;b.Button.__super__.initialize.call(this,a);this.app=a.app;this.shareItem=a.shareItem;this.shareSystems=a.shareSystems;$(this.el).click(function(a){c.showModal(a)})},hideModal:function(){this.modal&&this.modal.modal("hide")},showModal:function(a){var c=this;a.stopPropagation();if(!this.modal){a=(new b.Menu({shareItem:this.shareItem,
shareSystems:this.shareSystems})).render();a.bind("share-completed",function(){c.hideModal()});var d=$(sz.tmpl.sharing.modal({item:this.shareItem.toJSON()}));$(this.app.view.el).append(d);d.find(".modal-body .szi-info").append(a.el);d.modal();d.on("hidden",function(){d.detach();c.modal=null});this.app.bind("page-navigate",function(){c.hideModal()});this.modal=d}},render:function(){$(this.el).text("Share");this.sync();return this}});b.Menu=f.View.extend({css:"sz-sharing-menu",initialize:function(a){var c=
this;b.Menu.__super__.initialize.call(this,a);this.shareItem=a.shareItem;this.shareSystems=_.map(a.shareSystems,function(a){a=new a({shareItem:c.shareItem});a.bind("share-completed",function(a){c.trigger("share-completed",a)});return a})},context:function(){return{shareItem:this.shareItem.toJSON()}},render:function(){var a=this,b=$("<ul>");$(this.el).empty().append(b);_.each(this.shareSystems,function(d,e){var f=$("<li>").append(d.render().el);a.shareSystems.length-1==e&&f.addClass("szi-last");b.append(f)});
this.sync();return this}});return b});define("songza/ads/manager",["songza/base","songza/config"],function(f){var e={DEBUG:!1};e.Slot=Backbone.View.extend({initialize:function(b){this.options=this.options||b||{};this.default_ad=b.default_ad;this.target_selector=b.target_selector;this.overrides=[];this._rendered=!1;this.cb=b.cb},push:function(b){this.overrides.push(b)},pop:function(){this.overrides.pop()},popAll:function(){this.overrides=[]},activeAd:function(){if(this.overrides.length>0)return this.overrides[this.overrides.length-1];
return this.default_ad},inDOM:function(){return $(this.target_selector).size()===1},isEmpty:function(){return $(this.target_selector).children().size()===0},isAllowedByCallback:function(){return this.cb?this.cb():!0},empty:function(){this.$el.empty()},render:function(){var b=this.activeAd();this.empty();b.setElement(this.$el);b.render();$(this.target_selector).empty().append(this.$el);return this}});e.Manager=f.Class.extend({initialize:function(b){this.max_refresh_seconds=b.max_refresh_seconds;this.max_idle_seconds=
b.max_idle_seconds;this.refresh_inactive=b.refresh_inactive;this.pre_refresh=b.pre_refresh;this.slots=b.slots||[];this.last_refreshed=null;this.idleTimer=(this.idleTimer=$(document).idleTimer({timeout:this.max_idle_seconds?this.max_idle_seconds*1E3:3E3}))||$(document);this.enabled=!0},disable:function(){if(this.enabled)_.each(this.slots,function(b){b.inDOM()&&b.isAllowedByCallback()&&b.empty()}),this.enabled=!1},enable:function(){if(!this.enabled)_.each(this.slots,function(b){b.inDOM()&&b.isAllowedByCallback()&&
b.render()}),this.enabled=!0},refresh:function(b){var a=this,c=(new Date).getTime(),d=this.max_refresh_seconds*1E3,g=!0,b=b||{};if(this.enabled)this.last_refreshed&&c<this.last_refreshed+d&&(e.DEBUG&&console.log("Ads were refreshed recently, skipping refresh"),g=!1),!this.refresh_inactive&&this.idleTimer.data("idleTimer")==="idle"&&(e.DEBUG&&console.log("User is idle, skipping refresh"),g=!1),b.force&&(g=!0),b=function(){_.each(a.slots,function(a){e.DEBUG&&console.log("maybe refreshing ad: ",a.target_selector,
"do_refresh",g,"is empty",a.isEmpty(),"in dom",a.inDOM(),"callback",a.isAllowedByCallback());if(a.inDOM()&&a.isAllowedByCallback()&&(g||a.isEmpty()))e.DEBUG&&console.log("refreshing ad",a.target_selector),a.render()})},this.pre_refresh?this.pre_refresh(b,g):b(),this.last_refreshed=c}});return e});define("songza/ads/iframe",["songza/base"],function(f){var e={};e.Ad=f.View.extend({render:function(){var b=$("<iframe>");b.attr("src",this.options.url);b.attr("width",this.options.width);b.attr("height",this.options.height);b.attr("scrolling","no");b.attr("frameBorder","0");b.addClass("sz-ad-frame");$(this.el).append(b);return this},start:function(){var b=this;this.options.duration&&_.delay(function(){b.trigger("ad-ended")},this.options.duration*1E3)}});return e});define("songza/ads/vast",["songza/base","songza/templates/ads"],function(f,e){var b={},a=null;window.onAdSchedulingComplete=function(b){a&&b.length==0&&a.trigger("no-ad")};window.onVASTLoadFailure=function(){a&&a.trigger("no-ad")};window.onTemplateLoadTimeout=function(){a&&a.trigger("no-ad")};window.onTemplateLoadFailure=function(){a&&a.trigger("no-ad")};window.onAdSlotLoadTimeout=function(){a&&a.trigger("no-ad")};window.onAdSlotLoadError=function(){a&&a.trigger("no-ad")};window.onVPAIDAdError=function(b){if(a)a.trigger("no-ad"),
console.log("vast.js: onVPAIDAdError"),window._onVPAIDAdError_ad=b};window.onOVAReadyToPlay=function(){a&&a.trigger("ad-ready")};window.onLinearAdStart=function(){a&&(a.setState("initializing",!1),a.trigger("ad-started"))};window.onVPAIDAdStart=function(){a&&(a.setState("initializing",!1),a.trigger("ad-started"))};window.onLinearAdFinish=function(){a&&a.trigger("ad-ended")};window.onVPAIDAdComplete=function(){a&&a.trigger("ad-ended")};window.onVASTLoadSuccess=function(b){a&&b.indexOf("<?xml")===-1&&
a.trigger("no-ad")};window.onVPAIDAdPaused=function(){a.trigger("ad-paused")};window.onVPAIDAdPlaying=function(){a.trigger("ad-resumed")};b.Player=f.View.extend({css:"sz-ads-vast",template:e.providerVast,initialize:function(a){b.Player.__super__.initialize.call(this,a);this._autoplay=!a||a.autoplay===void 0||a.autoplay===!0;this._configured=!1;this._static_url=a.static_url;if(!a.static_url)throw Error("static_url was not present in options");b.Player.setActivePlayer(this)},states:{initializing:{set:!0,
onCss:"sz-ads-vast-initializing"}},configure:function(){if(!this._configured){this._configured=!0;var a={volume:this.options.volume||50,debug:{"debugger":"firebug",levels:"fatal, config, vast_template"},overlays:{regions:[{id:"ad-notice",verticalAlign:"top",horizontalAlign:"left",backgroundColor:"transparent",width:"100pct",height:40,style:".smalltext { font-style: italic; font-size:10; }"}]},canFireAPICalls:!0,ads:{pauseOnClickThrough:!0,deliveryType:"progressive",displayCompanions:!0,notice:{type:"countdown"},
companions:[{id:"vast-image-ad-"+this.cid,width:"300",height:"250"}],schedule:[{position:"pre-roll",notice:{show:!0,region:"ad-notice",message:"Advertisment _countdown_ seconds"},server:{type:"direct",tag:this.options.tag+(new Date).getTime()}}]}},b={flashplayer:this._static_url+"swf/jwplayer/player.swf",controlbar:"none",autostart:this._autoplay?!0:!1,plugins:{},events:{onComplete:window.onLinearAdFinish}};b.plugins[this._static_url+"swf/jwplayer/ova-jw.js"]={json:JSON.stringify(a)};this.player=
jwplayer("vast-video-ad-"+this.cid).setup(b)}},play:function(){this.player.play()},start:function(){this.configure();this.play()},context:function(){return{view_id:this.cid}}},{setActivePlayer:function(b){a=b},getActivePlayer:function(){return a}});return b});define("songza/ads/vast-station-modal",["songza/app","songza/ads/vast","songza/templates/ads"],function(f,e,b){return{renderPreRollVast:function(a,c,d,g){var j,h,i,l,g=_.defaults(g||{},{autoplay:!0,upsell_template:!1});j=f.getInstance();l=j.getConfig().static_url;h=c?$(b.preRollModal({station:c.toJSON()})):$(b.preRollModal({station:{name:"Your music"}}));h.addClass("sz-ad-preroll");h.addClass("szi-ad-preroll-offscreen");i=new e.Player({tag:a,autoplay:g.autoplay,static_url:l});$(j.view.el).append(h);
h.find(".modal-body").append(i.render().el);g.upsell_template&&h.find(".modal-upsell").append(g.upsell_template);h.on("hidden",function(){h.detach()});i.bind("ad-started",function(){h.removeClass("szi-ad-preroll-offscreen");h.modal({keyboard:!1,backdrop:"static"})});i.bind("ad-ended no-ad",function(){h.modal("hide");h.detach();d()});i.bind("ad-paused",function(){h.find("#vast-video-ad-pause-message").removeClass("hidden")});i.bind("ad-resumed",function(){h.find("#vast-video-ad-pause-message").addClass("hidden")});
if(g.autoplay)i.start();else return i.configure(),{vastPlayer:i,play:function(a,b){a&&h.find(".modal-footer .station-name").text(a.toJSON().name);b&&(d=b);i.play()}}},renderPreRollVast_bklyn:function(a,b,d,g){var j,h,i,g=_.defaults(g||{},{autoplay:!0,upsell_template:!1});i=f.getInstance().getConfig().static_url;j=b?$(sz.tmpl.ads.preRollModal({station:b.toJSON()})):$(sz.tmpl.ads.preRollModal({station:{name:"Your music"}}));$("body").addClass("ad-preroll-preload-offscreen");h=new e.Player({tag:a,autoplay:g.autoplay,
static_url:i});j.find(".modal-body").append(h.render().el);g.upsell_template&&j.find(".modal-upsell").append(g.upsell_template);$.colorbox({html:j.html(),closeButton:!1,escKey:!1,overlayClose:!1,className:"modal-overlay",transition:"fade",opacity:0.85,scrolling:!1,open:!0,height:"460px",width:"800px",trapFocus:!1});h.bind("ad-started",function(){$("body").removeClass("ad-preroll-preload-offscreen")});h.bind("ad-ended no-ad",function(){$.colorbox.remove();d()});h.bind("ad-paused",function(){$("#vast-video-ad-pause-message").removeClass("hidden")});
h.bind("ad-resumed",function(){$("#vast-video-ad-pause-message").addClass("hidden")});if(g.autoplay)h.start();else return h.configure(),{vastPlayer:h,play:function(a,b){a&&j.find(".modal-footer .station-name").text(a.toJSON().name);b&&(d=b);h.play()}}}}});define("songza/ads/targetspot",["songza/base","songza/templates/ads"],function(f,e){var b={},a=null;window.tspot_ad_width="300";window.tspot_ad_height="250";window.tspot_container_id="tspot_companion_ad_div";window.ts_mutePlayer=function(){console.log("targetspot mute requested");a&&a.trigger("ad-mute-requested")};window.ts_unmutePlayer=function(){console.log("targetspot unmute requested");a&&a.trigger("ad-unmute-requested")};window.ts_adStarted=function(){console.log("targetspot ad started");a&&
a.trigger("ad-started")};window.ts_adFinished=function(){console.log("targetspot ad ended");a&&a.trigger("ad-ended")};window.ts_noAds=function(){console.log("targetspot has no ad");a&&a.trigger("no-ad")};b.initialized=!1;b.initialize=function(a){if(b.initialized)throw Error("Attempt to initialize targetspot twice");var d={w:1,h:1,v:a.volume,s:a.station_id,htmlBanner:1};b.initialized=!0;window.ts_swf_embed(a.container,d)};b.setStationId=function(a){window.ts_setStation({stationId:a})};b.Player=f.View.extend({css:"sz-ads-targetspot",
template:e.providerTargetSpot,initialize:function(c){b.Player.__super__.initialize.call(this,c);a=this},start:function(){window.ts_setVolume({volume:this.options.volume});window.ts_streamEvent({eventType:"playAd",eventDuration:this.options.duration})},stop:function(){window.ts_streamEvent({eventType:"interruptAd"})}});return b});define("songza/utils",["songza/base"],function(f){var e={firstMeta:function(){var b,a,c=["property","name"];for(b=0;b<arguments.length;b++)for(a=0;a<c.length;a++){var d=$("meta["+c[a]+"='"+arguments[b]+"']").attr("content");if(d=(d||"").replace(/^\s*([\S]*)\s*$/,"$1"))return d}return null}};e.pageId=function(){return e.firstMeta("sz:identifier")};e.commentUrl=function(){return e.firstMeta("sz:comment-url")};e.currentUrl=function(b){var a="",b=b||{};if(!b.no_protocol)a=window.location.protocol;a+=
window.location.host;a+=e.currentPath();return a};e.currentPath=function(){return"/"+Backbone.history.getFragment()};e.requestJSON=function(b,a,c,d){c=c||{};return $.ajax({url:b,data:e.formQuery(a||{}),type:d||"GET",dataType:"json",success:c.success,failure:c.error})};e.getJSON=function(b,a,c){return e.requestJSON(b,a,c,"GET")};e.postJSON=function(b,a,c){return e.requestJSON(b,a,c,"POST")};e.bindPromise=function(b,a){a&&$.when(b).then(a.success,a.error);return b};e.formQuery=function(b){var a,c,d,
e=[];for(a in b){c=_.isArray(b[a])?b[a]:[b[a]];for(d=0;d<c.length;d++)e.push(encodeURIComponent(a)+"="+encodeURIComponent(c[d]))}return e.join("&")};e.FilteredCollectionMixin={_filters:function(){this.hasOwnProperty("_collectionFilters")||(this._collectionFilters={});return this._collectionFilters},addFilter:function(b,a){this._filters()[b]=a},getFilter:function(b){var a=this._filters();if(a.hasOwnProperty(b))return a[b];throw Error("Filter "+b+" was not set for collection: "+this);},clearFilters:function(){delete this._collectionFilters},
url:function(){var b=this.urlBase;_.isFunction(b)&&(b=b.call(this));return b+"?"+e.formQuery(this._filters())}};e.DateHelper={iso8601:function(b){function a(a){return a<10?"0"+a:a}var c,d,e;if(!isFinite(b.valueOf()))return null;c=b.getTimezoneOffset()<0?"-":"+";d=Math.abs(parseInt(b.getTimezoneOffset()/60,10));e=Math.abs(b.getTimezoneOffset()-60*d);return b.getFullYear()+"-"+a(b.getMonth()+1)+"-"+a(b.getDate())+"T"+a(b.getHours())+":"+a(b.getMinutes())+":"+a(b.getSeconds())+c+a(d)+":"+a(e)},epoch_seconds_to_date:function(b){var a=
new Date;a.setTime(b*1E3);return a},time_ago_in_words_with_parsing:function(b){var a=new Date;a.setTime(Date.parse(b));return this.time_ago_in_words(a)},time_ago_in_words:function(b){return this.distance_of_time_in_words(new Date,b)},distance_of_time_in_words:function(b,a){var c=Math.floor((b-a)/1E3/60);if(c<1)return"less than a minute ago";if(c===1)return"a minute ago";if(c<45)return c+" minutes ago";if(c<90)return"about 1 hour ago";if(c<1440)return"about "+Math.floor(c/60)+" hours ago";if(c<2880)return"1 day ago";
if(c<43200)return Math.floor(c/1440)+" days ago";if(c<86400)return"about 1 month ago";if(c<525960)return Math.floor(c/43200)+" months ago";if(c<1051199)return"about 1 year ago";return"over "+Math.floor(c/525960)+" years ago"},format_unit:function(b,a,c){return b===1?"One "+a:b+" "+c},time_span_in_words:function(b){var a=parseInt(b/86400),c=parseInt((b-86400*a)/3600),d=parseInt((b-86400*a-3600*c)/60),b=parseInt(b-86400*a-3600*c-60*d),g=[];a>0?(g.push(e.DateHelper.format_unit(a,"day","days")),g.push(e.DateHelper.format_unit(c,
"hour","hours"))):c>0?(g.push(e.DateHelper.format_unit(c,"hour","hours")),g.push(e.DateHelper.format_unit(d,"minute","minutes"))):(d>0&&g.push(e.DateHelper.format_unit(d,"minute","minutes")),g.push(e.DateHelper.format_unit(b,"second","seconds")));return g.join(", ")}};e.WordMatcher=function(b,a){var c=(b||"").toLowerCase().split(/\s+/);return function(b){var b=a(b).toLowerCase(),e;for(e=0;e<c.length;e++)if(b.indexOf(c[e])<0)return!1;return!0}};e.FreshnessGuarantee=f.Class.extend({initialize:function(b){this.collection=
b.collection;this.refreshInterval=b.fetchInterval;this.state=0;this.lastFetched=null},fetching:function(){return this.state===1},notFetched:function(){return this.state===0},fetched:function(){return this.state===2},isStale:function(){if(!this.lastFetched)return!1;return this.lastFetched.getTime()+this.refreshInterval*1E3<(new Date).getTime()},ensureFreshness:function(){var b=this;if(!this.fetching()&&(this.notFetched()||this.isStale()))this.state=1,this.collection.fetch({success:function(){b.lastFetched=
new Date;b.state=2;b.collection.trigger("fetch");b.trigger("state-change")},error:function(){b.state=0}})}});e.SimpleCollectionView=f.View.extend({collection:new Backbone.Collection([]),initialize:function(b){e.SimpleCollectionView.__super__.initialize.call(this,b);_.bindAll(this,"syncCollectionContainerEl");this.collection=b.collection;this.mustFetch=b.mustFetch;this.useCid=b.useCid;this.modelContextName=b.modelContextName||"model";this.collectionFreshen=new e.FreshnessGuarantee({collection:this.collection,
fetchInterval:b.fetchInterval});this.collection.bind("reset",this.syncCollectionContainerEl);this.collection.bind("add",this.syncCollectionContainerEl);this.collection.bind("remove",this.syncCollectionContainerEl);this.collection.bind("change",this.syncCollectionContainerEl)},collectionContainerEl:function(){return $("<div>")},modelList:function(){return this.collection.models},syncCollectionContainerEl:function(){var b=this,a=this.collectionContainerEl(),c=this.modelList(),d=$("<ul>");a.empty();
c.length==0?this.collectionFreshen.fetching?a.append($("<div>").addClass("szi-fetching").text("Fetching")):a.append($("<div>").addClass("szi-empty").text("No Models")):(_.each(c,function(a){var c={},e=$("<li>");c[b.modelContextName]=b.contextForModel(a);e.html(b.modelTemplate(c));e.attr("data-sz-model-id",b.idForModel(a));d.append(e)}),a.append(d),d.children("li:last-child").addClass("szi-last"))},idForModel:function(b){return this.useCid?b.cid:b.id},highlightModel:function(b){var a=this,c=this.collectionContainerEl().find("ul").first().children("li").filter(function(){return $(this).attr("data-sz-model-id")==
a.idForModel(b)});this.collectionContainerEl().find("ul > li").removeClass("szi-highlighted");c.addClass("szi-highlighted");c.slideUp(0).slideDown(function(){a.collectionContainerEl().scrollTo(c);setTimeout(function(){c.removeClass("szi-highlighted")},2E3)})},contextForModel:function(b){return b.toJSON()},context:function(){var b=this,a={models:_.map(this.modelList(),function(a){return b.contextForModel(a)})};this.mustFetch&&this.collectionFreshen.ensureFreshness();return a},render:function(){e.SimpleCollectionView.__super__.render.call(this);
this.syncCollectionContainerEl();return this}});return e});define("songza/sites/black_planet/ad-zones",["songza/app","songza/config","songza/utils","songza/ads/iframe","songza/ads/targetspot","songza/ads/vast","songza/ads/vast-station-modal"],function(f,e,b,a,c,d,g){function j(a,b){t[a].push(b);h(a)}function h(a){var b,c;for(b in r)a&&b!==a||(c=r[b],t[b].length>0&&(c=_.last(t[b])),$("#ad-"+b).empty(),c(b,$("#ad-"+b)))}function i(b){var c,d,e;console.log("Parsing Ando Ad: ",b.url);if(b.url[0]==="|"&&(c=b.url.split("|")[1])&&c.match(p))d=b.url.split("|")[2],
d.indexOf("duration=")===0&&(d=parseInt(d.split("=")[1],10),e=function(b,g){var f=new a.Ad({url:c,width:300,height:250,duration:d});g.append(f.render().el);f.bind("ad-ended",function(){t.side=_.without(t.side,e);h("side")});f.start()},j("side",e))}function l(a){var b,d,e,g;console.log("Parsing TargetSpot Ad: ",a.url);b=a.url.split("|");for(a=0;a<b.length;a++)if(d=b[a].split("="),!(d.length<2)&&d[0]==="duration"){e=parseInt(d[1],10);break}e&&(g=function(a,b){var d=m.getPlayer(),f=new c.Player({duration:e,
volume:d.getVolume()}),j=function(){t.side=_.without(t.side,g);h("side")};f.bind("no-ad",j);f.bind("ad-ended",j);f.bind("ad-mute-requested",function(){d.startLockedMute()});f.bind("ad-unmute-requested",function(){d.stopLockedMute()});m.bind("page-navigate",function(){d.stopLockedMute();d.stop()});b.append(f.render().el);f.start()},j("side",g))}function k(){window.BP_AD_CONTEXT.zone=q.current();window.BP_AD_CONTEXT.station=q.station()}function n(b){var d=!0;m=b.getInstance();k();b.addDOMEnhancement(y);
b.setStationPrePlayHook(x);h();m.bind("page-navigate-start",function(){k()});m.bind("page-navigate-failure",function(){k()});m.bind("page-navigate",function(){k();h()});m.bind("player-station-started",function(b){var e=m.getStationMeta(b.station);k();d=!0;e&&e.ad_default&&j("side",function(c,d){var g={url:"/sites/black_planet/station/"+b.station.get("id")+"/ad/default/",width:e.ad_default_width,height:e.ad_default_height},g=new a.Ad(g);d.append(g.render().el);g.start()});e&&e.targetspot_station_id&&
(c.initialized?c.setStationId(e.targetspot_station_id):($("body").append($("<div>").attr("id","targetspot-sdk")),c.initialize({station_id:e.targetspot_station_id,width:300,height:250,volume:m.getPlayer().getVolume(),container:"targetspot-sdk"})))});m.bind("player-station-stopped",function(){k();for(var a in t)t[a]=[];h()});m.bind("player-song-started",function(){d?d=!1:h()});m.bind("player-metadata",function(a){var b=m.getPlayer(),c=m.getStationMeta(b.model.get("station"));b.model.get("station").get("type")===
"stream"&&(a.artist==="BREAK"?i(a):a.artist==="TARGETSPOT"&&c&&c.targetspot_station_id&&l(a))})}if(_.indexOf(e.site_custom_plugins,"songza/sites/black_planet/ad-zones")!==-1){window.BP_AD_CONTEXT={zone:"_default",station:""};var m,p=/^http[s]?:\/\//,o=[[/^\/$/,"home"],[/^\/login\/$/,"login"],[/^\/discover\/$/,"discover"],[/^\/contribute\/.*$/,"contribute"],[/^\/search\/.*$/,"search"],[/^\/user\/([^/]+)\/.*$/,"user-$1"],[/^\/listen\/([^/]+)\/.*$/,"station-$1"],[/^\/discover\/([^/]+)\/$/,"tag-$1"],
[/^\/discover\/[^/]+\/([^/]+)\/$/,"gallery-$1"],[/^\/discover\/[^/]+\/[^/]+\/([^/]+)\/$/,"station-$1"],[/^\/sites\/black_planet\/contest\/verizon-2012\/$/,"verizon-2012"]],q={current:function(){var a=b.currentPath().split("?")[0],c,d;for(d=0;d<o.length;d++)if(c=a.match(o[d][0])){a=o[d][1];for(d=0;d<c.length;d++)a=a.replace("$"+d,c[d]);return a}return"_default"},station:function(){var a=f.getInstance().getPlayer();return a?a.model.get("station").get("dasherized_name"):""}},r={top:function(b,c){var d=
new a.Ad({url:"/advertising/top/",width:970,height:90});c.append(d.render().el);d.start()},bottom:function(b,c){var d=new a.Ad({url:"/advertising/bottom/",width:728,height:90});c.append(d.render().el);d.start()},side:function(b,c){var d=new a.Ad({url:"/advertising/side/",width:300,height:250});c.append(d.render().el);d.start()}},t={top:[],bottom:[],side:[]},y=function(b){$(".sz-bp-ad",b).each(function(){var b=$(this),c=b.attr("data-sz-url"),d=parseInt(b.attr("data-sz-width"),10),e=parseInt(b.attr("data-sz-height"),
10),c=new a.Ad({url:c,width:d,height:e});b.empty().append(c.render().el);c.start()})},x=function(a,b){var c=m.getStationMeta(a);!c||!c.ad_preroll?b():g.renderPreRollVast(c.ad_preroll,a,b)};return{register:function(a){n(a)}}}});define("songza/sites/black_planet/station-rails",["songza/app","songza/config","songza/models"],function(f,e,b){function a(){var a,e,f;e=$(".sz-station-page");if(e.length!=0&&(a=parseInt(e.attr("data-sz-station-id"),10),a=new b.Station({id:a}),(a=c.getStationMeta(a))&&a.right_rail_url))e=e.parents("#content").find("#right-rail"),f=$("<iframe>"),f.attr("src",a.right_rail_url),f.attr("width",a.right_rail_width),f.attr("height",a.right_rail_height),f.attr("scrolling","no"),f.attr("frameBorder","0"),
e.empty().append(f)}if(_.indexOf(e.site_custom_plugins,"songza/sites/black_planet/station-rails")!==-1){var c;return{register:function(b){c=b.getInstance();c.bind("page-navigate",a);c.bind("station-meta-changed",a);a()}}}});define("songza/sites/black_planet/omniture",["songza/config","songza/utils"],function(f,e){function b(){window.s&&c&&d()}function a(a){var b,c={},a=a||{};if(window.s){for(b in a)c[b]=s[b],s[b]=a[b];var a=window.s.t(),d=$("<div>").attr("id","bp-omniture");$("#bp-omniture").remove();$("body").append(d);a&&d.html(a);for(b in c)s[b]=c[b]}}var c;if(_.indexOf(f.site_custom_plugins,"songza/sites/black_planet/omniture")!==-1){require(["http://w.bpcdn.us/00062028/js/vs_code.js"],function(){if(window.s_gi){var a=
window.s_gi("cconbpradio,cconbpuniverse,cconcvradionext");window.s=a;a.usePlugins=!0;a.doPlugins=function(a){var b=(new Date).getFullYear(),c=e.currentPath(),d=c==="/"?"Home":$("title").text();a.prop11=a.getTimeParting("h","-5",b.toString());a.prop12=a.getTimeParting("d","-5",b.toString());a.prop13=a.getTimeParting("w","-5",b.toString());a.Linkdownloadfiletypes="exe,zip,wav,mp3,mov,mpg,avi,wmv,doc,pdf,xls";a.events="event2";a.linkTrackEvents="none";a.hier1="login";a.hier2="songza";a.linkInternalFilters=
"javascript:,"+document.domain;a.trackingServer="vs.blackplanet.com";a.trackingServerSecure="vss.blackplanet.com";a.pageName=d;a.pageUrl=c;a.eVar2="songza:"+c;a.prop2="songza:"+c;a.linkLeaveQueryString=!1;a.trackDownloadLinks=!0;a.trackExternalLinks=!0;a.trackInlineStats=!0;a.prop5="";a.eVar5="";a.linkTrackVars="none";a.campaign=a.getQueryParam("omcamp")};require(["http://w.bpcdn.us/00062028/js/s_code.js"],b)}});var d=_.once(function(){a()});return{register:function(d){c=d.getInstance();c.bind("page-navigate",
function(){a()});c.bind("player-song-started",function(b){a({prop14:b.station.get("name"),prop15:b.song.get("title")})});b()}}}});define("songza/sites/songza/ads",["songza/app","songza/config","songza/utils","songza/ads/manager","songza/ads/iframe"],function(f,e,b,a,c){function d(){var a=b.currentPath().split("?")[0],c,d;for(d=0;d<r.length;d++)if(c=a.match(r[d][0]))return r[d][1];return"default"}function g(){var a=b.currentPath().split("?")[0],c,d;for(d=0;d<r.length;d++)if((c=a.match(r[d][0]))&&c.length>1)return c[1];return""}function j(){var a=f.getInstance().view,b="";$(a.el).find(".sz-station-page").each(function(a,c){b=
$(c).attr("data-sz-station-id")});return b}function h(){var a=p.getInstance().getEnvironment();return a.session_config&&a.session_config.dfp&&a.session_config.dfp.keywords?a.session_config.dfp.keywords:[]}function i(a,b){var c=_.keys(a.targeting),d,e,f;for(d=0;d<c.length;d++)if(e=c[d],f=a.targeting[e],!(f===""||f===void 0||f===null))if(e=b[e],f!==e)return!1;return!0}function l(){var a=p.getInstance(),b=a.getEnvironment(),c=window.SZ_AD_UTIL.getTargeting(),d={};_.each(c,function(a){d[a.key]=a.value});
b=_.sortBy(b.site_takeovers,function(a){return a.priority});b=_.filter(b,function(a){var b=!1;_.each([],function(a){d.subject===a&&(b=!0)});if(b)return!1;return i(a,d)});if(b.length>0&&a.featureEnabled("advertising.display")){a=(new Date).getTime();o=b[0];o.cache_busted_impression_url=null;if(o.impression_url)o.cache_busted_impression_url=o.impression_url.replace("%%CACHEBUSTER%%",a);o.cache_busted_click_url=o.click_url.replace("%%CACHEBUSTER%%",a);$("body").addClass("sz-takeover");$("body").css("background-color",
o.background_color);$("body").css("background-image","url('"+o.background_url+"')");o.hide_top_ad?$("body").addClass("sz-hide-top-ad"):$("body").removeClass("sz-hide-top-ad");o.cache_busted_impression_url&&(a=$("<img>").attr("id","site-takeover-tracker").attr("src",o.cache_busted_impression_url).attr("width","1").attr("height","1"),$("#site-takeover-tracker").remove(),$("body").append(a))}else o=null,$("body").removeClass("sz-takeover"),$("body").css("background-color",""),$("body").css("background-image",
""),$("body").removeClass("sz-hide-top-ad"),$("#site-takeover-tracker").remove()}function k(a){o&&$(a.target).hasClass("sz-takeover")&&window.open(o.cache_busted_click_url)}function n(a){var b=window.SZ_AD_UTIL;b.clearTransientTargeting();b.addTransientTargeting("day",a.context.get("day"));b.addTransientTargeting("period",a.context.get("period"));_.each(a.parentSituations,function(a,c){b.addTransientTargeting("situation"+c,a.get("id"))})}function m(){require(["http://c.amazon-adsystem.com/aax2/amzn_ads.js"],
function(){try{window.amznads&&window.amznads.getAdsAsync("3040")}catch(a){}})}if(_.indexOf(e.site_custom_plugins,"songza/sites/songza/ads")!==-1){var p,o,q=[],r=[[/^\/$/,"home"],[/^\/login\/$/,"login"],[/^\/discover\/$/,"discover"],[/^\/contribute\/.*$/,"contribute"],[/^\/search\/.*$/,"search"],[/^\/user\/[^/]+\/.*$/,"user"],[/^\/listen\/([^/]+)\/.*$/,"station"],[/^\/discover\/[^/]+\/$/,"tag"],[/^\/discover\/[^/]+\/[^/]+\/$/,"gallery"],[/^\/discover\/[^/]+\/[^/]+\/([^/]+)\/$/,"station"]];window.SZ_AD_UTIL=
{getTargeting:function(){var a=[],c=b.currentPath().split("?")[0];a.push({key:"path",value:c});a.push({key:"section",value:d()});a.push({key:"subject",value:g()});a.push({key:"station",value:j()});_.each(h(),function(b){a.push(b)});_.each(q,function(b){a.push(b)});return a},setTargeting:function(a){var b=window.SZ_AD_UTIL.getTargeting();_.each(b,function(b){a.setTargeting(b.key,b.value)})},clearTransientTargeting:function(){q=[]},addTransientTargeting:function(a,b){q.push({key:a,value:b})}};return{register:function(d){function f(){r.refresh()}
function g(){r.refresh({force:!0})}function h(a){var b=0,c=0,d,e;setInterval(function(){if(!(c>0)){var f=$(a),C=f.find("iframe");if(f.length&&C.length){try{var g=C.contents(),h=g.height(),j=g.width()}catch(i){return}d&&e&&d==h&&e==j?b=0:d&&h<d&&b<1500?b+=50:(d=h,e=j,b=0,c=2,g=function(){c-=1},f.animate({height:d,width:e},{complete:g}),C.animate({height:d,width:e},{complete:g}))}}},50)}function i(){var a;a=b.currentPath().split("?")[0];var d=q["#ad-side"];a==="/"||a==="/popular/"?(a=new c.Ad({url:"/advertising/side/300x250/",
width:300,height:250}),d.push(a)):d.popAll();j.featureEnabled("advertising.display")?(r.enable(),$("html").removeClass("sz-no-ads")):(r.disable(),$("html").addClass("sz-no-ads"))}m();var j=d.getInstance(),o=e.adSlotConfig||[["/advertising/top/",728,90,"#ad-top",{resizeAd:!0}],["/advertising/bottom/",728,90,"#ad-bottom"],["/advertising/side/",300,600,"#ad-side"]];p=d;var q={},d=_.map(o,function(b){var d=b[0],e=b[1],f=b[2],g=b[3],i=b[4]||{};i.resizeAd&&h(g);b=null;i.fullplayerStatus!==void 0&&(b=function(){return j.view.getState("fullplayer_show")===
i.fullplayerStatus});d=new c.Ad({url:d,width:e,height:f});d=new a.Slot({default_ad:d,target_selector:g,cb:b});return q[g]=d}),r=new a.Manager({slots:d,max_refresh_seconds:3,max_idle_seconds:180,pre_refresh:function(a){window.amznads&&window.amznads.getAdsAsync("3040");setTimeout(a,100)}});j.bind("page-navigate",window.SZ_AD_UTIL.clearTransientTargeting);j.bind("page-navigate",i);j.bind("concierge-situations-shown",n);j.bind("concierge-stations-shown",n);j.bind("page-navigate",l);j.bind("concierge-situations-shown",
l);j.bind("concierge-stations-shown",l);j.bind("page-navigate",f);j.bind("player-station-started",g);j.bind("player-song-started",f);j.bind("player-song-play",f);j.bind("player-song-pause",f);j.bind("player-song-vote-up",f);j.bind("player-song-vote-down",f);j.bind("concierge-situations-shown",g);j.bind("concierge-stations-shown",g);j.bind("ad-refresh-requested",f);i();l();r.refresh();$("body").on("click",k)}}}});define("songza/sites/songza/getsatisfaction",["songza/config"],function(f){function e(){new GSFN.feedback_widget({display:"overlay",company:f.getsatisfaction.company,placement:"left",color:"#222",style:"question",container:b})}if(_.indexOf(f.site_custom_plugins,"songza/sites/songza/getsatisfaction")!==-1&&f.getsatisfaction.company){var b="gsfn";return{register:function(){var a=("https:"==document.location.protocol?"https://s3.amazonaws.com/getsatisfaction.com/":"http://s3.amazonaws.com/getsatisfaction.com/")+
"javascripts/feedback-v2.js";$("body").append($("<div>").attr("id",b));var c=document.createElement("script");c.setAttribute("language","javascript");c.setAttribute("type","text/javascript");c.setAttribute("src",a);document.body.appendChild(c);$(c).load(e)}}}});define("songza/sites/songza/ad-rotation",["songza/config"],function(f){if(_.indexOf(f.site_custom_plugins,"songza/sites/songza/ad-rotation")!==-1)return{register:function(e){var b=e.getInstance();b.bind("player-song-started",function(){$(b.view.el).find(".sz-ad-frame").each(function(){this.contentWindow.location.reload(!0)})})}}});define("songza/sites/songza/ad-preroll",["songza/app","songza/base","songza/config","songza/ads/vast","songza/ads/vast-station-modal","songza/ads/iframe","songza/templates/ads"],function(f,e,b,a,c,d,g){function j(){return i.featureEnabled("advertising.display")}function h(a){if(a.origin==="http://"+document.location.hostname&&_.isString(a.data)){var b=n.get_pending();b&&(a.data.indexOf("vast:")===0?(a=a.data.replace("vast:",""),b.setStrategy({strategy:"vast",tag:a})):a.data==="no_preroll"&&b.setStrategy({strategy:"no_preroll",
tag:null}))}}if(_.indexOf(b.site_custom_plugins,"songza/sites/songza/ad-preroll")!==-1&&b.features["songza.ad_preroll"]&&!Modernizr.audio_requires_user_interaction){var i,l={preroll_iframe:null,init:function(){this.preroll_iframe=new d.Ad({url:"/advertising/preroll/",width:1,height:1});this.preroll_iframe.render();$("body").append(this.preroll_iframe.el)},refresh:function(){this.preroll_iframe?(this.preroll_iframe.$el.empty(),this.preroll_iframe.render()):l.init()}},k={isLocalStorageEnabled:_.memoize(function(){if(!Modernizr.localstorage)return!1;
try{var a;window.localStorage.setItem("storage-test","test");a=window.localStorage.getItem("storage-test")=="test";window.localStorage.removeItem("storage-test");return a=a&&!window.localStorage.getItem("storage-test")}catch(b){return!1}}),init:function(){this._just_used_up_free_plays=!1;this.isLocalStorageEnabled()&&this.get()===null&&this.set(5)},any_remaining:function(){if(!this.isLocalStorageEnabled())return!1;return this.get()>0},just_used_up_free_plays:function(){return this._just_used_up_free_plays},
get:function(){if(this.isLocalStorageEnabled()){var a=parseInt(window.localStorage.getItem("free-plays-remaining"));return isNaN(a)?null:a}},set:function(a){this.isLocalStorageEnabled()&&window.localStorage.setItem("free-plays-remaining",parseInt(a))},track:function(){this._just_used_up_free_plays=!1;if(this.isLocalStorageEnabled()&&this.any_remaining()&&(this.set(this.get()-1),!this.any_remaining()))this._just_used_up_free_plays=!0}},n=e.Class.extend({initialize:function(a){a=a||{};this.deferred=
$.Deferred();this.has_custom_interstitial_ad=a.has_custom_interstitial_ad;this.unplayed=!0;j()?k.any_remaining()&&!this.has_custom_interstitial_ad?this.deferred.resolve():l.refresh():this.deferred.resolve()},setStrategy:function(a){var d=this;if(d.deferred.state()=="pending")if(a=a||{},this.strategy=a.strategy,this.tag=a.tag,this.play_cb=null,this.strategy=="no_preroll")d.deferred.resolve();else if(this.strategy=="vast"&&FlashDetect.installed){var e=c.renderPreRollVast(this.tag,null,null,{autoplay:!1,
upsell_template:g.clubSongzaUpsell({href_url:"/club/",image_url:b.static_url+"images/sites/songza/club-songza-callout.png"})});e.vastPlayer.bind("ad-ready",function(){d.deferred.resolve()});this.play_cb=function(a){a=a||{};e.play(a.station,a.startStationCallback)}}},promise:function(){return this.deferred.promise()},cancel:function(){this.deferred.reject()},play:function(a){this.play_cb&&this.play_cb(a);this.unplayed=!1}},{get:function(){return n._instance},get_pending:function(){var a=n.get();if(a.deferred.state()==
"pending")return a},get_unplayed:function(){var a=n.get();if(a.unplayed)return a},reset:function(){if(n._instance)n._instance.cancel(),n._instance=null},request:function(a){n.reset();n._instance=new n(a);return n._instance}}),m=e.Class.extend({initialize:function(a){var b=this,a=a||{};this.station=a.station;this.startStationCallback=a.startStationCallback;this.situations=a.situations;this.deferred=$.Deferred();this.playback_started=!1;this.deferred.then(function(){b.startStationCallback&&b.startStationCallback();
b.has_custom_interstitial_ad||(k.just_used_up_free_plays()?n.request():k.any_remaining()||setTimeout(function(){n.get_unplayed()||n.request()},186E4))});j()?(a=[this.station].concat(this.situations||[]),this.has_custom_interstitial_ad=_.some(a,function(a){return a.get("advertising")&&a.get("advertising").get("interstitial_ad")}),k.any_remaining()&&!this.has_custom_interstitial_ad?b.deferred.resolve():(setTimeout(function(){b.playback_started||b.complete()},this.has_custom_interstitial_ad?1E4:2E3),
this.has_custom_interstitial_ad&&n.request({has_custom_interstitial_ad:!0}),this.preroll_configuration_request=n.get_unplayed()||n.request(),this.preroll_configuration_request.promise().then(function(){if(b.deferred.state()=="pending")b.playback_started=!0,b.preroll_configuration_request.play({station:b.station,startStationCallback:function(){b.deferred.resolve()}})}))):b.deferred.resolve()},promise:function(){return this.deferred.promise()},complete:function(){this.deferred.resolve()},cancel:function(){this.deferred.reject()}},
{get:function(){return m._instance},in_progress:function(){var a=m.get();return a&&a.deferred.state()!=="resolved"},request:function(a){m._instance&&m._instance.cancel();m._instance=new m(a);return m._instance}}),p={spinner:null,station_page_el:null,setStationEl:function(a){this.station_page_el=a;m.in_progress()&&p.start()},start:function(){if(this.station_page_el)this.spinner=(new Spinner({lines:12,length:20,width:10,radius:30,color:"#888",speed:1,trail:50,shadow:!1})).spin(),$(this.spinner.el).css("position",
"absolute").css("top","125px").css("left","50%"),$(this.station_page_el).append(this.spinner.el),$(this.station_page_el).find(".szi-header").animate({opacity:0.25})},stop:function(){if(this.station_page_el)this.spinner.stop(),$(this.spinner.el).detach(),this.spinner=null,$(this.station_page_el).find(".szi-header").animate({opacity:1}),this.station_page_el=null}},o=function(a,b,c){c=_.defaults(c||{},{situations:null});p.start();m.request({station:a,startStationCallback:function(){p.stop();b();k.track()},
situations:c.situations})};return{PrerollTransition:p,register:function(a){i=a.getInstance();j()&&(k.init(),a.setStationPrePlayHook(o),window.addEventListener?window.addEventListener("message",h,!1):window.attachEvent&&window.attachEvent("onmessage",h),n.request())}}}});define("songza/models",["songza/model-config","songza/base","songza/utils"],function(f,e,b){var a={},c=null,d=null,g=/^[a-zA-Z0-9][\w-]*[a-zA-Z0-9]$/;a.initialize=function(a,b){c=a;d=b};a.apiRoute=function(a){if(c===null)throw Error("songza/models: Models.initialize() has not beed called");return c+a};a.currentSite=function(){if(d===null)throw Error("songza/models: Models.initialize() has not beed called");return d};a.Utils={Promise:function(){return $.Deferred().promise()},parseIntoModels:function(a,
b,c){var d,e=[],f=_.isArray(b)?b:[b];for(d=0;d<f.length;d++){var g=_.extend({},c,f[d]),g=new a(g,{parse:!0});e.push(g)}return _.isArray(b)?new (Backbone.Collection.extend({model:a}))(e):e[0]}};var j=a.User=e.Model.extend({defaults:{is_admin:!1,admin_sites:[]},initialize:function(){_.bindAll(this,"_initDependents");this._initDependents();this.bind("change:id",this._initDependents)},_initDependents:function(){var a=new z,b=new D,c=new A,d=new E,e=new G,f=new F;a.addFilter("user_id",this.get("id"));
b.addFilter("user_id",this.get("id"));c.addFilter("user_id",this.get("id"));d.addFilter("user_id",this.get("id"));e.addFilter("user_id",this.get("id"));f.addFilter("user_id",this.get("id"));this.set({collections:a,recent:b,created:c,allCreated:d,followers:f,following:e})},isAnonymous:function(){return this.get("id")===0},isAdmin:function(a){return _.indexOf(this.get("admin_sites"),a)!=-1},follow:function(c,d){var e=this,f=b.postJSON(a.apiRoute("/follow"),{user_id:c.get("id")});f.done(function(){e.get("following").add(c)});
return b.bindPromise(f,d)},unfollow:function(c,d){var e=this,f=b.postJSON(a.apiRoute("/unfollow"),{user_id:c.get("id")});f.done(function(){e.get("following").remove(c.get("id"))});return b.bindPromise(f,d)},profilePath:function(){return"/user/"+this.get("username")},feed:function(c){var d=a.apiRoute("/feed/user/"+this.get("id"));return b.getJSON(d,c).pipe(function(c){c.items=a.Utils.parseIntoModels(u,c.items);c.server_time=b.DateHelper.epoch_seconds_to_date(c.server_time);return c})},urlRoot:function(){return a.apiRoute("/user")}},
{getCurrent:function(b){var b=_.clone(b),c=new j({});b.url=a.apiRoute("/get-user");return c.fetch(b)},get:function(a,b){var c=_.clone(b);return(new j({id:a})).fetch(c)},logout:function(){return b.getJSON(a.apiRoute("/logout"))},loginWithUsername:function(c,d,e){var f;f=b.postJSON(a.apiRoute("/login/pw"),{username:c,password:d,site:a.currentSite()});return b.bindPromise(f.pipe(function(b){var c=f.getResponseHeader("X-SZ-New")==="Y";return{user:a.Utils.parseIntoModels(j,b),isNew:c}}),e)},loginWithFacebook:function(c,
d){var e;e=b.postJSON(a.apiRoute("/login/fb"),{fb_token:c,site:a.currentSite()});return b.bindPromise(e.pipe(function(b){var c=e.getResponseHeader("X-SZ-New")==="Y";return{user:a.Utils.parseIntoModels(j,b),isNew:c}}),d)},loginWithGoogle:function(c,d){var e;e=b.postJSON(a.apiRoute("/login/google"),{access_token:c,site:a.currentSite()});return b.bindPromise(e.pipe(function(b){var c=e.getResponseHeader("X-SZ-New")==="Y";return{user:a.Utils.parseIntoModels(j,b),isNew:c}}),d)}}),h=a.Tag=e.Model.extend({defaults:{featured:!1},
schema:{name:{},slug:{},featured:{type:"Checkbox"}},initialize:function(){_.bindAll(this,"_initDependents");this._initDependents();this.bind("change:id",this._initDependents)},_initDependents:function(){this.galleries=new (Backbone.Collection.extend({model:w,parse:function(b){return a.Utils.parseIntoModels(w,b).models},url:a.apiRoute("/gallery/tag/"+this.get("id"))}))},url:function(){return this.isNew()?a.apiRoute("/tags/create"):a.apiRoute("/tags/id/"+this.get("id"))},validate:function(a){if(a.hasOwnProperty("name")&&
a.name.match(/^\s*$/))return"Name must not be empty";if(a.hasOwnProperty("slug")&&!a.slug.match(g))return"Slug must not be empty and must only consist of letters, numbers, dashes and underscores"},setGalleriesById:function(c,d){var e={tag_id:this.get("id"),gallery_id:c},e=b.postJSON(a.apiRoute("/tags/set-galleries"),e);return b.bindPromise(e,d)}},{getAll:function(c){var d=b.getJSON(a.apiRoute("/tags")).pipe(function(b){return a.Utils.parseIntoModels(h,b)});return b.bindPromise(d,c)}});a.TagList=Backbone.Collection.extend(_.extend(b.FilteredCollectionMixin,
{filters:{site:"site",featured:"featured"}},{model:h,parse:function(b){return a.Utils.parseIntoModels(h,b).models},urlBase:function(){return a.apiRoute("/tags")},url:function(){return this.urlBase()+"?"+b.formQuery({site:this.getFilter("site"),featured:this.getFilter("featured")})}}));a.TimePeriod=e.Model.extend({defaults:{day:0,period:0},schema:{day:{title:"Day",type:"Select",options:_.map(f.situation.dow,function(a){return{val:a.value,label:a.label}})},period:{title:"Time",type:"Select",options:_.map(f.situation.time_periods,
function(a){return{val:a.value,label:a.label}})}},toString:function(){var a=this,b=_.find(f.situation.dow,function(b){return b.value==a.get("day")}),c=_.find(f.situation.time_periods,function(b){return b.value==a.get("period")});return b.label+" / "+c.label}});var i=e.Model.extend({defaults:{time_periods:[]}}),l=e.Model.extend({defaults:{interstitial_ad:!1,display_ad:!1}}),k=e.Model.extend({defaults:{enabled:!1,low_temperature:f.weather.defaults.min_temperature,high_temperature:f.weather.defaults.max_temperature,
low_humidity:f.weather.defaults.min_humidity,high_humidity:f.weather.defaults.max_humidity,unseasonably_warm:!1,unseasonably_cold:!1,clouds:null,windspeed:null,weather:null,sun_enabled:!1,sunrise_before:f.weather.defaults.sunrise_before,sunrise_after:f.weather.defaults.sunrise_after,sunset_before:f.weather.defaults.sunset_before,sunset_after:f.weather.defaults.sunset_after},initialize:function(){this.get("clouds")===null&&this.set({clouds:[]});this.get("windspeed")===null&&this.set({windspeed:[]});
this.get("weather")===null&&this.set({weather:[]})}}),n=a.SituationContext=Backbone.Model.extend({defaults:{day:null,period:null,device:null,current_date:null,site:null,optimizer:"default",style:null},initialize:function(){var a,b=new Date;this.get("current_date")||this.set({current_date:new Date});this.get("day")===null&&(a=_.find(f.situation.dow,function(a){return a.day_value===b.getDay()}),this.set({day:a.value}));this.get("period")===null&&(a=_.find(f.situation.time_periods,function(a){var c=
a.hours_range[0],a=a.hours_range[1];return b.getHours()>=c&&b.getHours()<=a}),this.set({period:a.value}),a.value===5&&(a=this.get("day")===0?6:this.get("day")-1,this.set({day:a})))},day_title:function(){var a=this.get("day");return _.find(f.situation.dow,function(b){return b.value===a}).label},period_title:function(){var a=this.get("period");return _.find(f.situation.time_periods,function(b){return b.value===a}).label},title:function(){return this.day_title()+" "+this.period_title()}}),m=a.Situation=
e.Model.extend({defaults:{order:50,modes:["general"],pinned:!1,keywords:""},schema:{},initialize:function(){this.get("devices")||this.set({devices:[]});this.get("time_periods")||this.set({time_periods:[]});this.get("situations")||this.set({situations:new Backbone.Collection});this.get("station_ids")||this.set({station_ids:[]});this.get("initial_experience")||this.set({initial_experience:new i({})});this.get("advertising")||this.set({advertising:new l({})});this.get("weather")||this.set({weather:new k({})})},
parse:function(b){b.situations=a.Utils.parseIntoModels(m,b.situations||[]);if(b.initial_experience)b.initial_experience=new i(b.initial_experience,{parse:!0});if(b.advertising)b.advertising=new l(b.advertising,{parse:!0});if(b.weather)b.weather=new k(b.weather,{parse:!0});return b},toJSON:function(){var a=m.__super__.toJSON.apply(this,arguments);a.situations=a.situations.map(function(a){return a.toJSON()});return a},toPath:function(a){a=a||{};return m.generatePath(this,a.situationContext,a.parentSituationId)},
validate:function(a){if(a.hasOwnProperty("title")&&a.title.match(/^\s*$/))return"Title must not be empty"},toString:function(){return this.get("title")},url:function(){return this.isNew()?a.apiRoute("/situation/create"):a.apiRoute("/situation/id/"+this.get("id"))},sync:Backbone.sync,svgUrl:function(){return a.apiRoute("/situation/id/"+this.get("id")+"/svg")},generateDasherizedSlug:function(){var a=this.get("title"),a=a.toLowerCase(),a=a.replace(/&/g,"-and-"),a=a.replace(/#/g,"number-"),a=a.replace(/[^a-z0-9_]/g,
"-"),a=a.replace(/-+/g,"-"),a=a.replace(/^-*/g,""),a=a.replace(/-*$/g,"");return a=encodeURIComponent(a)},setSvg:function(a,b){var c=new XMLHttpRequest,b=b||{};b.success&&c.upload.addEventListener("load",b.success);b.error&&c.upload.addEventListener("error",b.error);c.open("PUT",this.svgUrl(),!0);c.setRequestHeader("Content-Type","image/svg+xml");c.send(a)},deleteSvg:function(a){var c=$.ajax({url:this.svgUrl(),type:"DELETE"});return b.bindPromise(c,a)}},{generatePath:function(a,b,c){b||new n;b=a.generateDasherizedSlug();
return c?"concierge/"+[b,c,a.get("id")].join("/")+"/":"concierge/"+[b,a.get("id")].join("/")+"/"},parsePath:function(a){var b=(a=a.match("concierge/([^/]+)/([^/]+)/(([^/]+)/)?"))&&a[2],c=a&&a[4];if(a&&a.length>0)return c?{parent_situation_oid:b,situation_oid:c}:{situation_oid:b}},getTargeted:function(c,d){var e={current_date:b.DateHelper.iso8601(c.current_date),day:c.day,period:c.period,device:c.device,site:c.site,optimizer:c.optimizer};if(c.max_situations)e.max_situations=c.max_situations;if(c.max_stations)e.max_stations=
c.max_stations;if(c.style)e.style=c.style;if(c.situation_id)e.situation_id=c.situation_id;e=b.getJSON(a.apiRoute("/situation/targeted"),e).pipe(function(b){return a.Utils.parseIntoModels(m,b)});return b.bindPromise(e,d)},trackEvents:function(b){var c={url:a.apiRoute("/situation/track"),type:"POST",dataType:"json",contextType:"application/json",processData:!1},d=new Date,e=d.getTimezoneOffset(),f=Math.floor(Math.abs(e/60)),g=Math.abs(e)-f*60;c.data=JSON.stringify({current_time:d,visitor:{utc_offset:(e>
0?"-":"")+(f<10?"0"+f:f)+":"+(g<10?"0"+g:g)},events:b});$.ajax(c)},search:function(c,d){var e=typeof c=="string"?{query:c}:c,e=b.getJSON(a.apiRoute("/search/situation"),e).pipe(function(b){return a.Utils.parseIntoModels(m,b)});return b.bindPromise(e,d)}});a.SituationList=Backbone.Collection.extend(_.extend(b.FilteredCollectionMixin,{filters:{site:"site"}},{model:m,parse:function(b){return a.Utils.parseIntoModels(m,b).models},urlBase:function(){return a.apiRoute("/situation")},url:function(){return this.urlBase()+
"?"+b.formQuery({site:this.getFilter("site")})}}));var p=a.UserCollection=e.Model.extend({defaults:{station_ids:[]},initialize:function(a){a.station_ids||this.set({station_ids:[]})},urlRoot:function(){return a.apiRoute("/collection")},url:function(){return this.isNew()?a.apiRoute("/collection/user/"+this.get("user_id")+"/create"):this.urlRoot()+"/"+this.get("id")},containsStation:function(a){return _.detect(this.get("station_ids"),function(b){return b===a})?!0:!1},addStation:function(a,c){var d=this,
e=b.postJSON(this.url()+"/add-station",{station:a});e.done(function(){var b=d.get("station_ids").splice();b.push(a);d.set({station_ids:b})});return b.bindPromise(e,c)},removeStation:function(a,c){var d=this,e=b.postJSON(this.url()+"/remove-station",{station:a});e.done(function(){var b=_.without(d.get("station_ids"),a);d.set({station_ids:b})});return b.bindPromise(e,c)}},{get:function(a,b){var c=_.clone(b);return(new p({id:a})).fetch(c)},remove:function(c,d){var e=b.postJSON(a.apiRoute("/collection/delete"),
{collection_id:c});return b.bindPromise(e,d)}}),o=a.StationAdvertisingConfig=e.Model.extend({defaults:{interstitial_ad:!1,display_ad:!1},schema:{interstitial_ad:{type:"Checkbox",title:"Interstitial Ad"},display_ad:{type:"Checkbox",title:"Display Ad"}}}),q=a.Station=Backbone.Model.extend({defaults:{status:"UNRELEASED"},schema:{name:{},description:{type:"TextArea",editorAttrs:{rows:5}},notes:{type:"TextArea",editorAttrs:{rows:5}}},initialize:function(){var b=this;this.songs=new (Backbone.Collection.extend({model:y,
parse:function(b){return a.Utils.parseIntoModels(y,b).models},url:function(){return b.url()+"/songs"}}))([]);this.get("genres")||this.set({genres:new Backbone.Collection});this.get("advertising")||this.set({advertising:new o({})})},parse:function(b){if(b.genres)b.genres=a.Utils.parseIntoModels(I,b.genres);if(b.advertising)b.advertising=new o(b.advertising,{parse:!0});return b},toJSON:function(){var a=q.__super__.toJSON.apply(this,arguments);if(this.get("genres"))a.genres=this.get("genres").toJSON();
if(this.get("advertising"))a.advertising=this.get("advertising").toJSON();return a},activeSongs:function(){return this.songs.filter(function(a){return a.get("deleted")===!1})},deletedSongs:function(){return this.songs.filter(function(a){return a.get("deleted")===!0})},featured_artists_label:function(){return"w/ "+_.map(this.get("featured_artists"),function(a){return a.name}).join(", ")},releaseRequirements:function(){var a=f.station.radio_rules.min_song_count,b=f.station.radio_rules.min_artist_count,
c={},d=0,e=this.activeSongs(),g={satisfied:!1,artists:{total:b,needed:b},songs:{total:a,needed:a}};_.each(e,function(a){a=a.get("song").get("artist").get("name").replace(/[^\w\d]/,"").toLowerCase();c[a]=!0});d=_.keys(c).length;g.songs.needed=e.length>a?0:a-e.length;g.artists.needed=d>b?0:b-d;if(g.songs.needed<g.artists.needed)g.songs.needed=g.artists.needed;g.satisfied=g.songs.needed===0&&g.artists.needed===0;return g},urlRoot:function(){return a.apiRoute("/station")},url:function(){return this.isNew()?
this.urlRoot()+"/create":this.urlRoot()+"/"+this.get("id")},nextSong:function(c){var d=this,e=_.clone(c.params);e.buffer=e.buffer?"1":"0";e=b.postJSON(this.url()+"/next",e).pipe(function(b){b=a.Utils.parseIntoModels(x,b);b.station=d;return b});return b.bindPromise(e,c)},notifyPlay:function(c,d){var e=a.apiRoute("/station/"+this.get("id")+"/song/"+c.get("id")+"/notify-play"),e=b.postJSON(e,{});return b.bindPromise(e,d)},notifySkip:function(c,d){var e=a.apiRoute("/station/"+this.get("id")+"/song/"+
c.get("id")+"/notify-play"),e=b.postJSON(e,{skip:"1"});return b.bindPromise(e,d)},listen:function(a){var c=b.postJSON(this.url()+"/listen");return b.bindPromise(c,a)},pageUrlPath:function(){return"/listen/"+encodeURIComponent(this.get("dasherized_name"))+"/"},editUrlPath:function(){return"/station/"+this.get("id")+"/edit/"},canonicalUrlPath:function(){return"/station/"+this.get("id")},getCoverUrl:function(a){this.get("cover_url");var b={},a=a||{};if(a.size)b.size=a.size;if(a.style)b.style=a.style;
return this.get("cover_url")+"?"+$.param(b)},uploadImageUrlPath:function(){return a.apiRoute("/station/"+this.get("id")+"/upload-image")},deleteImageUrlPath:function(){return a.apiRoute("/station/"+this.get("id")+"/delete-image")},deleteImage:function(a){var c=b.postJSON(this.deleteImageUrlPath());return b.bindPromise(c,a)},addSong:function(c,d){var e=this,f=b.postJSON(this.url()+"/songs/add",{song_id:c.get("id")}).pipe(function(b){return a.Utils.parseIntoModels(y,b)});f.done(function(a){e.songs.add(a)});
return b.bindPromise(f,d)},release:function(a){var c=this,d=b.postJSON(this.url()+"/release",{released:"1"});d.done(function(){c.set({status:"NORMAL"})});return b.bindPromise(d,a)},unrelease:function(a){var c=this,d=b.postJSON(this.url()+"/release",{released:"0"});d.done(function(){c.set({status:"UNRELEASED"})});return b.bindPromise(d,a)},validate:function(a){if(a.hasOwnProperty("name")&&a.name.match(/^\s*$/))return"Name must not be empty"},_isoDate:function(a){return a.getFullYear()+"-"+(a.getMonth()+
1)+"-"+a.getDate()},getStats:function(a,c,d){a={start_date:this._isoDate(a),end_date:this._isoDate(c)};a=b.getJSON(this.url()+"/stats",a);return b.bindPromise(a,d)},getSimilarStations:function(c){var d=a.apiRoute("/station/"+this.get("id")+"/similar"),d=b.getJSON(d).pipe(function(b){return a.Utils.parseIntoModels(q,b)});return b.bindPromise(d,c)}},{get:function(a,b){var c=_.clone(b);return(new q({id:a})).fetch(c)},getByDasherizedName:function(c,d){var e=b.getJSON(a.apiRoute("/station/dname/"+c)).pipe(function(b){return a.Utils.parseIntoModels(q,
b)});return b.bindPromise(e,d)},getByUrl:function(a,b){var c;if(c=a.match(/.*\/station\/(\d+)\/?$/))return q.get(parseInt(c[1],10),b);if(c=a.match(/.*\/listen\/([^\/]+)\/?$/))return q.getByDasherizedName(c[1],b);throw Error("Unable to parse station id from url: "+a);},getBatch:function(c,d){var e=b.getJSON(a.apiRoute("/station/multi"),{id:c}).pipe(function(b){return a.Utils.parseIntoModels(q,b)});return b.bindPromise(e,d)},search:function(c,d){var e=b.getJSON(a.apiRoute("/search/station"),{query:c}).pipe(function(b){return a.Utils.parseIntoModels(q,
b)});return b.bindPromise(e,d)}});a.StationCache={cache:{},reset:function(){this.cache={}},set:function(a){if(_.isArray(a)){var b={};_.each(a,function(a){b[a.id]=a});a=b}this.cache=a},get:function(a){return this.cache[a]}};var r=a.Artist=e.Model.extend({defaults:{}},{search:function(c,d){var e=b.getJSON(a.apiRoute("/search/artist"),{query:c}).pipe(function(b){return a.Utils.parseIntoModels(r,b)});return b.bindPromise(e,d)},SUGGEST_BLACKLIST:["rock","pop"],SUGGEST_THRESHOLD:95,suggest:function(c,d){if(_.contains(r.SUGGEST_BLACKLIST,
c.toLowerCase())){var e=$.Deferred;e.resolve(new Backbone.Collection([]));return b.bindPromise(e,d)}var f=r.SUGGEST_THRESHOLD,e={name:c};e.num=d&&d.num||10;if(d&&d.threshold)f=d.threshold;e=b.getJSON(a.apiRoute("/suggest/artist"),e).pipe(function(b){b=b.filter(function(a){return a.percent&&a.percent>=f});return a.Utils.parseIntoModels(r,b)});return b.bindPromise(e,d)}}),t=a.Song=e.Model.extend({defaults:{},parse:function(b){b.artist=a.Utils.parseIntoModels(r,b.artist);return b},toJSON:function(){var a=
t.__super__.toJSON.apply(this,arguments);a.artist=this.get("artist").toJSON();return a},canonicalUrlPath:function(){return"/station/song_data/"+this.get("id")},getSampleUrl:function(c){var d=a.apiRoute("/song/"+this.get("id")+"/sample"),d=b.postJSON(d,c.params);return b.bindPromise(d,c)}},{search:function(c,d){var e=b.getJSON(a.apiRoute("/search/song"),{query:c,limit:d.limit||100}).pipe(function(b){return a.Utils.parseIntoModels(t,b.songs)});return b.bindPromise(e,d)}}),y=a.StationSong=Backbone.Model.extend({parse:function(b){b.song=
a.Utils.parseIntoModels(t,b.song);return b},toJSON:function(){var a=y.__super__.toJSON.apply(this,arguments);a.song=this.get("song").toJSON();return a},url:function(){return a.apiRoute("/station-song/"+this.get("id"))}}),x=a.StationStreamSong=e.Model.extend({defaults:{},parse:function(b){b.song=a.Utils.parseIntoModels(t,b.song);return b},toJSON:function(){var a=x.__super__.toJSON.apply(this,arguments);a.song=this.get("song").toJSON();return a},_url:function(){return a.apiRoute("/station/"+this.station.get("id")+
"/song/"+this.get("song").get("id"))},voteUp:function(a){var c=this,d=b.postJSON(this._url()+"/vote/up");d.done(function(){c.set({vote:"up"})});return b.bindPromise(d,a)},voteDown:function(a){var c=this,d=b.postJSON(this._url()+"/vote/down");d.done(function(){c.set({vote:"down"})});return b.bindPromise(d,a)}}),w=a.Gallery=e.Model.extend({defaults:{just_for_you_eligible:!1},schema:{name:{},slug:{},keywords:{type:"TextArea"},just_for_you_eligible:{type:"Checkbox",title:"JFY Eligible"}},initialize:function(){this.get("station_ids")||
this.set({station_ids:[]});_.bindAll(this,"_initDependents");this._initDependents();this.bind("change:id",this._initDependents)},_initDependents:function(){var c=this;this.stations=new (Backbone.Collection.extend({model:q,url:function(){return a.apiRoute("/station/multi")+"?"+b.formQuery({id:c.get("station_ids")})}}))},parse:function(b){b.tags=a.Utils.parseIntoModels(h,b.tags).models;return b},toJSON:function(){var a=w.__super__.toJSON.apply(this,arguments);a.tags=_.map(this.get("tags"),function(a){return a.toJSON()});
return a},url:function(){return this.isNew()?a.apiRoute("/gallery/create"):a.apiRoute("/gallery/id/"+this.get("id"))},validate:function(a){if(a.hasOwnProperty("name")&&a.name.match(/^\s*$/))return"Name must not be empty";if(a.hasOwnProperty("slug")&&!a.slug.match(g))return"Slug must not be empty and must only consist of letters, numbers, dashes and underscores"}},{get:function(a,b){var c=_.clone(b);return(new w({id:a})).fetch(c)},getBatch:function(c,d){var e=b.getJSON(a.apiRoute("/gallery/multi"),
{ids:c}).pipe(function(b){return a.Utils.parseIntoModels(w,b)});return b.bindPromise(e,d)},search:function(c,d){var e=b.getJSON(a.apiRoute("/search/gallery"),{query:c}).pipe(function(b){return a.Utils.parseIntoModels(w,b)});return b.bindPromise(e,d)}});a.GalleryList=Backbone.Collection.extend(_.extend(b.FilteredCollectionMixin,{filters:{site:"site"}},{model:w,parse:function(b){return a.Utils.parseIntoModels(w,b).models},urlBase:function(){return a.apiRoute("/gallery/list/")},url:function(){return this.urlBase()+
this.getFilter("site")}}));var u=a.FeedItem=e.Model.extend({defaults:{},parse:function(c){c.ts=b.DateHelper.epoch_seconds_to_date(c.ts);c.actors=a.Utils.parseIntoModels(j,c.actors).models;c.station=a.Utils.parseIntoModels(q,c.station);if(c.song)c.song=a.Utils.parseIntoModels(t,c.song);return c},toJSON:function(){var a=u.__super__.toJSON.apply(this,arguments);a.station=this.get("station").toJSON();if(this.get("song"))a.song=this.get("song").toJSON();a.actors=_.map(this.get("actors"),function(a){return a.toJSON()});
return a}}),v=Backbone.Collection.extend(_.extend({},b.FilteredCollectionMixin,{filters:{user_id:"user_id"}})),z=v.extend({model:p,urlBase:function(){return a.apiRoute("/collection/user/")},parse:function(a){return a},url:function(){return this.urlBase()+this.getFilter("user_id")},comparator:function(a){return a.get("title").toLowerCase()}}),D=v.extend({model:q,urlBase:function(){return a.apiRoute("/user/")},url:function(){return this.urlBase()+this.getFilter("user_id")+"/stations?limit=40&recent=1"},
parse:function(a){return a.recent.stations}}),A=v.extend({model:q,urlBase:function(){return a.apiRoute("/user/")},url:function(){return this.urlBase()+this.getFilter("user_id")+"/stations?limit=40&created=1&all_created=0"},parse:function(a){return a.created.stations}}),E=v.extend({model:q,urlBase:function(){return a.apiRoute("/user/")},url:function(){return this.urlBase()+this.getFilter("user_id")+"/stations?limit=40&all_created=1"},parse:function(a){return a.all_created.stations}}),F=v.extend({model:j,
urlBase:function(){return a.apiRoute("/get-followers/")},url:function(){return this.urlBase()+this.getFilter("user_id")}}),G=v.extend({model:j,urlBase:function(){return a.apiRoute("/get-follows/")},url:function(){return this.urlBase()+this.getFilter("user_id")}}),B=a.Promotion=e.Model.extend({defaults:{},schema:{station_id:{},image_url:{},active:{type:"Checkbox"}},url:function(){return this.isNew()?a.apiRoute("/promotion/create"):a.apiRoute("/promotion/id/"+this.get("id"))},parse:function(b){b.station=
a.Utils.parseIntoModels(q,b.station);return b},toJSON:function(){var a=B.__super__.toJSON.call(this);if(this.get("station"))a.station=this.get("station").toJSON();return a},validate:function(a){if(a.hasOwnProperty("site")&&a.site.match(/^\s*$/))return"Site must not be empty";if(a.hasOwnProperty("product")&&a.product.match(/^\s*$/))return"Product must not be empty";if(a.hasOwnProperty("station_id")&&isNaN(parseInt(a.station_id)))return"Station Id must not be empty";if(a.hasOwnProperty("image_url")&&
a.image_url.match(/^\s*$/))return"Image must not be empty"}});a.PromotionList=Backbone.Collection.extend(_.extend(b.FilteredCollectionMixin,{filters:{site:"site",product:"product"}},{model:B,parse:function(b){return a.Utils.parseIntoModels(B,b).models},urlBase:function(){return a.apiRoute("/promotion")},url:function(){return this.urlBase()+"?"+b.formQuery({site:this.getFilter("site"),product:this.getFilter("product")})}}));var H=a.Facet=e.Model.extend({defaults:{},parse:function(b){b.parent&&(b.parent=
a.Utils.parseIntoModels(H,b.parent));return b},toJSON:function(){var a=B.__super__.toJSON.call(this);this.get("parent")&&(a.parent=this.get("parent").toJSON());return a},toString:function(){return this.get("name")}}),I=a.Genre=a.Facet.extend({toString:function(){return this.get("parent")?this.get("parent").get("name")+": "+this.get("name"):this.get("name")}});return a});define("songza/station-save",["songza/base","songza/models","songza/work","songza/app"],function(f,e,b,a){function c(a){var b=g[a.get("id")];b||(b={fetch_state:j,last_fetched:null},g[a.get("id")]=b);if(a.isAnonymous())b.fetch_state=i;else if(b.fetch_state!==h&&(b.fetch_state===j||b.last_fetched.getTime()+l<(new Date).getTime()))b.fetch_state=h,a.get("collections").fetch({success:function(){b.last_fetched=new Date;b.fetch_state=i;a.get("collections").trigger("fetch")},error:function(){b.fetch_state=
j}})}var d={},g={},j=0,h=1,i=3,l=14400,k=d.StationSaveButton=f.View.extend({template:sz.tmpl.stationSave.button,css:"sz-station-save-button btn",states:{saved:{set:!1,onCss:"sz-station-save-button-saved"}},initialize:function(a){k.__super__.initialize.call(this,a);_.bindAll(this,"removeMenu","showMenu","onBodyClick","render");this.user=a.user;this.stationId=a.stationId;this.stationType=a.stationType||"basic";this.menuContainer=a.menuContainer;this.overlay=this.menu=null;this.user.get("collections").bind("fetch",
this.render);this.user.get("collections").bind("add",this.render);this.user.get("collections").bind("remove",this.render);this.user.get("collections").bind("change",this.render);$(this.el).bind("click",this.showMenu);$("body").bind("click",this.onBodyClick)},onBodyClick:function(a){this.overlay&&this.menu&&!$.contains(this.menu.el,a.target)&&this.removeMenu()},removeMenu:function(){if(this.overlay)this.overlay.detach(),this.overlay=null;this.menu.destroy();this.menu=null},showMenu:function(b){b.stopPropagation();
if(!this.menu){b=(new (this.user.isAnonymous()?d.StationSaveAnonymousMenu:d.StationSaveMenu)({user:this.user,stationId:this.stationId,stationType:this.stationType})).render();if(this.menuContainer)$(this.menuContainer).append(b.el);else{var c=$("<div>").addClass("sz-station-save-menu-overlay").append(b.el);this.overlay=c;$(a.getInstance().view.el).append(c);c.position({my:"left top",at:"left bottom",of:this.el,collision:"fit"})}this.menu=b}},context:function(){var a=[],b=this.stationId;c(this.user);
this.user.get("collections").each(function(c){c.containsStation(b)&&a.push(c.toJSON())});return{collections:a,station_type:this.stationType}}});d.StationSaveAnonymousMenu=f.View.extend({template:sz.tmpl.stationSave.anonymousMenu,initialize:function(a){this.stationType=a.stationType},context:function(){var b=a.getInstance();return{view_id:this.cid,station_type:this.stationType,login_url:b.loginUrlPath(),signup_url:b.signupUrlPath()}}});var n=d.StationSaveMenu=f.View.extend({template:sz.tmpl.stationSave.menu,
events:{"click  .szi-done":"onDone","click  .szi-cancel":"onCancel","click  .szi-new-collection":"onNewCollection","click  .szi-make-collection":"onMakeCollection",'change .szi-bd input[type="checkbox"]':"onChange",'click  .szi-bd input[type="checkbox"]':"onChange"},elements:{'.szi-new-collection-form input[type="text"]':"collectionNameInput"},css:"sz-station-save-menu",states:{changed:{set:!1,onCss:"sz-station-save-menu-changed"},creating:{set:!1,onCss:"sz-station-save-menu-creating"}},initialize:function(a){n.__super__.initialize.call(this,
a);this.user=a.user;this.stationId=a.stationId;this.stationType=a.stationType;this.title=a.title;this.autoSave=a.hasOwnProperty("autoSave")?a.autoSave:!0;this._checked={};this.user.get("collections").length===0&&this.setState("creating",!0);this.user.get("collections").bind("add",this.render);this.user.get("collections").bind("remove",this.render)},onDone:function(a){a.preventDefault();this.save()},_clearChecked:function(){this._checked={}},onCancel:function(a){a.preventDefault();a.stopPropagation();
this.cancel()},cancel:function(){this._clearChecked();this.setState("changed",!1);this.render()},onNewCollection:function(a){a.preventDefault();a.stopPropagation();this.setState("creating",!0)},onMakeCollection:function(a){a.preventDefault();a.stopPropagation();var c=this,a=new b.Set({}),d=this.collectionNameInput().val(),f=new e.UserCollection({title:d,user_id:this.user.get("id")});if(d=(d||"").replace(/^\s*([\S]*)\s*$/,"$1"))this.setState("creating",!1),f.save({},a.backbone.proxy("collection")),
a.after("collection",function(a,b){f.addStation(c.stationId,b)},a.backbone.proxy("station")),$.when(a).then(function(a){c.user.get("collections").add(a.collection)}).fail(function(){c.trigger("error",c,"Sorry, but we weren't able to create your shelf.")})},onChange:function(a){var a=$(a.target),b=a.closest("li");this._checked[a.val()]=a.is(":checked");a.is(":checked")?b.addClass("szi-checked"):b.removeClass("szi-checked");this.autoSave?this.save():this.setState("changed",!0)},save:function(){var a=
this,c,d,e,f=new b.Set({}),g=this.user.get("collections");d=$.Deferred().resolve();f.add("finalize",d.promise());for(c in this._checked){d=g.get(c);e=this._checked[c];var h=function(a,b){return function(){delete a[b]}}(e,d);e!==d.containsStation(this.stationId)&&(h=f.backbone.proxy("collection-"+d.get("id"),h),e?d.addStation(this.stationId,h):d.removeStation(this.stationId,h))}$.when(f).done(function(){a._clearChecked();a.setState("changed",!1);a.trigger("saved")}).fail(function(){a.trigger("error",
"Sorry, but we weren't able to save some of your changes.")});return f},context:function(){var a=this._checked,b=this.stationId,d={title:this.title,view_id:this.cid,station_type:this.stationType,collection_list:this.user.get("collections").map(function(c){var d=c.toJSON();d.checked=a.hasOwnProperty(c.get("id"))?a[c.get("id")]:c.containsStation(b);return d})};c(this.user);return d}});return d});define("songza/routers",["songza/config"],function(f){var e={};e.Default=Backbone.Router.extend({loadingPath:null,lastRequest:null,routes:{"*path":"loadContent"},initialize:function(b){this.app=b.app},requestContent:function(b,a,c,d){this.lastRequest=$.ajax({type:b,data:c,url:"/"+a,headers:{"X-HASHSIGNAL":f.hashsignal}});$.when(this.lastRequest).then(d.success,d.error)},getContent:function(b,a){this.requestContent("GET",b,"",a)},postContent:function(b,a,c){this.requestContent("POST",b,a,c)},requestAndInjectContent:function(b,
a,c){var d=this;d.app.trigger("page-navigate-start",{path:a});this.requestContent(b,a,c,{success:function(c,e,h){var e=h.getResponseHeader("Content-Type"),i=h.getResponseHeader("X-HASHSIGNAL"),h=!1;e==="application/vnd.songza.hashsignal-route+json"?(c.redirectLocation.match(/^\s*http[s]?/i)?(e=parseUri(c.redirectLocation),i=e.path,e.protocol!=window.location.protocol&&e.host!=window.location.host&&(h=!0)):(h=!1,i=c.redirectLocation),h?window.location=c.redirectLocation:d.navigate(i.substr(1),{trigger:!0,
replace:!0})):b==="GET"&&i!==f.hashsignal?d.app.reloadApplication():a===d.loadingPath&&(d.app.view.updateContent(c),d.app.trigger("page-navigate",{path:a}))},error:function(c){var e=c.getResponseHeader("X-HASHSIGNAL");b==="GET"&&e!==f.hashsignal?d.app.reloadApplication():a===d.loadingPath&&(c.status==404||c.status==403?d.app.view.updateContent(c.responseText):f.debug&&d.app.view.showErrorDocument(c.responseText),d.app.trigger("page-navigate-failure",{path:a}))}});this.loadingPath=a},getAndInjectContent:function(b){this.requestAndInjectContent("GET",
b)},postAndInjectContent:function(b,a){this.requestAndInjectContent("POST",b,a)},loadContent:function(b){b==="_=_"?Backbone.history.navigate("/",!0):b.match(/^base_domain=/)||this.getAndInjectContent(b)},loadSearchContent:function(b){this.getAndInjectContent("search/"+b+"/")},search:function(b){this.navigate("search/"+b,!0)}});return e});define("songza/app",["songza/base","songza/config","songza/site-views","songza/routers","songza/models","songza/utils"],function(f,e,b,a,c,d){var g,j=[],h=[],i={},l=null,k=[],n=!1;if(!window.console)window.console={};if(!window.console.log)window.console.log=function(){};var m=f.Class.extend({initialize:function(c){var d=this;this.router=new a.Default({app:this});this.view=new b.Default({app:this});this.visitor=c.visitor;this.environment=c.environment||{};this.postLoginQueue=[];this.player=null;this.stationMeta=
{};this.configHistory();e.debug&&console&&console.log&&this.bind("all",function(a,b){a!="player-song-play-state"&&console.log("songza-app: ["+a+"]",b)});this.bind("dom-node-inserted",function(a){m.enhanceDOM(a.node)});$(window).bind("beforeunload",function(){d.stopStation();d.trigger("app-unload")})},featureEnabled:function(a){return this.getEnvironment().session_features[a]?!0:!1},getConfig:function(){return e},getVisitor:function(){return this.visitor},setVisitor:function(a){var b=this.visitor;
if(a.get("id")!==b.get("id"))this.visitor=a,this.trigger("visitor-change",{oldVisitor:b,newVisitor:a}),b.get("id")===0&&a.get("id")&&_.each(this.postLoginQueue,function(a){a()}),this.postLoginQueue=[];$("html").removeClass("sz-user-anonymous");$("html").removeClass("sz-user-authenticated");a.isAnonymous()?$("html").addClass("sz-user-anonymous"):$("html").addClass("sz-user-authenticated")},setEnvironment:function(a){this.current_version&&a.version!=this.current_version&&this.queueReload();this.current_version=
a.version;this.environment=a},getEnvironment:function(a){if(a===void 0)return this.environment;return this.environment[a]},getVersion:function(){return this.current_version},queueReload:function(){var a=this,b=this.getPlayer();b?b.isPlaying()?b.model.get("station").get("type")!=="stream"&&(this.savePlayerState(),b.shutdown(function(){a.reloadApplication()})):this.reloadApplication():this.reloadApplication()},reloadApplication:function(){window.location.reload(!0)},savePlayerState:function(){var a=
this.getPlayer();Modernizr.sessionstorage&&a&&(a=a.model.get("station").toJSON(),window.sessionStorage.setItem("player-station",JSON.stringify(a)))},restorePlayerState:function(){var a;if(Modernizr.sessionstorage&&(a=window.sessionStorage.getItem("player-station"),window.sessionStorage.removeItem("player-station"),a)){try{a=JSON.parse(a)}catch(b){return}this.startStation(new c.Station(a,{parse:!0}))}},refresh:function(){Backbone.history.loadUrl(Backbone.history.getFragment())},configHistory:function(){Backbone.history.start({pushState:this.supportsHistory(),
silent:!this.mustFetchInitialPage()})},supportsHistory:function(){return Modernizr.history},mustFetchInitialPage:function(){return window.location.hash},bind:Backbone.Events.bind,unbind:Backbone.Events.unbind,startStation:function(a,b){var c=this,b=b||{};this.player&&this.player.model.get("station").get("id")===a.get("id")?b.force&&this.player.play():(this.stopStation(),require(["songza/player/view"],function(d){var e=new d.PlayerState({station:a});c.player=new d.PlayerView({model:e,app:c,artist:b.artist,
resumeState:b.resumeState});c.player.bind("all",function(a,b){(a.indexOf("song-")===0||a==="metadata"||a.indexOf("station-")===0)&&c.trigger("player-"+a,b)});c.view.$player().append(c.player.render().el);d=function(){c.player.start();c.trigger("player-station-started",{station:a})};l?l(a,d,{situations:b.situations}):d()}))},stopStation:function(){var a=this.getPlayer();if(a)this.trigger("player-station-stopped",{station:a.model.get("station")}),a.destroy(),this.player=null},getPlayer:function(){return this.player},
addPostLoginAction:function(a){this.postLoginQueue.push(a)},authenticatedAction:function(a){if(this.getVisitor().isAnonymous()){a=_.clone(a);if(!a.next)a.next="/"+Backbone.history.getFragment();a.action&&this.addPostLoginAction(a.action);d.formQuery({next:a.next});Backbone.history.navigate("login/?next="+encodeURIComponent(a.next),!0)}else a.action&&a.action()},loginUrlPath:function(){return"/login/?"+d.formQuery({next:"/"+Backbone.history.getFragment()})},signupUrlPath:function(){return"/signup/?"+
d.formQuery({next:"/"+Backbone.history.getFragment()})},trigger:function(a,b){b=b||{};b.eventTime=new Date;b.eventName=a;Backbone.Events.trigger.call(this,a,b)},enhanceDOM:function(a){m.enhanceDOM(a)},getSharingSystems:function(){return m.getSharingSystems()},_pruneStationMeta:function(){var a=this.getPlayer(),b,c;if(!(_.values(this.stationMeta).length<4))a&&(b=a.model.get("station").get("id"),c=this.stationMeta[b]),this.stationMeta={},b&&(this.stationMeta[b]=c)},setStationMeta:function(a,b){this._pruneStationMeta();
this.stationMeta[a.get("id")]=b;this.trigger("station-meta-changed",{station:a,meta:b})},getStationMeta:function(a){return this.stationMeta[a.get("id")]}},{loadPlugins:function(a){function b(){if(n=_.reduce(_.values(c),function(a,b){return a&&b}))_.each(k,function(a){a()}),m.getInstance().restorePlayerState()}var c={};_.each(a,function(a){c[a]=!1});_.each(a,function(a){require([a],function(d){c[a]=!0;try{d.register(m)}catch(e){console.log("Failed to load plugin: "+a,d,e)}b()})})},addDOMEnhancement:function(a){j.push(a);
a($(g.view.el))},enhanceDOM:function(a){_.each(j,function(b){try{b(a)}catch(c){console.log("Failed to apply enhancement",c)}})},setStationPrePlayHook:function(a){l=a},addCommentProvider:function(a,b){i[a]=b},getCommentProvider:function(a){return i[a]},addSharingSystem:function(a){h.push(a)},getSharingSystems:function(){return h},init:function(a,b,c){m.initInstance(a,b);m.loadPlugins(c)},initInstance:function(a,b){g=new m({visitor:a,environment:b})},getInstance:function(){if(!g)throw Error("Application instance has not been created. Perhaps you forgot to call App.init first?");
return g},postInit:function(a){n?a():k.push(a)}});return m});define("songza/situation-tracker",["songza/base","songza/models"],function(f,e){var b=f.Class.extend({initialize:function(a){var c=this;b.__super__.initialize.call(this,a);this._events=[];a.app.bind("app-unload",function(){c.sendEvents()})},contextForEvent:function(a){return{day:a.get("day"),period:a.get("period"),device:a.get("device"),site:a.get("site"),current_date:a.get("current_date")}},logSituationEvent:function(a,b,d,e){a={date_time:new Date,type:a,parent_situation_ids:_.map(e,function(a){return a.get("id")}),
situation_ids:_.map(d,function(a){return a.get("id")}),station_ids:[],context:this.contextForEvent(b)};this.logEvent(a)},logStationEvent:function(a,b,d,e){a={date_time:new Date,type:a,parent_situation_ids:_.map(e,function(a){return a.get("id")}),situation_ids:[],station_ids:_.map(d,function(a){return a.get("id")}),context:this.contextForEvent(b)};this.logEvent(a)},logEvent:function(a){this._events.push(a);this.queueSendEvents()},sendEvents:function(){e.Situation.trackEvents(this._events);this._events=
[]},queueSendEvents:_.debounce(function(){this.sendEvents()},5E3)});return b});define("songza/systems/google-plus",["songza/models","songza/utils","songza/base"],function(f,e,b){function a(a,b){var c=g.getInstance();f.User.loginWithGoogle(a,{success:function(a){a.isNew&&c.trigger("visitor-signup",{visitor:a.user});c.setVisitor(a.user);j?(Backbone.History&&Backbone.History.started?Backbone.history.navigate(j,!0):window.location=j,j=null):c.refresh();b.success&&b.success()},error:function(){c.trigger("visitor-account-creation-error",{provider:"facebook",initiatedByUser:b.initiatedByUser,
message:"Sorry, but we were unable to automatically link your account"});b.error&&b.error()}})}function c(){var a=g.getInstance().getConfig();$("html").removeClass("sz-login-google-loading");a.features["systems.google.auth"]&&g.addDOMEnhancement(h);a.features["systems.google.share"]&&g.addSharingSystem(i)}function d(b){g.getInstance();var c={initiatedByUser:!0};b.code&&a(b.access_token,c)}var g,j=null,h=function(a){$(".sz-login-google",a).each(function(){var a=g.getInstance().getConfig(),b={callback:"GOOGLE_PLUS_SIGN_IN",
clientid:a.google_plus.app_id,cookiepolicy:"single_host_origin",requestvisibleactions:"http://schemas.google.com/ListenActivity",scope:"https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/userinfo.email"};if(a.google_plus.app_package_name)b.apppackagename=a.google_plus.app_package_name;gapi.signin.render(this,b)}).click(function(){j=$(this).attr("data-sz-next")||""})},i=b.View.extend({css:"sz-sharing-google",initialize:function(a){var b=this;i.__super__.initialize.call(this,
a);this.shareItem=a.shareItem;$(this.el).click(function(){b._share()})},render:function(){$(this.el).text("Share on Google");this.sync();return this},_share:function(){var a=this.shareItem,b=(window.screen.width-600)/2,c=(window.screen.height-600)/2,d="https://plus.google.com/share?"+e.formQuery({url:a.get("url")});window.open(d,"google_sharer",["toolbar=no,status=no,scrollbars=yes,resizable=yes,width=600,height=600","left="+b,"top="+c].join(","));this.trigger("share-completed",{shareItem:a})}});
return{register:function(a){if(a.getInstance().getConfig().google_plus.app_id)g=a,window.GOOGLE_PLUS_INIT=c,window.GOOGLE_PLUS_SIGN_IN=d,a=document.createElement("script"),a.async=!0,a.src="https://apis.google.com/js/client:plus.js?onload=GOOGLE_PLUS_INIT",document.getElementsByTagName("head")[0].appendChild(a),$("html").addClass("sz-login-google-loading")}}});define("songza/systems/olark",["songza/config"],function(f){function e(a){a.isAnonymous()?(olark("api.visitor.updateEmailAddress",{emailAddress:""}),olark("api.visitor.updateFullName",{fullName:""})):(olark("api.visitor.updateEmailAddress",{emailAddress:a.get("email")}),olark("api.visitor.updateFullName",{fullName:a.get("display_name")}))}var b;if(!f.olark.site_id)return{register:function(){}};window.olark||function(a){var b=window,d=document,e=b.location.protocol=="https:"?"https:":"http:",f=a.name,
h="load",i=function(){function l(){k.P(h);b[f](h)}b[f]=function(){(k.s=k.s||[]).push(arguments)};for(var k=b[f]._={},n=a.methods.length;n--;)(function(a){b[f][a]=function(){b[f]("call",a,arguments)}})(a.methods[n]);k.l=a.loader;k.i=i;k.p={0:+new Date};k.P=function(a){k.p[a]=new Date-k.p[0]};b.addEventListener?b.addEventListener(h,l,!1):b.attachEvent("on"+h,l);var m=function(){function b(a){a="head";return["<",a,"></",a,"><",c,' onload="var d=',v,";d.getElementsByTagName('head')[0].",i,"(d.",l,"('script')).",
n,"='",e,"//",k.l,"'\"></",c,">"].join("")}var c="body",h=d[c];if(!h)return setTimeout(m,100);k.P(1);var i="appendChild",l="createElement",n="src",x=d[l]("div"),w=x[i](d[l](f)),u=d[l]("iframe"),v="document",z;x.style.display="none";h.insertBefore(x,h.firstChild).id=f;u.frameBorder="0";u.id=f+"-loader";if(/MSIE[ ]+6/.test(navigator.userAgent))u.src="javascript:false";u.allowTransparency="true";w[i](u);try{u.contentWindow[v].open()}catch(D){a.domain=d.domain,z="javascript:var d="+v+".open();d.domain='"+
d.domain+"';",u[n]=z+"void(0);"}try{var A=u.contentWindow[v];A.write(b());A.close()}catch(E){u[n]=z+'d.write("'+b().replace(/"/g,String.fromCharCode(92)+'"')+'");d.close();'}k.P(2)};m()};i()}({loader:"static.olark.com/jsclient/loader0.js",name:"olark",methods:["configure","extend","declare","identify"]});return{register:function(a){olark.identify(f.olark.site_id);b=a.getInstance();b.bind("visitor-change",function(a){e(a.newVisitor)});e(b.getVisitor())}}});define("songza/systems/google-analytics",function(){function f(){var b=a.getVisitor(),e="songza";b.isAnonymous()||(b.get("black_planet_id")?e="black_planet":b.get("facebook_id")&&(e="facebook"),c._setCustomVar(d,"Member",e,g))}function e(a){return a.get("type")==="stream"?"Stream Station":a.get("type")==="basic"?"Basic Station":a.get("type")==="artist"?"Artist Station":"Unknown Station"}function b(){window._gat&&a&&h()}var a,c,d=1,g=1,j,h=_.once(function(){c=_gat._createTracker(a.getConfig().google_analytics.account_id);
c._setDomainName(".songza.com");f();c._trackPageview();a.bind("visitor-signup",function(){c._trackEvent("Visitor","Visitor Sign Up")});a.bind("page-navigate router-navigate",function(a){c._trackPageview(a.path)});a.bind("social-action",function(a){c._trackSocial(a.source,a.type,a.url)});a.bind("visitor-change",f);a.bind("player-song-completed",function(a){var b=a.songState?parseInt(a.songState.position/1E3):0,d=e(a.station);c._trackEvent(d,"Station Song Played",a.station.get("name"),b);c._trackEvent("Artist",
"Artist Song Played",a.song.get("artist"),b);j&&(c._trackEvent(d,"Station Discovery - "+j.contextName,j.stationName),j=null)});a.bind("player-song-skipped",function(a){var b=a.songState&&a.songState.position?parseInt(a.songState.position/1E3):0,d=e(a.station);c._trackEvent(d,"Station Song Skipped",a.station.get("name"),b);c._trackEvent("Artist","Artist Song Skipped",a.song.get("artist"),b)})});return{register:function(c){var d=("https:"==document.location.protocol?"https://":"http://")+"stats.g.doubleclick.net/dc.js";
c.getInstance().getConfig().google_analytics.account_id&&(a=c.getInstance(),require([d],b))}}});define("songza/systems/desk",["songza/config"],function(f){var e;if(!f.desk.domain)return{register:function(){}};return{register:function(b){b.getInstance();e=$("<div>").attr("id","desk-email").addClass("sz-desk-email");b=document.createElement("a");b.href="http://"+f.desk.domain;b.target="_blank";b.className="szi-feedbackButton szi-feedbackButton-linkOnly";b.onmouseover="this.style.backgroundPosition='0 -20px'";b.onmouseout="this.style.backgroundPosition='0 0px'";e.append(b);$("body").append(e)}}});define("songza/systems/comscore",["songza/utils"],function(f){function e(){var b=a.getConfig();window.COMSCORE.beacon({c1:2,c2:b.comscore.client_id,c3:f.currentUrl({no_protocol:!0})})}function b(){window.COMSCORE&&a&&c()}var a,c=_.once(function(){a.bind("page-navigate",e);e()});return{register:function(c){if(c.getInstance().getConfig().comscore.client_id){a=c.getInstance();var c=("https:"==document.location.protocol?"https://sb":"http://b")+".scorecardresearch.com/beacon.js",e=document.createElement("script");
e.setAttribute("language","javascript");e.setAttribute("type","text/javascript");e.setAttribute("src",c);document.body.appendChild(e);$(e).load(b)}}}});define("songza/systems/facebook",["songza/models","songza/utils","songza/base"],function(f,e,b){function a(a,b){var c=i.getInstance();f.User.loginWithFacebook(a.accessToken,{success:function(a){a.isNew&&c.trigger("visitor-signup",{visitor:a.user});c.setVisitor(a.user);c.refresh();b.success&&b.success()},error:function(){c.trigger("visitor-account-creation-error",{provider:"facebook",initiatedByUser:b.initiatedByUser,message:"Sorry, but we were unable to automatically link your account"});b.error&&
b.error()}})}function c(b){var c=i.getInstance().getConfig().facebook.permissions,d={initiatedByUser:!0,success:b.success,error:b.error};FB.getLoginStatus(function(b){b.authResponse?a(b.authResponse,d):FB.login(function(b){b.authResponse&&a(b.authResponse,d)},{scope:c})})}function d(){i.getInstance().getVisitor().get("facebook_id")&&FB.getLoginStatus(function(){})}function g(){window.FB&&i&&n()}function j(){var a,b,c,d,e;if(a=i.getInstance())if(a=a.getPlayer())d=i.getInstance().getVisitor(),d.get("facebook_id")&&
a.model.get("current")&&a.model.get("current").get("streamSong")&&(c=a.model.get("current").get("streamSong").get("song"),b=a.model.get("station"),a.isPlaying()?e={playing:!0,song:l+c.canonicalUrlPath(),radio_station:l+b.pageUrlPath(),user_id:d.get("facebook_id")}:a.isPaused()?e={playing:!1,song:l+c.canonicalUrlPath(),radio_station:l+b.pageUrlPath(),user_id:d.get("facebook_id")}:a.getState("state_error")&&(e={error_code:4,playing:!1,user_id:d.get("facebook_id")}),e&&FB.Music.send("STATUS",e))}function h(a){var b=
e.pageId(),c=e.commentUrl()||e.firstMeta("og:url")||e.currentUrl(),c=$("<div>").text(c).html().replace('"',"&quot;"),d='<fb:comments numposts="5" publish_feed="true"';d+=b?' migrated="1" xid="'+b+'"':' href="'+c+'"';d+="/>";a.html(d);window.FB&&FB.XFBML.parse(a.get(0))}var i,l="http://songza.com",k=typeof Modernizr!=="undefined"&&Modernizr.is_safari,n=_.once(function(){var a=i.getInstance(),b=a.getConfig();FB.init({appId:b.facebook.app_id,status:!0,cookie:!0,xfbml:!0,oauth:!0,music:b.features["systems.facebook.scrobbing"]&&
!k});m.share();m.login();m.scrobbing();setInterval(d,18E5);FB.Event.subscribe("edge.create",function(b){a.trigger("social-action",{source:"facebook",type:"like",url:b})});FB.Event.subscribe("edge.remove",function(b){a.trigger("social-action",{source:"facebook",type:"unlike",url:b})});FB.Event.subscribe("comment.create",function(b){a.trigger("social-action",{source:"facebook",type:"comment-add",url:b.href})});FB.Event.subscribe("comment.remove",function(b){a.trigger("social-action",{source:"facebook",
type:"comment-remove",url:b.href})})}),m={share:function(){var a=i.getInstance().getConfig();$("body");a.features["systems.facebook.share"]&&i.addSharingSystem(p)},login:function(){var b=i.getInstance(),d=b.getConfig(),e=$("body");d.features["systems.facebook.auth"]&&(FB.getLoginStatus(function(b){function c(){if(Backbone.History&&Backbone.History.started){if(Backbone.history.getFragment().search("login")>=0){var a=parseUri(Backbone.history.location.href).queryKey.next,a=a?decodeURIComponent(a):"/";
Backbone.history.navigate(a,!0)}}else d.refresh()}var d=i.getInstance(),e=d.getVisitor();(b=b.authResponse)&&e.isAnonymous()&&a(b,{initiatedByUser:!1,success:c})}),e.delegate(".sz-login-facebook","click",function(a){a.preventDefault();c({success:function(){var c=$(a.target).attr("data-sz-next")||"";c?Backbone.History&&Backbone.History.started?(c[0]==="/"&&(c=c.substring(1)),Backbone.history.navigate(c,!0)):window.location.href=c:b.refresh()}})}),b.bind("visitor-change",function(a){a.oldVisitor.get("facebook_id")&&
a.newVisitor.isAnonymous()&&FB.logout()}))},scrobbing:function(){var a=i.getInstance();a.getConfig().features["systems.facebook.scrobbing"]&&!k&&(a.bind("app-unload",function(){var b=a.getVisitor();b.get("facebook_id")&&FB.Music.send("STATUS",{offline:!0,user_id:b.get("facebook_id")})}),a.bind("visitor-change",function(a){a.newVisitor.get("facebook_id")&&j()}),FB.Event.subscribe("fb.music.PLAY",function(b){f.Station.getByUrl(b.radio_station,{success:function(b){a.startStation(b,{force:!0});j()}})}),
FB.Event.subscribe("fb.music.RESUME",function(){var b=a.getPlayer();b&&b.play()}),FB.Event.subscribe("fb.music.PAUSE",function(){var b=a.getPlayer();b&&b.pause()}),FB.Event.subscribe("fb.music.STATUS",j),FB.Event.subscribe("fb.music.WINDOW_OPEN",j),FB.Event.subscribe("fb.music.USER_MISMATCH",j),FB.Event.subscribe("fb.music.ALREADY_CONNECTED",j),FB.Event.subscribe("fb.music.BRIDGE_READY",j),a.bind("player-error",j),a.bind("player-song-started",j),a.bind("player-song-play",j),a.bind("player-song-pause",
j),j())}},p=b.View.extend({css:"sz-sharing-facebook",initialize:function(a){var b=this;p.__super__.initialize.call(this,a);this.shareItem=a.shareItem;$(this.el).click(function(){b._share()})},render:function(){$(this.el).text("Share on Facebook");this.sync();return this},_share:function(){var a=this.shareItem,b=(window.screen.width-850)/2,c=(window.screen.height-500)/2,d="http://www.facebook.com/sharer.php?"+e.formQuery({u:a.get("url"),t:a.get("title")});window.open(d,"facebook_sharer",["toolbar=no,status=no,scrollbars=yes,resizable=yes,width=850,height=500",
"left="+b,"top="+c].join(","));this.trigger("share-completed",{shareItem:a})}});return{register:function(a){var b=a.getInstance().getConfig();if(b.facebook.app_id)b.features["systems.facebook.comment"]&&a.addCommentProvider("facebook",h),i=a,$("body").append($("<div>").attr("id","fb-root")),window.fbAsyncInit=g,a=document.createElement("script"),a.async=!0,a.src=document.location.protocol+"//connect.facebook.net/en_US/all/vb.js",document.getElementsByTagName("head")[0].appendChild(a)}}});define("songza/systems/disqus",["songza/config","songza/utils"],function(f,e){function b(b){b.append($("<div>").attr("id","disqus_thread"));window.DISQUS?a():require(["http://"+f.disqus.shortname+".disqus.com/embed.js"],a)}function a(){if(window.DISQUS&&$("#disqus_thread").size()>0)try{window.DISQUS.reset({reload:!0,config:function(){this.page.url=e.commentUrl()||e.currentUrl()}})}catch(a){}}if(f.disqus.shortname)window.disqus_shortname=f.disqus.shortname;else return{register:function(){}};if(f.debug)window.disqus_developer=
1;return{register:function(a){a.addCommentProvider("disqus",b)}}});define("songza/systems/twitter",["songza/utils","songza/base"],function(f,e){function b(){window.twttr&&a&&c()}var a,c=_.once(function(){var b=a.getInstance();twttr.events.bind("tweet",function(a){var c=$(a.target).data("sz-share-item");b.trigger("social-action",{source:"twitter",type:a.type,url:c?c.get("url"):window.location.href})})}),d=e.View.extend({css:"sz-sharing-twitter",initialize:function(a){d.__super__.initialize.call(this,a);this.shareItem=a.shareItem},render:function(){var b=this,c=this.shareItem,
d={via:a.getInstance().getConfig().twitter.handle||"",url:c.get("url"),text:c.get("share_text")||c.get("title")},d=$("<a>").text("Share on Twitter").attr("href","https://twitter.com/intent/tweet?"+f.formQuery(d)).attr("title","Share on Twitter").attr("data-sz-no-route","");d.data("sz-share-item",c);d.click(function(){b.trigger("share-completed",{shareItem:c})});$(this.el).empty().append(d);this.sync();return this}});return{register:function(c){if(c.getInstance().getConfig().twitter.handle)c.addSharingSystem(d),
a=c,c=document.createElement("script"),c.async=!0,c.src=document.location.protocol+"//platform.twitter.com/widgets.js",document.getElementsByTagName("head")[0].appendChild(c),$(c).load(b)}}});define("songza/systems/quantcast",["songza/config"],function(f){function e(){var a=_.map(f.quantcast.accounts,function(a){return{qacct:a}});window._qevents.push(a)}function b(){window.__qc&&a&&c()}var a;if(f.quantcast.accounts.length==0)return{register:function(){}};var c=_.once(function(){a.bind("page-navigate",e);e()});return{register:function(c){a=c.getInstance();var c=("https:"==document.location.protocol?"https://secure":"http://edge")+".quantserve.com/quant.js",e=document.createElement("script");
e.setAttribute("language","javascript");e.setAttribute("type","text/javascript");e.setAttribute("src",c);document.body.appendChild(e);$(e).load(b)}}});define("songza/feeds",["songza/config","songza/base","songza/models","songza/utils"],function(f,e,b,a){var c={},d=Backbone.Collection.extend({model:b.FeedItem,comparator:function(a){return a.get("ts")}}),g=c.Viewer=e.View.extend({template:sz.tmpl.feeds.feedList,css:"sz-feed-viewer",initialize:function(a){g.__super__.initialize.call(this,a);_.bindAll(this,"fetchSuccess","fetchError","maybeFetch");this.itemFetcher=a.itemFetcher;this.pollIntervals=a.pollIntervals||f.timeouts.feedPollIntervals;this.maxItems=
a.maxItems||100;this.clientFetchAttemptDate=this.serverFetchDate=null;this.clientFetchHadDataDate=new Date;this.userLastReadTime=null;this.fetchState=0;this.items=new d;this.items.bind("add",this.render);this.items.bind("remove",this.render);this.items.bind("reset",this.render);this.bind("marked-all-read",this.render)},isNew:function(a){return this.userLastReadTime===null||a.get("ts")>this.userLastReadTime},unreadCount:function(){var a=this,b=0;this.items.each(function(c){a.isNew(c)&&(b+=1)});return b},
markAllRead:function(){this.userLastReadTime=this.serverFetchDate;this.trigger("marked-all-read")},maybeFetch:function(a){if(this.fetchState!==1&&(this.fetchState!==2||a))this.fetchState=1,a=this.itemFetcher(this.serverFetchDate),$.when(a).then(this.fetchSuccess,this.fetchError)},itemKey:function(a){var b,c=a.get("actors"),d=[],e=[a.get("event_type"),a.get("station").get("id")];for(b=0;b<c.length;b++)d.push(c[b].get("id"));d.sort();a.get("song")&&e.push(a.get("song").get("id"));return e.join("/")+
":"+d.join(",")},fetchSuccess:function(a){var b=this,c={};this.fetchState=2;this.clientFetchAttemptDate=new Date;this.serverFetchDate=a.server_time;if(a.items.length>0)this.clientFetchHadDataDate=this.clientFetchAttemptDate;this.items.each(function(a){c[b.itemKey(a)]=!0});a.items.each(function(a){c.hasOwnProperty(b.itemKey(a))||b.items.add(a,{suppress:!0})});this.items.length>this.maxItems&&this.items.reset(this.items.first(this.maxItems),{suppress:!0});this.queueFetch();this.items.trigger("reset")},
fetchError:function(){this.fetchState=0;this.clientFetchAttemptDate=new Date;this.queueFetch()},queueFetch:function(){var a=this,b=(this.clientFetchAttemptDate.getTime()-this.clientFetchHadDataDate.getTime())/1E3,c=0,d,e,f,g;for(g=0;g<this.pollIntervals.length;g++){e=this.pollIntervals[g][0];f=this.pollIntervals[g][1]||1;if(b>=c&&b<=c+e*f){d=e;break}c+=e*f}d===void 0&&(d=_.last(this.pollIntervals)[0]);setTimeout(function(){a.maybeFetch(!0)},d*1E3)},context:function(){var b=this,c;this.maybeFetch();
c={fetching:this.fetchState===1,items:[]};this.items.each(function(d){var e=d.toJSON();e.is_new=b.isNew(d);e.ts_text=a.DateHelper.time_ago_in_words(d.get("ts"));e.station_url=d.get("station").pageUrlPath();c.items.push(e)});c.items.reverse();return c}});return c});define("songza/hashsignal",function(){function f(){if(c&&c.debug){var a=[new Date,"hashsignal"].concat(Array.prototype.slice.apply(arguments));window.console?window.console.log(a):alert(a.join(" "))}}function e(b){function c(a,b){b(a);for(var d=0,e=a.childNodes.length;d<e;d++)c(a.childNodes[d],b)}var e=/^ (end)?block ([^ ]*) ([0-9a-f]{32} )?$/,f={},b=b||a;(function(a,b){c(a,function(a){if(a.nodeType===8){var c=e.exec(a.nodeValue);c&&b(c[2],c[3],!c[1],a)}})})(b,function(a,b,c,d){f[a]===void 0&&(f[a]=
{nodes:[null,null],signature:b});f[a].nodes[c?0:1]=d});return f}function b(a,b){var e=/<link.+?(rel=["']?stylesheet["'\s])?.*?href=["']?(.+?)["'\s].*?(rel=["']?stylesheet["'\s])?.*?>/gi,h=[],i,l={},k=[];a.replace(/<\!-- (end)?block ([^ ]*) ([0123456789abcdef]{32} )?--\>/gi,function(a,b,d,g,q,r){if(b&&h.length===0)throw"Unexpected block nesting on match: "+a;!b&&!g&&f("WARNING: block found without signature",d);b?(i=h[h.length-1],d=i.name,h.length-=1,l[d]={html:r.slice(i.start,q),signature:i.signature},
c.inlineStylesheets&&l[d].html.replace(e,function(a,b,c,e){!isCrossDomain(c)&&(b&&b.toLowerCase().indexOf("stylesheet")!==-1||e&&e.toLowerCase().indexOf("stylesheet")!==-1)&&k.push($.ajax({dataType:"text",url:c}).done(function(b){l[d].html=l[d].html.replace(a,'<style type="text/css">'+b+"</style>")}))})):h.push({name:d,start:q+a.length,signature:g})});if(0!==h.length)throw"Unclosed block: "+h[h.length-1].name;k.length>0?$.when.apply($,k).then(function(){b(l)},function(){b(l)}):b(l)}var a=window.document,
c;c={excludeSelector:".no-ajax",beforeUpdate:function(){f("beforeUpdate")},afterUpdate:function(){f("afterUpdate")},errorUpdate:function(){f("errorUpdate")},onDocumentWrite:function(a){window.console&&window.console.error("jQuery.hashsignal received document.write: "+a)},debug:!1,disabled:!1,resolverId:"hashsignal-abs",inlineStylesheets:!1,replaceBlocksOnError:!1};return{replaceBlocks:function(c,g,j){function h(a,b){for(var c=[],d=a;d!==b;)d!==a&&c.push(d),d=d.nextSibling;return c}var i=[];f("replaceBlocks");
var j=j||$.noop,l=e();b(c,function(b){var e=/<title>(.*)<\/title>/.exec(c);if(e)a.title=$("<div>").html(e[1]).text();$("body");/<body([^>]*)>/.exec(c);for(var m in b)if(m in l){var e=l[m],p=b[m];if(e.signature&&p.signature&&e.signature===p.signature&&!g)f("Not replacing block, signatures match.",m,e.signature);else{$(h(e.nodes[0],e.nodes[1])).remove();f("Replacing block",m,p.html,p);if($.trim(p.html)){var o=$(p.html);i.push(o);$(e.nodes[0]).after(o)}$(e.nodes[0]).replaceWith("<\!-- block "+m+" "+
(p.signature||"")+"--\>")}}else f("WARNING: unmatched block",m);j(i)})}}});define("songza/work",["songza/base"],function(f){var e={};e.Set=f.Class.extend({initialize:function(a){e.Set.__super__.initialize.call(this,a);this._tasks={};this._dfd=$.Deferred();this.backbone=new b({host:this});this._dfd.promise(this)},_scanTasks:function(){var a,b={};for(a in this._tasks){var d=this._tasks[a].done;b[a]=this._tasks[a].value;if(d===void 0)return;else d||this._dfd.reject()}this._dfd.resolve(b)},_taskDone:function(a,b){this._tasks[a].done=!0;this._tasks[a].value=b;this._scanTasks()},
_taskFailed:function(a){this._tasks[a].done=!1;this._scanTasks()},add:function(a,b){var d=this;this._tasks[a]={promise:b,done:void 0,value:void 0};$.when(b).done(function(b){d._taskDone(a,b)}).fail(function(){d._taskFailed(a)});return this},get:function(a){if(!this._tasks.hasOwnProperty(a))throw Error("Unknown task: "+a);return this._tasks[a].promise},after:function(a,b,d){$.when(this.get(a)).done(function(){b.apply(this,Array.prototype.slice.apply(arguments).concat(d||[]))});return this}});var b=
f.Plugin.extend({namespace:"backbone",proxy:function(a,b,d){var e=$.Deferred(),b=e.promise().done(b,d);this.host.add(a,b);return{success:function(a){e.resolve(a)},error:function(){e.reject()}}}});return e});
